<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>La DÃ©esse de la Fortune â€” Slot</title>
<style>
  :root { --bg:#0f0f13; --fg:#eaeaf0; --muted:#9aa0a6; --accent:#ffd54a; --bad:#ff6b6b; --good:#4ade80; }
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:radial-gradient(1200px 700px at 50% -20%,#1b1b22 10%,#0b0b0f 70%,#000 100%);color:var(--fg);display:flex;min-height:100dvh}
  .wrap{margin:auto;max-width:680px;width:100%;padding:24px}
  .card{background:#121218;border:1px solid #1f2030;border-radius:18px;box-shadow:0 10px 30px #0007;padding:24px}
  h1{margin:0 0 8px;font-size:24px;letter-spacing:.5px}
  .sub{color:var(--muted);font-size:14px;margin-bottom:16px}
  .panel{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:12px 0 18px}
  .stat{background:#0f1017;border:1px solid #202235;border-radius:14px;padding:10px 14px;min-width:140px}
  .stat b{display:block;font-size:18px}
  .slot{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin:10px 0 14px}
  .reel{background:#0c0d14;border:1px solid #1f2133;border-radius:16px;height:120px;display:flex;align-items:center;justify-content:center;
        font-weight:700;font-size:42px;user-select:none;box-shadow:inset 0 -6px 20px #0007}
  .reel.spin{animation:spin 140ms linear infinite}
  @keyframes spin{0%{filter:brightness(1)}50%{filter:brightness(1.3)}100%{filter:brightness(1)}}
  .controls{display:flex;gap:12px;flex-wrap:wrap}
  button{cursor:pointer;appearance:none;border:1px solid #2a2d46;background:#171827;color:var(--fg);padding:12px 18px;border-radius:14px;
         font-weight:700;letter-spacing:.3px;transition:transform .05s ease;box-shadow:0 6px 16px #0006}
  button:hover{transform:translateY(-1px)}
  button:active{transform:translateY(1px)}
  button.primary{background:linear-gradient(180deg,#282a45,#1b1d32);border-color:#343754}
  button.primary:disabled{opacity:.5;cursor:not-allowed}
  .log{margin-top:14px;font-family:ui-monospace,Consolas,monospace;font-size:14px;color:var(--muted);white-space:pre-wrap;max-height:180px;overflow:auto;border-top:1px dashed #2a2d46;padding-top:10px}
  .hint{font-size:13px;color:var(--muted);margin-top:6px}
  .good{color:var(--good)} .bad{color:var(--bad)} .acc{color:var(--accent)}
  .reel.win{
    animation: win-flash 0.5s 3; /* Play 3 times */
  }

  @keyframes win-flash {
    0%, 100% { box-shadow: inset 0 -6px 20px #0007, 0 0 20px var(--accent); }
    50% { box-shadow: inset 0 -6px 20px #0007; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ² La DÃ©esse de la Fortune</h1>
      <div class="sub">â€œPaie un cristal. Gagneâ€¦ ou sois vidÃ©.â€ â€” Vestige de la ruine</div>

      <div class="panel">
        <div class="stat"><span>Cristaux</span><b id="crystals">10</b></div>
        <div class="stat"><span>Score</span><b id="score">0</b></div>
        <div class="stat"><span>Dernier tour</span><b id="delta" class="acc">â€”</b></div>
      </div>

      <div class="slot" aria-live="polite">
        <div class="reel" id="r0">+</div>
        <div class="reel" id="r1">Ã—</div>
        <div class="reel" id="r2">0</div>
      </div>

      <div class="controls">
        <button id="spinBtn" class="primary">Lancer (1 ğŸ’)</button>
        <button id="resetBtn">Reset</button>
      </div>
      <div class="hint">Espace: Lancer/ArrÃªter. Gain = (+1/-1/0) Ã— 2^(x2/ğŸƒ). ğŸ’ = Tour Gratuit. ğŸ‘‘ğŸ‘‘ğŸ‘‘ = Jackpot!</div>

      <div class="log" id="log"></div>
    </div>
  </div>

<script>
(function(){
  const reels = [document.getElementById('r0'), document.getElementById('r1'), document.getElementById('r2')];
  const crystalsEl = document.getElementById('crystals');
  const scoreEl = document.getElementById('score');
  const deltaEl = document.getElementById('delta');
  const logEl = document.getElementById('log');
  const spinBtn = document.getElementById('spinBtn');
  const resetBtn = document.getElementById('resetBtn');

  const SYMBOLS = ["+1", "+1", "+1", "-1", "-1", "0", "0", "x2", "x2", "ğŸ’", "ğŸƒ", "ğŸ‘‘"];
  let crystals = 10;
  let score = 0;
  let freeSpin = false;
  let spinCount = 0;
  
  let state = 'idle'; // idle | spinning | stopping
  let timers = [];
  let outputs = [];
  let reelToStop = 0;

  function rndSym(){ return SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)]; }

  function setUI(){
    crystalsEl.textContent = crystals;
    scoreEl.textContent = score;
    spinBtn.disabled = (state !== 'idle' && state !== 'spinning') || (crystals <= 0 && !freeSpin);
    
    if (state === 'spinning') {
        spinBtn.textContent = `ArrÃªter`;
    } else if (freeSpin) {
        spinBtn.textContent = `Lancer (Gratuit ğŸ’)`;
    } else {
        spinBtn.textContent = `Lancer (1 ğŸ’)`;
    }
  }

  function prettyDelta(v){
    if (v>0) { deltaEl.className="good"; return "+"+v; }
    if (v<0) { deltaEl.className="bad"; return ""+v; }
    deltaEl.className="acc"; return "0";
  }

  function appendLog(text, isSpinResult = false){
    const now = new Date().toLocaleTimeString();
    let prefix = `[${now}]`;
    if (isSpinResult) {
        prefix = `[${now} | Tour #${spinCount}]`;
    }
    logEl.textContent = `${prefix} ${text}\n` + logEl.textContent;
  }

  function evalSpin(out){
    // Jackpot
    if (out.every(s => s === 'ğŸ‘‘')) {
        return { base: 0, mult: 0, delta: 100, jackpot: true };
    }

    let base = 0, mult = 0, bonusSpins = 0;
    for (const s of out){
      if (s === "+1") base += 1;
      else if (s === "-1") base -= 1;
      else if (s === "x2") mult += 1;
      else if (s === "ğŸƒ") mult += 1; // Wild counts as x2
      else if (s === "ğŸ’") bonusSpins += 1;
    }
    
    if (bonusSpins > 0) {
        freeSpin = true;
        appendLog(`ğŸ’ Tour gratuit gagnÃ©!`);
    }

    let delta = base * Math.pow(2, mult);
    return { base, mult, delta };
  }

  function startSpin() {
    if (state !== 'idle' || (crystals <= 0 && !freeSpin)) return;

    state = 'spinning';
    if (!freeSpin) {
        crystals -= 1; 
    }
    freeSpin = false;
    spinCount++;

    outputs = [];
    reelToStop = 0;
    setUI();

    const speedMultiplier = 1 - (Math.min(score, 500) / 1000); // Max 50% speed increase
    const baseSpeed = 70;

    reels.forEach((reel, i) => {
      reel.classList.add('spin');
      const speed = (baseSpeed - i*5) * speedMultiplier;
      timers[i] = setInterval(()=>{ reel.textContent = rndSym(); }, speed);
    });
  }

  function stopReel() {
      if (state !== 'spinning' || reelToStop >= reels.length) return;

      const i = reelToStop;
      clearInterval(timers[i]);
      const final = rndSym();
      outputs[i] = final;
      reels[i].textContent = final;
      reels[i].classList.remove('spin');
      
      reelToStop++;

      if (reelToStop >= reels.length) {
          finish();
      }
  }

  function finish(){
      const {base, mult, delta, jackpot} = evalSpin(outputs);
      if (jackpot) {
          score += 100;
          deltaEl.textContent = "ğŸ‘‘JACKPOT! ğŸ‘‘";
          deltaEl.className = "acc";
          appendLog(`ğŸ‘‘JACKPOT! +100 | cristaux=${crystals}, score=${score}`, true);
          reels.forEach(r => r.classList.add('win'));
      } else {
          score += delta;
          deltaEl.textContent = prettyDelta(delta);
          appendLog(`Rouleaux: [ ${outputs.join(" | ")} ]  â†’ base=${base}  x2=${mult}  Î”=${delta >=0 ? "+"+delta : delta}  | cristaux=${crystals}, score=${score}`, true);
          if (delta > 0) {
              outputs.forEach((s, i) => {
                  if (s === '+1' || s === 'x2' || s === 'ğŸƒ') {
                      reels[i].classList.add('win');
                  }
              });
          }
      }
      
      setTimeout(() => {
          reels.forEach(r => r.classList.remove('win'));
      }, 1500); // Remove class after animation (0.5s * 3)

      state = 'idle';
      setUI();
      if (crystals <= 0 && !freeSpin) {
        appendLog("ğŸ’€ Plus de cristaux. Reset pour rejouer.");
      }
  }
  
  function handleAction() {
      switch (state) {
          case 'idle':
              startSpin();
              break;
          case 'spinning':
              stopReel();
              break;
      }
  }

  spinBtn.addEventListener('click', handleAction);
  resetBtn.addEventListener('click', ()=>{
    crystals = 10; score = 0; deltaEl.textContent="â€”"; deltaEl.className="acc"; 
    freeSpin = false;
    spinCount = 0;
    state = 'idle';
    setUI();
    appendLog("â†º Reset â€” 10 cristaux, score 0.");
  });
  window.addEventListener('keydown', (e)=>{
    if (e.code === 'Space') { 
        e.preventDefault(); 
        handleAction();
    }
  });

  // init
  setUI();
  appendLog("La DÃ©esse de la Fortune tâ€™observeâ€¦");
})();


</script>
</body>
</html>
