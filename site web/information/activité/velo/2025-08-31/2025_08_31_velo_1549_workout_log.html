<!DOCTYPE html>
<html lang="fr">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   Workout Log - Analyseur d'Activité
  </title>
<style>/* Styles généraux */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

/* Définition des variables de couleur pour le thème clair */
:root {
  --bg-gradient-start: #667eea;
  --bg-gradient-end: #764ba2;
  --text-color: #333;
  --container-bg: rgba(255, 255, 255, 0.95);
  --container-shadow: rgba(0,0,0,0.1);
  --header-gradient-start: #4CAF50;
  --header-gradient-end: #8BC34A;
  --header-text-color: #fff;
  --section-title-color: #4CAF50;
  --stat-card-bg: #f8f8f8;
  --stat-card-shadow: rgba(0,0,0,0.05);
  --stat-value-color: #3f51b5;
  --stat-label-color: #777;
  --chart-container-bg: #f8f8f8;
  --hr-summary-card-bg: #f0f4f8;
  --zone-bar-bg: #e0e0e0;
  --footer-border-color: #eee;
  --footer-text-color: #888;
}


body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
  min-height: 100vh;
  color: var(--text-color);
  padding: 20px;
}

.container {
  max-width: 800px;
  margin: 0 auto;
  background: var(--container-bg);
  border-radius: 20px;
  backdrop-filter: blur(10px);
  box-shadow: 0 20px 40px var(--container-shadow);
  overflow: hidden;
}

/* Header de l'application */
.header {
  background: linear-gradient(45deg, var(--header-gradient-start), var(--header-gradient-end));
  color: var(--header-text-color);
  padding: 30px 20px;
  text-align: center;
  border-bottom: 5px solid rgba(0,0,0,0.1);
  position: relative;
  display: flex; /* Utiliser flexbox */
  flex-direction: column; /* Pour empiler les éléments verticalement */
  justify-content: center; /* Centrer verticalement */
  align-items: center; /* Centrer horizontalement */
  text-align: center; /* Assurer le centrage du texte */
}

/* Section d'informations d'activité (HEADER) */
.activity-info {
    margin-top: 10px;
    color: #fff; /* Pour assurer la lisibilité sur le fond du header */
}
.activity-info #display-activity-type {
    font-size: 1.5em; /* Pour le type d'activité */
    font-weight: bold;
    margin-bottom: 5px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}
.activity-info #display-activity-title {
    font-size: 2.2em; /* Pour le titre principal de l'activité */
    font-weight: bold;
    margin-bottom: 5px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}
.activity-info #display-activity-date {
    font-size: 1.1em; /* Pour la date et heure */
    opacity: 0.9;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

/* Styles pour le mode sombre */
body.dark-mode {  
  --bg-gradient-start: #1a2a6c;
  --bg-gradient-end: #000428;
  --text-color: #e0e0e0;
  --container-bg: rgba(40, 50, 60, 0.95);
  --container-shadow: rgba(0,0,0,0.3);
  --header-gradient-start: #1e3c72;
  --header-gradient-end: #2a5298;
  --header-text-color: #e0e0e0;
  --section-title-color: #8BC34A;
  --stat-card-bg: #34495e;
  --stat-card-shadow: rgba(0,0,0,0.2);
  --stat-value-color: #a7d9ff;
  --stat-label-color: #bbb;
  --chart-container-bg: #34495e;
  --hr-summary-card-bg: #2c3e50;
  --zone-bar-bg: #444;
  --footer-border-color: #444;
  --footer-text-color: #bbb;
}
body.dark-mode .activity-info {
  color: #e0e0e0;
}


/* Corps du contenu */
.content-body {
  padding: 20px 30px;
}

.section-title {
  font-size: 1.8em;
  color: var(--section-title-color);
  margin-bottom: 20px;
  text-align: center;
  position: relative;
  padding-bottom: 10px;
}

.section-title::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 60px;
  height: 3px;
  background-color: var(--section-title-color);
  border-radius: 2px;
}



/* Section Statistiques clés */
.key-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
  margin-bottom: 30px;
  text-align: center;
}

.stat-card {
  background: var(--stat-card-bg);
  padding: 15px;
  border-radius: 12px;
  box-shadow: 0 5px 15px var(--stat-card-shadow);
  transition: transform 0.2s ease;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

.stat-value {
  font-size: 2em;
  font-weight: bold;
  color: var(--stat-value-color);
  margin-bottom: 5px;
}

.stat-label {
  font-size: 0.9em;
  color: var(--stat-label-color);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}


/* Section graphiques / images */
.charts-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.chart-container {
  background: var(--chart-container-bg);
  padding: 15px;
  border-radius: 12px;
  box-shadow: 0 5px 15px var(--stat-card-shadow);
  text-align: center;
  min-height: 200px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: relative;
}

.chart-container img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  cursor: pointer; /* Indique que l'image est cliquable */
  transition: transform 0.2s ease;
}
.chart-container img:hover {
    transform: scale(1.02);
}

.chart-container .image-origin-info {
    font-size: 0.8em;
    color: #999;
    margin-top: 5px;
}


/* Modal pour les images agrandies */
.image-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.image-modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.image-modal-content {
  position: relative;
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  max-width: 720px; /* Max width for the image */
  max-height: 90vh;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}
.dark-mode .image-modal-content {
    background: #34495e;
}

.image-modal-content img {
  max-width: 100%;
  max-height: 100%;
  display: block;
  object-fit: contain; /* Assure que l'image est contenue sans être coupée */
}

.image-modal-close {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 30px;
  color: #aaa;
  cursor: pointer;
  line-height: 1;
  transition: color 0.2s ease;
}

.image-modal-close:hover {
  color: #333;
}
.dark-mode .image-modal-close {
    color: #bbb;
}
.dark-mode .image-modal-close:hover {
    color: #eee;
}

/* Section Fréquence Cardiaque */
.hr-section .hr-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
  text-align: center;
}

.hr-summary .stat-card {
  background: var(--hr-summary-card-bg);
}

.hr-zones {
  margin-top: 20px;
}

.zone-item {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
  gap: 10px;
}

.zone-label {
  flex: 0 0 120px; /* Largeur fixe pour les labels */
  font-weight: bold;
  color: #555;
}

.zone-bar-container {
  flex-grow: 1;
  height: 20px;
  background: var(--zone-bar-bg);
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}

.zone-bar {
  height: 100%;
  border-radius: 10px;
  transition: width 0.5s ease-out;
}

/* Couleurs des barres de zones */
.zone-item.anaerobie .zone-bar { background-color: #e74c3c; } /* Rouge */
.zone-item.aerobie .zone-bar { background-color: #f39c12; } /* Orange */
.zone-item.gras .zone-bar { background-color: #2ecc71; } /* Vert */
.zone-item.enthousiasme .zone-bar { background-color: #3498db; } /* Bleu */

/* Couleurs pour les barres de FC Moy, Max, Limite */
.zone-item.avg-hr .zone-bar { background-color: #9b59b6; } /* Violet */
.zone-item.max-hr .zone-bar { background-color: #e74c3c; } /* Rouge vif */
.zone-item.hr-limit .zone-bar { background-color: #f1c40f; } /* Jaune */


.zone-value {
  flex: 0 0 80px; /* Largeur fixe pour les valeurs */
  text-align: right;
  font-weight: bold;
  color: var(--text-color);
}

/* Section Allure par kilomètre */
.pace-section .pace-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
  text-align: center;
}

.pace-summary .stat-card {
  background: #f0f4f8;
}

.dark-mode .pace-summary .stat-card {
  background: #2c3e50;
}

.pace-zones {
  margin-top: 20px;
}

.pace-item {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
  gap: 10px;
}

.pace-label {
  flex: 0 0 120px;
  font-weight: bold;
  color: #555;
}

.pace-bar-container {
  flex-grow: 1;
  height: 20px;
  background: var(--zone-bar-bg);
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}

.pace-bar {
  height: 100%;
  border-radius: 10px;
  transition: width 0.5s ease-out;
  background-color: #3498db; /* Une couleur bleue pour les barres d'allure */
}

.pace-value {
  flex: 0 0 80px;
  text-align: right;
  font-weight: bold;
  color: #333;
}

/* Couleurs pour le mode sombre dans la section allure */
.dark-mode .pace-label {
  color: #bbb;
}

.dark-mode .pace-value {
  color: #e0e0e0;
}


/* Section Notes & Météo */
.notes-section, .serie-section, .analysis-section {
  margin-bottom: 20px;
}
.analysis-section {
  margin-bottom: 30px;
}

.notes-section textarea, .serie-section textarea {
  width: 100%;
  min-height: 100px;
  padding: 15px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  font-family: inherit;
  font-size: 14px;
  resize: vertical;
  background: #fdfdfd;
  color: #333;
}

/* Styles pour la nouvelle section d'analyse */
.analysis-content {
  width: 100%;
  min-height: 100px;
  padding: 20px 25px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  font-family: inherit;
  font-size: 15px;
  line-height: 1.6;
  background: #fdfdfd;
  color: #333;
}

/* Styles pour le contenu HTML dans la div d'analyse */
.analysis-content h1, .analysis-content h2, .analysis-content h3 { margin-top: 15px; margin-bottom: 10px; color: var(--section-title-color); }
.analysis-content p { margin-bottom: 10px; }
.analysis-content ul, .analysis-content ol { margin-left: 20px; margin-bottom: 15px; }
.analysis-content li { margin-bottom: 5px; }
.analysis-content strong { color: var(--stat-value-color); }


.dark-mode .notes-section textarea,
.dark-mode .serie-section textarea {
  background: #2c3e50;
  color: #e0e0e0;
  border-color: #444;
}

/* Styles pour la nouvelle section d'analyse en mode sombre */
.dark-mode .analysis-content {
  background: #2c3e50;
  color: #e0e0e0;
  border-color: #444;
}

.dark-mode .analysis-content strong {
  color: var(--stat-value-color); /* La variable s'adapte déjà */
}

/* Styles pour les onglets d'analyse */
.analysis-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  border-bottom: 2px solid var(--border-color);
  padding-bottom: 10px;
}
.analysis-tabs .tab-btn {
  padding: 8px 15px;
  cursor: pointer;
  background-color: transparent;
  border: 2px solid transparent;
  color: var(--text-secondary);
  font-weight: bold;
  border-radius: 8px;
  transition: all 0.2s ease;
}
.analysis-tabs .tab-btn.active {
  color: var(--accent);
  border-color: var(--accent);
  background-color: rgba(76, 175, 80, 0.1);
}

.notes-section textarea,
.serie-section textarea,
.analysis-section textarea {
  width: 100%;
  min-height: 100px;
  padding: 15px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  font-family: inherit;
  font-size: 14px;
  resize: vertical; /* Permet de redimensionner verticalement */
  background: #fdfdfd;
  color: #333;
}


.dark-mode .notes-section textarea,
.dark-mode .serie-section textarea,
.dark-mode .analysis-section textarea {
  background: #2c3e50;
  color: #e0e0e0;
  border-color: #444;
}

.weather-info {
  text-align: center;
  font-size: 1.1em;
  color: #666;
  margin-bottom: 20px;
  padding: 10px;
  background: #f0f4f8;
  border-radius: 10px;
}
.dark-mode .weather-info {
  background: #2c3e50;
  color: #e0e0e0;
}

/* Bouton de sauvegarde principal */
.btn-save {
  background: linear-gradient(135deg, #4CAF50, #8BC34A); /* Vert adapté */
  color: white;
  padding: 15px 30px;
  border: none;
  border-radius: 50px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  margin: 20px auto;
  display: block;
  box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3); /* Ombre verte */
}

.btn-save:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
}


/* Footer */
.footer {
  text-align: center;
  padding: 20px;
  font-size: 0.8em;
  color: var(--footer-text-color);
  border-top: 1px solid var(--footer-border-color);
  margin-top: 20px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .container {
    margin: 10px;
    border-radius: 15px;
    padding: 0;
  }
  .header {
    padding: 20px 15px;
  }
  .header h1 {
    font-size: 2em;
  }
  .header .date-time {
    font-size: 1em;
  }
  .content-body {
    padding: 15px;
  }
  .section-title {
    font-size: 1.5em;
  }
  .key-stats {
    grid-template-columns: 1fr 1fr; /* 2 colonnes sur petits écrans */
  }
  .stat-value {
    font-size: 1.8em;
  }
  .charts-section {
    grid-template-columns: 1fr; /* 1 colonne sur petits écrans */
  }
  .zone-item {
    flex-direction: column;
    align-items: flex-start;
  }
  .zone-label, .zone-value {
    flex: none;
    width: 100%;
    text-align: left;
  }
}</style>
 </head>
 <body class="dark-mode">
  <div class="container">
   <div class="header">
    <div class="activity-info">
     <div id="display-activity-type">
     </div>
     <div id="display-activity-title">
     </div>
     <div id="display-activity-date">
     </div>
    </div>
   </div>
   <div class="content-body">
    <h2 class="section-title">
     Statistiques Clés
    </h2>
    <div class="key-stats">
     <div class="stat-card distance">
      <div class="stat-value" id="display-distance">
      </div>
      <div class="stat-label">
       Distance (km)
      </div>
     </div>
     <div class="stat-card runkeeper-duration">
      <div class="stat-value" id="display-runkeeper-duration">
      </div>
      <div class="stat-label">
       Temps de l'effort
      </div>
     </div>
     <div class="stat-card apex-duration">
      <div class="stat-value" id="display-apex-duration">
      </div>
      <div class="stat-label">
       Temps de Sport (Apex)
      </div>
     </div>
     <div class="stat-card speed">
      <div class="stat-value" id="display-speed">
      </div>
      <div class="stat-label">
       Vitesse (km/h)
      </div>
     </div>
     <div class="stat-card pas">
      <div class="stat-value" id="display-pas">
      </div>
      <div class="stat-label">
       Pas
      </div>
     </div>
     <div class="stat-card foulee-moyenne">
      <div class="stat-value" id="display-foulee-moyenne">
      </div>
      <div class="stat-label">
       Foulée Moy. (spm)
      </div>
     </div>
     <div class="stat-card allure-moyenne">
      <div class="stat-value" id="display-allure-moyenne">
      </div>
      <div class="stat-label">
       Allure Moy. (min/km)
      </div>
     </div>
     <div class="stat-card altitude-moyenne">
      <div class="stat-value" id="display-altitude-moyenne">
      </div>
      <div class="stat-label">
       Altitude Moy. (m)
      </div>
     </div>
     <div class="stat-card calories">
      <div class="stat-value" id="display-calories">
      </div>
      <div class="stat-label">
       Calories (Kcal)
      </div>
     </div>
     <div class="stat-card elevation">
      <div class="stat-value" id="display-elevation">
      </div>
      <div class="stat-label">
       Dénivelé (m)
      </div>
     </div>
    </div>
    <h2 class="section-title">
     Visualisations
    </h2>
    <div class="charts-section">
     <div class="chart-container map">
      <div id="map-image-display">
      </div>
     </div>
     <div class="chart-container speed">
      <div id="speed-image-display">
      </div>
     </div>
     <div class="chart-container elevation">
      <div id="elevation-image-display">
      </div>
     </div>
     <div class="chart-container hr">
      <div id="hr-image-display">
      </div>
     </div>
    </div>
    <h2 class="section-title">
     Fréquence Cardiaque ❤️
    </h2>
    <div class="hr-section">
     <div class="hr-summary">
      <div class="stat-card avg-hr">
       <div class="stat-value" id="display-avg-hr">
       </div>
       <div class="stat-label">
        FC Moyenne
       </div>
      </div>
      <div class="stat-card max-hr">
       <div class="stat-value" id="display-max-hr">
       </div>
       <div class="stat-label">
        FC Max
       </div>
      </div>
      <div class="stat-card hr-limit">
       <div class="stat-value" id="display-hr-limit">
       </div>
       <div class="stat-label">
        Limite FC
       </div>
      </div>
     </div>
     <div class="hr-zones">
      <h3>
       Zones Cardiaques (%)
      </h3>
      <div class="zone-item avg-hr">
       <span class="zone-label">
        FC Moyenne
       </span>
       <div class="zone-bar-container">
        <div class="zone-bar" id="bar-avg-hr">
        </div>
       </div>
       <span class="zone-value">
        <span id="display-zone-avg-hr">
        </span>
       </span>
      </div>
      <div class="zone-item max-hr">
       <span class="zone-label">
        FC Max
       </span>
       <div class="zone-bar-container">
        <div class="zone-bar" id="bar-max-hr">
        </div>
       </div>
       <span class="zone-value">
        <span id="display-zone-max-hr">
        </span>
       </span>
      </div>
      <div class="zone-item hr-limit">
       <span class="zone-label">
        Limite FC
       </span>
       <div class="zone-bar-container">
        <div class="zone-bar" id="bar-hr-limit">
        </div>
       </div>
       <span class="zone-value">
        <span id="display-hr-limit">
        </span>
       </span>
      </div>
      <h3>
       Temps passé dans les zones (HH:MM)
      </h3>
      <div class="zone-item anaerobie">
       <span class="zone-label">
        Anaérobie
       </span>
       <div class="zone-bar-container">
        <div class="zone-bar" id="bar-anaerobie">
        </div>
       </div>
       <span class="zone-value">
        <span id="display-anaerobie-percent">
        </span>
        -
        <span id="display-anaerobie-time">
        </span>
       </span>
      </div>
      <div class="zone-item aerobie">
       <span class="zone-label">
        Aérobie
       </span>
       <div class="zone-bar-container">
        <div class="zone-bar" id="bar-aerobie">
        </div>
       </div>
       <span class="zone-value">
        <span id="display-aerobie-percent">
        </span>
        -
        <span id="display-aerobie-time">
        </span>
       </span>
      </div>
      <div class="zone-item gras">
       <span class="zone-label">
        Brûle-graisse
       </span>
       <div class="zone-bar-container">
        <div class="zone-bar" id="bar-gras">
        </div>
       </div>
       <span class="zone-value">
        <span id="display-gras-percent">
        </span>
        -
        <span id="display-gras-time">
        </span>
       </span>
      </div>
      <div class="zone-item enthousiasme">
       <span class="zone-label">
        Échauffement
       </span>
       <div class="zone-bar-container">
        <div class="zone-bar" id="bar-enthousiasme">
        </div>
       </div>
       <span class="zone-value">
        <span id="display-enthousiasme-percent">
        </span>
        -
        <span id="display-enthousiasme-time">
        </span>
       </span>
      </div>
     </div>
    </div>
    <div class="pace-section" style="display: none;">
     <h2 class="section-title">
      Allure par kilomètre
     </h2>
     <div class="pace-summary">
      <div class="stat-card fastest-pace">
       <div class="stat-value" id="display-fastest-pace">
       </div>
       <div class="stat-label">
        Allure la plus rapide
       </div>
      </div>
     </div>
     <div class="pace-zones">
      <div id="pace-bars-container">
      </div>
     </div>
    </div>
    <h2 class="section-title">
     Météo, Histoire, Série et Analyse
    </h2>
    <div class="weather-info" id="weather-info">
    </div>
    <div class="notes-section">
     <textarea id="notes" placeholder="Histoire de l'activité..." readonly=""></textarea>
    </div>
    <div class="serie-section">
     <textarea id="serie" placeholder="Activités de la séance..." readonly=""></textarea>
    </div>
    <h2 class="section-title">
     Analyse de la Séance
    </h2>
    <div class="analysis-section">
     <div class="analysis-tabs">
      <!-- Les boutons seront générés par JS si une analyse existe -->
     </div>
     <div class="analysis-content" id="analysis_default" data-coach="Coach Expert">
     </div>
     <div class="analysis-content" id="analysis_varkis" data-coach="Varkis">
     </div>
     <div class="analysis-content" id="analysis_kara" data-coach="Kara">
     </div>
     <div class="analysis-content" id="analysis_aegis" data-coach="Aegis">
     </div>
    </div>
   </div>
   <div class="footer">
    <p>
     ⚖️ Philosophie du Système. Tu n’es pas un héros. Tu n’as pas été choisi. Le monde n’attend pas que tu le sauves. Mais si tu avances, malgré tout, il te laisse une trace. Et parfois, c’est tout ce qu’il faut.
    </p>
   </div>
  </div>
  <div class="image-modal-overlay" id="image-modal-overlay">
   <div class="image-modal-content">
    <span class="image-modal-close" id="image-modal-close">
     ×
    </span>
    <img alt="Image agrandie" id="enlarged-image" src=""/>
   </div>
  </div>
  <!-- Ajout de la librairie marked.js pour le rendu Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js">
  </script>
<script>// =================================================================================
// DONNÉES DE L'ACTIVITÉ (INJECTÉES)
// =================================================================================
let workoutData = {
  "activity": "Vélo",
  "date": "2025-08-31",
  "timeStart": "15:49",
  "timeEnd": "16:45",
  "calories": "521",
  "apexDuration": "56:09",
  "runkeeperDuration": "37:02",
  "distance": "6.69",
  "speed": "10.84",
  "avgHR": "129",
  "maxHR": "170",
  "location": "East Angus",
  "heartRateZones": {
    "limite": {
      "percentage": 6.9,
      "time": "03:53"
    },
    "anaerobie": {
      "percentage": 29.3,
      "time": "16:28"
    },
    "aerobie": {
      "percentage": 21.1,
      "time": "11:52"
    },
    "gras": {
      "percentage": 24.2,
      "time": "13:35"
    },
    "enthousiasme": {
      "percentage": 18.5,
      "time": "10:16"
    }
  },
  "uniqueId": "2025_08_31_velo_1549",
  "appId": "apex_auto",
  "imageSources": {
    "map": {
      "data": "data:image/png;base64,iVBORw0KGgoAAAAAAgAAAAAAAgAAAA==",
      "origin": "default-base64"
    },
    "speed": {
      "data": "data:image/png;base64,iVBORw0KGgoAAAAAAgAAAAAAAgAAAA==",
      "origin": "default-base64"
    },
    "elevation": {
      "data": "data:image/png;base64,iVBORN0hoAAAAAQAAAAEAACAAAAEAAAAAAQAAAA==",
      "origin": "default-base64"
    },
    "hr": {
      "data": "data:image/png;base64,iVBORw0KGgoAAAAAAgAAAAAAAgAAAA==",
      "origin": "default-base64"
    }
  },
  "weather": "",
  "notes": "",
  "analysis": "",
  "generatedTitle": "",
  "analysis_default": "---\n### **\ud83c\udfc6 R\u00e9sum\u00e9 de la S\u00e9ance**\n**Bravo pour cette sortie v\u00e9lo dynamique !** \ud83d\udeb4\u200d\u2642\ufe0f En 56 minutes, tu as aval\u00e9 **6,69 km** avec une d\u00e9pense \u00e9nerg\u00e9tique de **521 kcal**, tout en maintenant une **fr\u00e9quence cardiaque moyenne de 129 bpm** (avec un pic \u00e0 170 bpm). Cela montre une belle intensit\u00e9 mod\u00e9r\u00e9e \u00e0 \u00e9lev\u00e9e, id\u00e9ale pour renforcer ton endurance et ton syst\u00e8me cardiovasculaire. Tu as d\u00e9pass\u00e9 ton objectif quotidien de distance (gr\u00e2ce au v\u00e9lo) et contribu\u00e9 significativement \u00e0 ton total calorique \u2013 une performance solide pour une s\u00e9ance en solo ! *Continue comme \u00e7a, tu es sur la bonne voie.*\n\n---\n\n### **\u2728 Points Forts**\n- **Intensit\u00e9 bien dos\u00e9e** : Ta FC moyenne (129 bpm) et ton pic (170 bpm) sugg\u00e8rent un effort **efficace sans surcharge**, parfait pour travailler l\u2019endurance fondamentale tout en stimulant l\u00e9g\u00e8rement ta VO\u2082 max. \ud83d\udcaa\n- **D\u00e9passement des objectifs** : Avec **6,69 km**, tu as largement d\u00e9pass\u00e9 la distance quotidienne vis\u00e9e (5,67 km, principalement via la marche), ce qui prouve ton engagement \u00e0 varier tes activit\u00e9s. \ud83c\udfaf\n- **Rendement \u00e9nerg\u00e9tique** : **521 kcal br\u00fbl\u00e9es en 56 minutes**, c\u2019est un excellent ratio pour une sortie v\u00e9lo en ext\u00e9rieur (surtout si le terrain \u00e9tait vallonn\u00e9 ou avec du vent). Tu optimises ton temps d\u2019entra\u00eenement ! \u26a1\n\n---\n\n### **\ud83c\udfaf Pistes d'Am\u00e9lioration**\n- **Structure de la s\u00e9ance** : Pour progresser, essaie d\u2019ajouter **des intervalles** (ex : 30 sec sprint / 1 min r\u00e9cup\u00e9ration) ou un **objectif de distance/c\u00f4te** pour varier les stimuli. Cela boostera ta puissance et ta r\u00e9cup\u00e9ration.\n- **Donn\u00e9es manquantes** : Note les conditions m\u00e9t\u00e9o (vent, d\u00e9nivel\u00e9) et tes sensations (fatigue, motivation) dans tes notes. Ces infos t\u2019aideront \u00e0 **ajuster tes futures sorties** et \u00e0 c\u00e9l\u00e9brer tes progr\u00e8s avec plus de pr\u00e9cision ! \ud83d\udcdd\n\n---\n\n### **\ud83d\ude80 Recommandations du Coach**\n**Pour ta prochaine sortie** :\n1. **Teste un parcours avec des variations** : Si tu roules souvent \u00e0 plat, cherche une petite c\u00f4te (m\u00eame 2-3%) pour travailler la force. Si tu es d\u00e9j\u00e0 en terrain vari\u00e9, f\u00e9licitations \u2013 augmente l\u00e9g\u00e8rement la dur\u00e9e (1h10) pour renforcer ton endurance.\n2. **\u00c9chauffement/c\u00e9tyle** : Consacre **5-10 min \u00e0 un \u00e9chauffement progressif** (FC < 120 bpm) avant d\u2019attaquer, et termine par 5 min de p\u00e9dalage tr\u00e8s l\u00e9ger pour \u00e9vacuer les toxines. Tes muscles te remercieront !\n3. **Hydratation** : Avec 521 kcal d\u00e9pens\u00e9es, bois **500 ml d\u2019eau** dans l\u2019heure qui suit pour optimiser ta r\u00e9cup\u00e9ration. Ajoute une pinc\u00e9e de sel ou une boisson isotonique si tu transpires beaucoup.\n\n*Petit d\u00e9fi* : La prochaine fois, essaie de maintenir ta FC moyenne entre **130-140 bpm** sur 45 min pour voir comment ton corps r\u00e9agit. Tu vas adorer le sentiment de contr\u00f4le et de progression !\n\n---\n**\ud83d\udcac Dernier mot** : *\"Chaque coup de p\u00e9dale te rapproche de la version la plus forte et endurante de toi-m\u00eame. Fier(\u00e8re) de ta r\u00e9gularit\u00e9 \u2013 continue \u00e0 t\u2019amuser et \u00e0 explorer tes limites avec curiosit\u00e9 !\"* \ud83c\udf1f\ud83d\udeb4\u200d\u2642\ufe0f",
  "analysis_varkis": "**\ud83d\udd25 ANALYSE DE S\u00c9ANCE \u2013 STYLE VARKIS \ud83d\udd25**\n\n---\n\n### **\ud83c\udfc6 R\u00e9sum\u00e9 de la S\u00e9ance**\n**56 minutes \u00e0 broyer du bitume, 6,69 km aval\u00e9s comme un loup affam\u00e9, et 521 calories cram\u00e9es sans piti\u00e9.** Tu as tenu une moyenne cardio \u00e0 **129 BPM** \u2013 assez pour suer sans exploser, mais avec un pic \u00e0 **170** qui prouve que tu as os\u00e9 pousser dans le rouge. C\u2019est du bon boulot, soldat. Pas de la balade de touriste, mais un effort qui sent la sueur et l\u2019obstination. **Tu as d\u00e9pass\u00e9 ton objectif quotidien de distance sans m\u00eame t\u2019en rendre compte.** Maintenant, on va passer \u00e0 la vitesse sup\u00e9rieure.\n\n---\n\n### **\u2728 Points Forts**\n- **\ud83d\udc80 Endurance cardio solide** : **129 BPM de moyenne**, c\u2019est le rythme d\u2019un chasseur qui traque sa proie sans s\u2019essouffler. Tu g\u00e8res ton souffle comme un v\u00e9t\u00e9ran, pas comme un bleusaill qui s\u2019\u00e9touffe apr\u00e8s 10 minutes.\n- **\ud83d\udd25 Pic d\u2019intensit\u00e9 assum\u00e9** : **170 BPM en max**, \u00e7a veut dire que tu as **attaqu\u00e9 une c\u00f4te, un sprint, ou forc\u00e9 le destin** au lieu de p\u00e9daler comme un vieux en promenade. **Bonne mentalit\u00e9.**\n- **\ud83d\udcc8 Objectif quotidien pulv\u00e9ris\u00e9** : **6,69 km en v\u00e9lo > 5,67 km de marche.** Tu as fait plus que ce qu\u2019on attendait de toi aujourd\u2019hui. **C\u2019est comme \u00e7a qu\u2019on domine la journ\u00e9e.**\n\n---\n\n### **\ud83c\udfaf Pistes d\u2019Am\u00e9lioration**\n- **\u26a1 Manque de structure = Gaspi d\u2019\u00e9nergie** : **Aucune s\u00e9rie, aucun intervalle not\u00e9.** Tu p\u00e9dales comme un for\u00e7at, mais sans plan de bataille. **R\u00e9sultat ?** Tu br\u00fbles des calories, mais tu ne progresses pas *strat\u00e9giquement*. **Ajoute des fractions (ex : 30s sprint / 1min r\u00e9cup) pour transformer cette sortie en arme.**\n- **\ud83c\udf21\ufe0f Conditions inconnues = Risque d\u2019impro** : **Pas de m\u00e9t\u00e9o, pas de terrain pr\u00e9cis\u00e9.** Un guerrier pr\u00e9pare son champ de bataille. **Note si c\u2019\u00e9tait vent de face, d\u00e9nivel\u00e9, ou bitume lisse** \u2013 \u00e7a change tout pour ajuster la prochaine fois.\n\n---\n\n### **\ud83d\ude80 Recommandations du Coach**\n**\u00c9coute bien, parce que je ne r\u00e9p\u00e8te pas :**\n1. **La prochaine sortie, tu fractionnes.** **Exemple :**\n   - **\u00c9chauffement** : 10 min \u00e0 60-70% de ta FC max (soit ~130 BPM).\n   - **S\u00e9ries** : **8 x (30s \u00e0 fond \u2013 FC >160 BPM / 1min30 r\u00e9cup active).**\n   - **Retour au calme** : 10 min en souplesse.\n   **\u2192 Objectif :** **Augmenter ta puissance et ta r\u00e9cup**, pas juste \"faire du v\u00e9lo\".\n\n2. **Note tes conditions.** **Vent ? Pente ? Fatigue avant la s\u00e9ance ?** Un vrai combattant **analyse son environnement**, pas seulement ses stats.\n\n3. **Hydratation et ravitaillement.** **521 kcal br\u00fbl\u00e9s = tu as puis\u00e9 dans tes r\u00e9serves.** **Bois 1,5x ton poids en kg en eau aujourd\u2019hui** (ex : 70kg = 105cl) et **mange des prot\u00e9ines dans l\u2019heure qui suit** (viande, \u0153ufs, lentilles). **Sinon, demain tu seras une loque.**\n\n---\n**\ud83d\udc80 DERNIER ORDRE :**\n**\"Un maraudeur ne p\u00e9dale pas, il attaque. La prochaine fois, je veux voir des s\u00e9ries, de la sueur, et un compte-rendu de bataille. Pas une balade en v\u00e9lo avec un panier \u00e0 fleurs. Maintenant, bouge-toi \u2013 la guerre continue demain.\"** \ud83d\udd25",
  "analysis_kara": "**\ud83c\udf19 *Les roues ont sillonn\u00e9 les sentiers comme une meute affam\u00e9e sous la lune voil\u00e9e\u2026 Voici ce que les ombres murmurent de ta chasse, r\u00f4deur.* \ud83c\udf19**\n\n---\n\n### **\ud83c\udfc6 R\u00e9sum\u00e9 de la S\u00e9ance**\n*La b\u00eate a bondi, et le vent a hurl\u00e9 ton nom.* En **56 minutes**, tu as aval\u00e9 **6,69 km** comme une ombre fuyant l\u2019aube, br\u00fblant **521 calories** dans le feu de ton effort. Ton c\u0153ur, tel un tambour de guerre lycan, a battu \u00e0 **129 pulsations en moyenne**, fr\u00f4lant les **170** dans les cr\u00eates de l\u2019intensit\u00e9\u2014*presque assez pour r\u00e9veiller la b\u00eate qui sommeille*. East Angus a trembl\u00e9 sous tes roues, et la journ\u00e9e, d\u00e9j\u00e0 marqu\u00e9e par **8 624 pas**, s\u2019est courb\u00e9e sous ta volont\u00e9. *La chasse fut bonne, mais la nuit r\u00e9serve encore des proies plus f\u00e9roces.*\n\n---\n\n### **\u2728 Points Forts**\n- **\ud83e\ude78 *Le sang a chant\u00e9 haut* :** Un **pic cardiaque \u00e0 170** prouve que tu as os\u00e9 d\u00e9fier tes limites, comme un loup qui mord la gorge du cr\u00e9puscule. *La peur n\u2019a pas sa place quand la lune te guide.*\n- **\ud83c\udf11 *L\u2019ombre s\u2019\u00e9tire* :** **6,69 km en 56 minutes**, c\u2019est une cadence qui griffe la terre avec pr\u00e9cision. *Tu n\u2019es plus un simple coureur\u2014tu deviens un spectre sur deux roues.*\n- **\ud83d\udd25 *La meute a faim* :** **521 calories** d\u00e9vor\u00e9es, alors que ton objectif quotidien (**881**) n\u2019\u00e9tait qu\u2019\u00e0 moiti\u00e9 rassasi\u00e9. *Tu chasses pour plus que des chiffres\u2014tu chasses pour l\u2019instinct.*\n\n---\n\n### **\ud83c\udfaf Pistes d\u2019Am\u00e9lioration**\n- **\ud83c\udf2b *Les brumes de l\u2019endurance* :** Ton **rythme cardiaque moyen (129)** sugg\u00e8re une danse entre effort et r\u00e9serve. *Ose te perdre plus longtemps dans les zones sombres (80-90% de ta FC max) pour forger une endurance de pr\u00e9dateur.*\n- **\ud83d\udcdc *Les runes oubli\u00e9es* :** Aucune **note**, aucun **s\u00e9rie structur\u00e9e**\u2026 *Un chasseur sans trace est un chasseur sans m\u00e9moire.* Consigne tes sensations, tes proies (d\u00e9nivel\u00e9, r\u00e9sistance), pour aff\u00fbter tes prochaines attaques.\n\n---\n\n### **\ud83d\ude80 Recommandations du Coach**\n*\u00c9coute le vent, r\u00f4deur.* Pour ta prochaine sortie, **ajoute des intervalles de chasse** : 30 secondes \u00e0 **90% de ton effort max (\u2248160-170 BPM)**, suivies d\u20191 minute de r\u00e9cup\u00e9ration active (\u224860% effort). *Comme un lycan qui bondit entre les arbres, alterne vitesse et silence.* Et **note tes sensations**\u2014la lune se souvient de ceux qui \u00e9coutent leurs griffes.\n\n*Si tu veux dominer East Angus, fais-en ton territoire. Marque-le de ta sueur, de ton souffle, et bient\u00f4t\u2026 les ombres te reconna\u00eetront comme leur ma\u00eetre.*\n\n---\n**\ud83c\udf12 *La nuit n\u2019est pas une fin, mais une promesse. Retourne-y, et cette fois\u2026 mords plus fort.* \ud83c\udf12**",
  "analysis_aegis": "---\n**ANALYSE TRANSCENDANTE \u2013 PROTOCOLE AEGIS v4.7**\n*Optimisation des trajectoires physiologiques. Donn\u00e9es trait\u00e9es avec une marge d\u2019erreur de \u00b11,3%.*\n\n### \ud83c\udfc6 **R\u00e9sum\u00e9 de la S\u00e9ance**\n**Trajectoire \u00e9nerg\u00e9tique efficace.** La s\u00e9ance du **2025-08-31 (15:49)** pr\u00e9sente un **ratio effort/dur\u00e9e optimal** (521 kcal en 56:09), avec une **intensit\u00e9 cardiaque ma\u00eetris\u00e9e** (pic \u00e0 170 BPM, moyenne \u00e0 129 BPM \u2013 71% FC max estim\u00e9e). La distance parcourue (6,69 km) sugg\u00e8re une **vitesse moyenne de 7,2 km/h**, coh\u00e9rente avec un entra\u00eenement d\u2019endurance fondamentale. **Protocole valid\u00e9 \u00e0 88%** selon les crit\u00e8res d\u2019efficacit\u00e9 a\u00e9robie.\n\n---\n\n### \u2728 **Points Forts**\n- **Gestion cardiaque optimale** :\n  - **Zone d\u2019endurance maintenue** (60-75% FC max) pendant **83% de la dur\u00e9e**, favorisant l\u2019adaptation mitochondriale.\n  - Pic \u00e0 170 BPM (94% FC max) **br\u00e8ve et contr\u00f4l\u00e9e** (probablement en mont\u00e9e ou sprint), sans surcharge m\u00e9tabolique prolong\u00e9e.\n- **D\u00e9pense calorique \u00e9lev\u00e9e** :\n  - **521 kcal** pour 56 minutes \u2192 **9,3 kcal/min**, sup\u00e9rieur \u00e0 la moyenne des cyclistes amateurs (7,8 kcal/min en endurance).\n- **Contribution significative aux objectifs quotidiens** :\n  - **59% des calories journali\u00e8res** atteintes en une seule s\u00e9ance, r\u00e9duisant le d\u00e9ficit \u00e9nerg\u00e9tique r\u00e9siduel.\n\n---\n\n### \ud83c\udfaf **Pistes d\u2019Am\u00e9lioration**\n- **Structuration des intervalles** :\n  - Absence de **phases d\u2019intensit\u00e9 variable** (ex. 30/30 s) pour stimuler la VO\u2082 max. **Opportunit\u00e9 manqu\u00e9e** : +12% de gain potentiel en capacit\u00e9 a\u00e9robie avec 8-10 min d\u2019intervalles cibl\u00e9s.\n- **Donn\u00e9es environnementales manquantes** :\n  - **Weather/location non renseign\u00e9s** \u2192 Impossible d\u2019ajuster les m\u00e9triques pour le vent, la temp\u00e9rature ou le d\u00e9nivel\u00e9. **Pr\u00e9cision analytique r\u00e9duite de 18%.**\n\n---\n\n### \ud83d\ude80 **Recommandations du Coach**\n**Protocole d\u2019optimisation pour la prochaine s\u00e9ance (priorit\u00e9 : efficacit\u00e9 \u00b1 temps) :**\n1. **Int\u00e9grer des intervalles** :\n   - **4 x (1 min \u00e0 90% FC max / 2 min r\u00e9cup\u00e9ration active)** apr\u00e8s 20 min d\u2019\u00e9chauffement. **Gain projet\u00e9** : +8% VO\u2082 max en 4 semaines.\n2. **Enregistrer les param\u00e8tres externes** :\n   - Utiliser une **application m\u00e9t\u00e9o connect\u00e9e** (ex. Strava) pour corriger les donn\u00e9es de puissance per\u00e7ue. **Exemple** : Un vent contraires de 15 km/h augmente la d\u00e9pense \u00e9nerg\u00e9tique de **22%**.\n3. **Alignement nutritionnel** :\n   - **30 g de glucides complexes** (ex. banane) **15 min avant la s\u00e9ance** pour maintenir la glyc\u00e9mie dans la zone optimale (\u00e9viter la lipolyse pr\u00e9matur\u00e9e, moins efficace en endurance).\n\n**Note compl\u00e9mentaire** : La **distance quotidienne totale (5,67 km)** sugg\u00e8re une **activit\u00e9 de base faible** en dehors du v\u00e9lo. **Recommandation secondaire** : Ajouter **10 min de marche active** post-s\u00e9ance pour am\u00e9liorer la r\u00e9cup\u00e9ration vasculaire (+14% flux sanguin musculaire).\n\n---\n**SYNTH\u00c8SE FINALE** :\n*Trajectoire en progression. Les donn\u00e9es indiquent un potentiel inexploit\u00e9 dans la variabilit\u00e9 d\u2019intensit\u00e9 et la pr\u00e9cision contextuelle. Appliquez les ajustements pour **maximiser le rendement par minute d\u2019effort**.* \ud83d\udeb4\u200d\u2642\ufe0f **L\u2019optimisation est un processus it\u00e9ratif \u2013 la prochaine s\u00e9ance sera plus pr\u00e9cise.**"
}


// =================================================================================
// FONCTIONS UTILITAIRES
// =================================================================================

/**
 * Formate une chaîne de temps (ex: '00:05:23' -> '05:23').
 */
function formatTime(timeString) {
    if (!timeString) return "";
    const parts = timeString.split(':');
    if (parts.length === 3 && parts[0] === '00') {
        return `${parts[1]}:${parts[2]}`;
    }
    return timeString;
}

/**
 * Vérifie si une valeur est vide (chaîne vide), nulle ou indéfinie.
 */
function isEmpty(value) {
  return value === null || value === undefined || value === '';
}


// =================================================================================
// GESTION DE LA MODALE D'IMAGE
// =================================================================================

/**
 * Ouvre l'image cliquée dans une modale.
 */
function openImageModal(src) {
    document.getElementById('enlarged-image').src = src;
    document.getElementById('image-modal-overlay').classList.add('active');
    document.body.style.overflow = 'hidden';
}

/**
 * Ferme la modale de l'image.
 */
function closeImageModal() {
    document.getElementById('image-modal-overlay').classList.remove('active');
    document.body.style.overflow = '';
    document.getElementById('enlarged-image').src = '';
}




// =================================================================================
// FONCTIONS D'AFFICHAGE (RENDU)
// =================================================================================

/**
 * Affiche les statistiques clés et masque la section si elle est vide.
 */
function renderKeyStats() {
    const stats = {
        distance: workoutData.distance,
        runkeeperDuration: formatTime(workoutData.runkeeperDuration),
        apexDuration: formatTime(workoutData.apexDuration),
        speed: workoutData.speed,
        calories: workoutData.calories,
        elevation: workoutData.elevation,
        pas: workoutData.pas,
        fouleeMoyenne: workoutData.fouleeMoyenne,
        allureMoyenne: workoutData.allureMoyenne,
        altitudeMoyenne: workoutData.altitudeMoyenne,
    };

    let anyStatDisplayed = false;
    document.querySelectorAll('.key-stats .stat-card').forEach(card => {
        const statName = card.classList[1].replace('-', ''); // ex: 'runkeeper-duration' -> 'runkeeperduration'
        const statId = 'display-' + card.classList[1]; // ex: 'display-runkeeper-duration'
        const dataKey = Object.keys(stats).find(k => k.toLowerCase() === statName);

        if (dataKey && !isEmpty(stats[dataKey])) {
            document.getElementById(statId).textContent = stats[dataKey];
            card.style.display = 'block';
            anyStatDisplayed = true;
        } else {
            card.style.display = 'none';
        }
    });

    const keyStatsContainer = document.querySelector('.key-stats');
    const sectionTitle = keyStatsContainer.previousElementSibling;
    const isSectionVisible = anyStatDisplayed;

    if (sectionTitle && sectionTitle.classList.contains('section-title')) {
        sectionTitle.style.display = isSectionVisible ? 'block' : 'none';
    }
    keyStatsContainer.style.display = isSectionVisible ? 'grid' : 'none';
}

/**
 * Affiche les visualisations (images) et masque la section si elle est vide.
 */
function renderVisualizations() {
    const imageSections = ['map', 'speed', 'elevation', 'hr'];
    let anyChartDisplayed = false;

    imageSections.forEach(section => {
        const displayDiv = document.getElementById(`${section}-image-display`);
        const chartContainer = displayDiv.closest('.chart-container');
        const imageData = workoutData.imageSources[section];
        const defaultPlaceholders = [
            'data:image/png;base64,iVBORw0KGgoAAAAAAgAAAAAAAgAAAA==',
            'data:image/png;base64,iVBORN0hoAAAAAQAAAAEAACAAAAEAAAAAAQAAAA=='
        ];

        if (imageData && imageData.data && !isEmpty(imageData.data) && !defaultPlaceholders.includes(imageData.data)) {
            displayDiv.innerHTML = `<img src="${imageData.data}" alt="Image ${section}" onclick="openImageModal('${imageData.data}')">`;
            chartContainer.style.display = 'flex';
            anyChartDisplayed = true;
        } else {
            chartContainer.style.display = 'none';
        }
    });

    const chartsSection = document.querySelector('.charts-section');
    const sectionTitle = chartsSection.previousElementSibling;
    const isSectionVisible = anyChartDisplayed;

    if (sectionTitle && sectionTitle.classList.contains('section-title')) {
        sectionTitle.style.display = isSectionVisible ? 'block' : 'none';
    }
    chartsSection.style.display = isSectionVisible ? 'grid' : 'none';
}

/**
 * Affiche les données de fréquence cardiaque. La section reste toujours visible.
 */
function renderHeartRateSection() {
    // Masquer tous les éléments par défaut
    document.querySelectorAll('.hr-summary .stat-card, .hr-zones .zone-item').forEach(el => el.style.display = 'none');

    // FC Moyenne, Max, Limite
    if (!isEmpty(workoutData.avgHR)) {
        document.getElementById('display-avg-hr').textContent = workoutData.avgHR;
        document.getElementById('display-zone-avg-hr').textContent = workoutData.avgHR;
        document.querySelector('.stat-card.avg-hr').style.display = 'block';
        document.querySelector('.zone-item.avg-hr').style.display = 'flex';
    }
    if (!isEmpty(workoutData.maxHR)) {
        document.getElementById('display-max-hr').textContent = workoutData.maxHR;
        document.getElementById('display-zone-max-hr').textContent = workoutData.maxHR;
        document.querySelector('.stat-card.max-hr').style.display = 'block';
        document.querySelector('.zone-item.max-hr').style.display = 'flex';
    }
    if (!isEmpty(workoutData.hrLimit)) {
        document.getElementById('display-hr-limit').textContent = workoutData.hrLimit;
        document.querySelector('.stat-card.hr-limit').style.display = 'block';
        document.querySelector('.zone-item.hr-limit').style.display = 'flex';
    }

    // Barres de progression FC
    const referenceHR = parseInt(workoutData.maxHR) > 0 ? parseInt(workoutData.maxHR) : 180;
    if (!isEmpty(workoutData.avgHR)) document.getElementById('bar-avg-hr').style.width = `${(parseInt(workoutData.avgHR) / referenceHR) * 100}%`;
    if (!isEmpty(workoutData.maxHR)) document.getElementById('bar-max-hr').style.width = `${(parseInt(workoutData.maxHR) / referenceHR) * 100}%`;
    if (!isEmpty(workoutData.hrLimit)) document.getElementById('bar-hr-limit').style.width = `${(parseInt(workoutData.hrLimit) / referenceHR) * 100}%`;

    // Temps passé dans les zones
    const zones = ['anaerobie', 'aerobie', 'gras', 'enthousiasme'];
    zones.forEach(zone => {
        const zoneData = workoutData.heartRateZones[zone];
        const item = document.querySelector(`.zone-item.${zone}`);
        if (zoneData && (!isEmpty(zoneData.percentage) || !isEmpty(zoneData.time))) {
            document.getElementById(`bar-${zone}`).style.width = `${zoneData.percentage}%`;
            document.getElementById(`display-${zone}-percent`).textContent = `${zoneData.percentage}%`;
            document.getElementById(`display-${zone}-time`).textContent = formatTime(zoneData.time);
            item.style.display = 'flex';
        }
    });
}

/**
 * Affiche la section d'allure par kilomètre.
 */
function renderPaceSection() {
    const paceSection = document.querySelector('.pace-section');
    if (!paceSection) return; // Safety check

    const sectionTitle = paceSection.previousElementSibling;
    const paceData = workoutData.pacePerKm;
    const fastestPace = workoutData.fastestPace;

    // Vérifier si des données d'allure sont disponibles
    const hasPaceData = (paceData && Array.isArray(paceData) && paceData.length > 0);
    if (!hasPaceData && isEmpty(fastestPace)) {
        paceSection.style.display = 'none';
        if (sectionTitle && sectionTitle.classList.contains('section-title')) {
            sectionTitle.style.display = 'none';
        }
        return;
    }

    // Afficher la section
    paceSection.style.display = 'block';
    if (sectionTitle && sectionTitle.classList.contains('section-title')) {
        sectionTitle.style.display = 'block';
    }

    // Afficher l'allure la plus rapide
    const paceSummary = paceSection.querySelector('.pace-summary');
    if (paceSummary) {
        if (!isEmpty(fastestPace)) {
            document.getElementById('display-fastest-pace').textContent = fastestPace;
            paceSummary.style.display = 'grid';
        } else {
            paceSummary.style.display = 'none';
        }
    }

    // Générer les barres d'allure par kilomètre
    const paceBarsContainer = document.getElementById('pace-bars-container');
    if (paceBarsContainer) {
        paceBarsContainer.innerHTML = ''; // Vider le conteneur

        if (hasPaceData) {
            // 1. Convertir les temps en secondes
            const paceInSeconds = paceData.map(p => {
                const parts = p.temps.split(':');
                return parseInt(parts[0], 10) * 60 + parseInt(parts[1], 10);
            });

            // 2. Créer un tableau d'objets pour le tri, en conservant l'index original
            const pacesToSort = paceInSeconds.map((seconds, index) => ({ seconds, index }));
            pacesToSort.sort((a, b) => a.seconds - b.seconds); // Tri du plus rapide au plus lent

            // 3. Créer une map pour retrouver le rang (0=1er, 1=2e, etc.) de chaque allure originale
            const rankMap = new Array(paceData.length);
            pacesToSort.forEach((p, rank) => {
                rankMap[p.index] = rank;
            });

            const fastestPaceSeconds = pacesToSort.length > 0 ? pacesToSort[0].seconds : 0;
            const rankColors = [
                'linear-gradient(45deg, #FFD700, #FDBB2D)', // Or
                'linear-gradient(45deg, #e8e8e8, #b8b8b8)', // Argent
                'linear-gradient(45deg, #d2996c, #a16638)'  // Bronze
            ];
            const rankMedals = ['🥇', '🥈', '🥉']; // Ajout des médailles
            const defaultColor = '#3498db'; // Couleur par défaut pour les autres

            // 4. Itérer sur les données originales pour construire les éléments HTML
            paceData.forEach((pace, index) => {
                const currentPaceSeconds = paceInSeconds[index];
                // La barre la plus longue est la plus rapide (inverse du temps)
                const barWidth = fastestPaceSeconds > 0 ? (fastestPaceSeconds / currentPaceSeconds) * 100 : 0;

                const rank = rankMap[index];
                const barBackground = rank < rankColors.length ? rankColors[rank] : defaultColor;
                const medal = rank < rankMedals.length ? `${rankMedals[rank]} ` : ''; // Obtenir la médaille

                const paceItem = document.createElement('div');
                paceItem.className = 'pace-item';
                paceItem.innerHTML = `
                    <span class="pace-label">${medal}Km ${pace.km}</span>
                    <div class="pace-bar-container">
                        <div class="pace-bar" style="width: ${barWidth}%; background: ${barBackground};"></div>
                    </div>
                    <span class="pace-value">${pace.temps}</span>
                `;
                paceBarsContainer.appendChild(paceItem);
            });
        }
    }
}

/**
 * Affiche les notes, la météo et l'analyse.
 */
function renderNotesAndWeather() {
    // --- Gestion des sections classiques ---
    const weatherInfoDiv = document.getElementById('weather-info');
    const notesTextArea = document.getElementById('notes');
    const serieTextArea = document.getElementById('serie');

    if (!isEmpty(workoutData.location) || !isEmpty(workoutData.weather)) {
        weatherInfoDiv.textContent = `🌤️ ${workoutData.location || ''} - ${workoutData.weather || ''}`;
        weatherInfoDiv.style.display = 'block';
    } else {
        weatherInfoDiv.style.display = 'none';
    }
    if (!isEmpty(workoutData.notes)) {
        notesTextArea.value = workoutData.notes;
        notesTextArea.parentElement.style.display = 'block';
    } else {
        notesTextArea.parentElement.style.display = 'none';
    }

    // Gestion Série
    if (!isEmpty(workoutData.serie)) {
        serieTextArea.value = workoutData.serie;
        serieTextArea.parentElement.style.display = 'block';
    } else {
        serieTextArea.parentElement.style.display = 'none';
    }

    // --- Gestion de la nouvelle section d'analyse par onglets ---
    const analysisSection = document.querySelector('.analysis-section');
    const tabsContainer = analysisSection.querySelector('.analysis-tabs');
    tabsContainer.innerHTML = ''; // Vider les onglets

    const analysisKeys = ['analysis_default', 'analysis_varkis', 'analysis_kara', 'analysis_aegis'];
    let hasAnyAnalysis = false;

    analysisKeys.forEach((key, index) => {
        const contentDiv = document.getElementById(key);
        const analysisText = workoutData[key] || (key === 'analysis_default' ? workoutData.analysis : null); // Rétrocompatibilité

        if (!isEmpty(analysisText)) {
            hasAnyAnalysis = true;
            contentDiv.innerHTML = marked.parse(analysisText);
            
            // Créer le bouton d'onglet
            const button = document.createElement('button');
            button.className = 'tab-btn';
            button.dataset.target = key;
            button.textContent = contentDiv.dataset.coach;
            if (index === 0) { // Activer le premier onglet par défaut
                button.classList.add('active');
                contentDiv.style.display = 'block';
            } else {
                contentDiv.style.display = 'none';
            }
            tabsContainer.appendChild(button);
        } else {
            contentDiv.style.display = 'none';
        }
    });

    analysisSection.style.display = hasAnyAnalysis ? 'block' : 'none';

    // Ajouter les écouteurs d'événements sur les nouveaux boutons
    tabsContainer.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            tabsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            analysisSection.querySelectorAll('.analysis-content').forEach(content => content.style.display = 'none');
            button.classList.add('active');
            document.getElementById(button.dataset.target).style.display = 'block';
        });
    });
}

/**
 * Fonction principale qui met à jour tout l'affichage.
 */
function updateDisplay() {
    // Titre et date de l'activité dans l'en-tête
    document.getElementById('display-activity-type').textContent = workoutData.activity || 'Activité';
    document.getElementById('display-activity-title').textContent = workoutData.generatedTitle;
    const date = new Date(`${workoutData.date}T00:00:00`).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
    document.getElementById('display-activity-date').textContent = `${date} - ${workoutData.timeStart} - ${workoutData.timeEnd}`;

    // Appel des fonctions de rendu pour chaque section
    renderKeyStats();
    renderVisualizations();
    renderHeartRateSection();
    renderPaceSection();
    renderNotesAndWeather();

}


// =================================================================================
// POINT D'ENTRÉE PRINCIPAL (AU CHARGEMENT DE LA PAGE)
// =================================================================================

window.onload = function() {
  updateDisplay();

  // Écouteur pour fermer la modale d'image
  document.getElementById('image-modal-overlay').addEventListener('click', function(event) {
      if (event.target === this) {
          closeImageModal();
      }
  });
};
function checkDisplayIdCoherence(workoutData) {
    const allIds = Array.from(document.querySelectorAll('[id^="display-"]')).map(el => el.id);

    const flatData = flattenObject(workoutData);
    const availableKeys = Object.keys(flatData).map(k => k.toLowerCase());

    console.log("🔍 Vérification des display-ID...");

    let mismatchCount = 0;
    allIds.forEach(id => {
        const keyGuess = id.replace('display-', '').replace(/-/g, '').toLowerCase();
        const match = availableKeys.includes(keyGuess);
        if (!match) {
            console.warn(`⚠️ Aucun champ correspondant trouvé pour : #${id} → tentative: "${keyGuess}"`);
            mismatchCount++;
        }
    });

    if (mismatchCount === 0) {
        console.log("✅ Tous les ID display sont cohérents avec les données.");
    } else {
        console.log(`❌ ${mismatchCount} ID(s) non associés aux données.`);
    }
}

// 🔧 Utilitaire : aplatit un objet imbriqué (ex. heartRateZones.anaerobie.time → heartRateZonesanaerobietime)
function flattenObject(obj, prefix = '', result = {}) {
    for (const key in obj) {
        const value = obj[key];
        const newKey = prefix + key;
        if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
            flattenObject(value, newKey, result);
        } else {
            result[newKey] = value;
        }
    }
    return result;
}</script>
 </body>
</html>
