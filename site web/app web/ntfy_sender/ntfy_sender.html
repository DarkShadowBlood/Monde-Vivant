<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envoyer une Notification Coach√©e</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="p-6 bg-gray-900 text-gray-300">
    <div class="max-w-5xl mx-auto bg-gray-800 p-8 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-100">Envoyer une Notification Coach√©e</h1>

        <!-- Section G√©n√©rateur de Message (pour envoi manuel) -->
        <div id="manual-send-section" class="mb-8 p-6 bg-gray-700/50 rounded-xl shadow-inner">
            <h2 class="text-2xl font-bold mb-4 text-gray-200">G√©n√©rateur de Message Coach</h2>
            
            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div class="md:col-span-2">
                    <label for="manual-request-template" class="block text-sm font-medium text-gray-400 mb-1">Mod√®les de Requ√™te</label>
                    <select id="manual-request-template" class="w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
                </div>
                <div>
                    <label for="coach-selector" class="block text-sm font-medium text-gray-400 mb-1">Style du Coach</label>
                    <select id="coach-selector" class="w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
                </div>
                <div>
                    <label for="request-input" class="block text-sm font-medium text-gray-400 mb-1">Votre Requ√™te</label>
                    <input type="text" id="request-input" placeholder="Ex: Rappel pour ne pas oublier de transf√©rer les activit√©s" class="w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="category-selector" class="block text-sm font-medium text-gray-400 mb-1">Cat√©gorie d'Exercices</label>
                    <select id="category-selector" class="w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">-- Aucune --</option>
                    </select>
                </div>
                <div>
                    <label for="exercise-selector" class="block text-sm font-medium text-gray-400 mb-1">Exercices (maintenir Ctrl pour multi-s√©lection)</label>
                    <select id="exercise-selector" multiple class="w-full h-32 p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <!-- Les exercices appara√Ætront ici -->
                    </select>
                </div>
            </div>

            <div class="flex justify-end">
                <button id="generate-manual-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                    G√©n√©rer et Ins√©rer
                </button>
            </div>

            <!-- Section Mod√®les -->
            <h2 class="text-2xl font-bold mb-4 text-gray-200">Mod√®les de Messages</h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label for="template-selector" class="block text-sm font-medium text-gray-400 mb-1">Charger un mod√®le</label>
                    <div class="flex gap-2">
                        <select id="template-selector" class="flex-grow w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">-- S√©lectionner --</option>
                        </select>
                        <button id="delete-template-btn" class="bg-red-500 text-white font-bold py-2 px-3 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 transition duration-200" title="Supprimer le mod√®le s√©lectionn√©">üóëÔ∏è</button>
                    </div>
                </div>
                <div>
                    <label for="template-name-input" class="block text-sm font-medium text-gray-400 mb-1">Sauvegarder le message actuel</label>
                    <div class="flex gap-2">
                        <input type="text" id="template-name-input" placeholder="Nom du nouveau mod√®le..." class="flex-grow w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button id="save-template-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">Sauver</button>
                    </div>
                </div>
            </div>

            <!-- Section d'envoi manuel -->
            <div class="mt-8">
                <label for="manual-message" class="block text-sm font-medium text-gray-400 mb-1">Message √† envoyer</label>
                <textarea id="manual-message" placeholder="Votre message appara√Ætra ici..." class="w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="6"></textarea>
                <div class="mt-4 flex justify-between items-center">
                    <div id="manual-status" class="font-bold text-sm"></div>
                    <button id="manual-send-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200">
                        Envoyer la notification
                    </button>
                </div>
            </div>
        </div>

        <!-- Section Planification -->
        <div id="schedule-section" class="mb-8 p-6 bg-gray-700/50 rounded-xl shadow-inner">
            <h2 class="text-2xl font-bold mb-4 text-gray-200">Planification de Rappels Automatiques</h2>
            <p class="text-sm text-gray-400 mb-4">Cr√©ez une s√©rie de rappels quotidiens. Le syst√®me g√©n√©rera un message unique pour chaque jour avec un coach al√©atoire, bas√© sur votre requ√™te.</p>
            
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Colonne de gauche : Configuration -->
                <div>
                    <h3 class="text-xl font-bold text-gray-300 mb-3">1. Configurer la s√©quence</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="schedule-request-template" class="block text-sm font-medium text-gray-400 mb-1">Mod√®les de Requ√™te</label>
                            <select id="schedule-request-template" class="w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="schedule-request" class="block text-sm font-medium text-gray-400 mb-1">Requ√™te pour le coach</label>
                            <input type="text" id="schedule-request" placeholder="Ex: Rappel pour faire ma s√©ance de sport" class="w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="schedule-prefix" class="block text-sm font-medium text-gray-400 mb-1">Pr√©fixe du nom des t√¢ches</p>
                            <input type="text" id="schedule-prefix" value="Rappel Quotidien" class="w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="schedule-trigger" class="block text-sm font-medium text-gray-400 mb-1">D√©clencheur</label>
                            <select id="schedule-trigger" class="w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="time">Heure fixe</option>
                                <option value="startup">Au d√©marrage de l'ordinateur (1x/jour)</option>
                            </select>
                        </div>
                        <div id="schedule-time-container">
                            <label for="schedule-time" class="block text-sm font-medium text-gray-400 mb-1">Heure d'envoi</label>
                            <input type="time" id="schedule-time" value="21:00" class="w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="schedule-duration" class="block text-sm font-medium text-gray-400 mb-1">Dur√©e</label>
                            <select id="schedule-duration" class="w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="7">Pendant 1 semaine</option>
                                <option value="14">Pendant 2 semaines</option>
                                <option value="30" selected>Pendant 1 mois</option>
                                <option value="custom">Jusqu'√† une date pr√©cise...</option>
                            </select>
                        </div>
                        <div id="custom-date-container" class="hidden">
                            <label for="schedule-end-date" class="block text-sm font-medium text-gray-400 mb-1">Date de fin</label>
                            <input type="date" id="schedule-end-date" class="w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <button id="preview-schedule-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                            2. Pr√©visualiser les messages
                        </button>
                    </div>
                </div>

                <!-- Colonne de droite : Pr√©visualisation et validation -->
                <div>
                    <h3 class="text-xl font-bold text-gray-300 mb-3">3. Valider et Planifier</h3>
                    <div id="schedule-preview-container" class="bg-gray-900/50 p-4 rounded-md h-80 overflow-y-auto">
                        <p class="text-gray-500 italic text-center mt-4">Les messages g√©n√©r√©s par l'IA pour chaque jour appara√Ætront ici...</p>
                    </div>
                    <div id="schedule-status" class="font-bold text-sm mt-2 min-h-[20px]"></div>
                    <button id="confirm-schedule-btn" class="w-full mt-2 bg-purple-600 text-white font-bold py-2 px-4 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                        Confirmer et Lancer la Planification
                    </button>
                </div>
            </div>

            <!-- Liste des t√¢ches existantes -->
            <div class="mt-8">
                <h3 class="text-xl font-bold text-gray-300 mb-2">T√¢ches Actuellement Planifi√©es</h3>
                <div id="task-list" class="bg-gray-900/50 p-3 rounded-md min-h-[60px] max-h-48 overflow-y-auto">
                    <p class="text-gray-500 italic">Chargement des t√¢ches...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale de Modification -->
    <div id="edit-task-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4 text-gray-200">Modifier la T√¢che</h2>
            <p id="edit-task-name" class="text-sm text-gray-400 mb-4"></p>
            <div class="space-y-4">
                <div>
                    <label for="edit-task-time" class="block text-sm font-medium text-gray-400 mb-1">Nouvelle Heure</label>
                    <input type="time" id="edit-task-time" class="w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md">
                </div>
                <div>
                    <label for="edit-task-coach" class="block text-sm font-medium text-gray-400 mb-1">Nouveau Coach</label>
                    <select id="edit-task-coach" class="w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md"></select>
                </div>
                <div>
                    <label for="edit-task-message" class="block text-sm font-medium text-gray-400 mb-1">Nouveau Message</label>
                    <textarea id="edit-task-message" rows="5" class="w-full p-2 border border-gray-600 bg-gray-900 text-gray-300 rounded-md"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="cancel-edit-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-500">Annuler</button>
                <button id="save-edit-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700">Sauvegarder</button>
            </div>
        </div>
    </div>

    <script>
        const allExercises = {};
        let generatedSchedule = null; // Stocke les messages pr√©visualis√©s pour la confirmation
        const TEMPLATES_STORAGE_KEY = 'ntfy_message_templates';

        // √âl√©ments du DOM
        const manualMessageTextarea = document.getElementById('manual-message'),
              manualSendBtn = document.getElementById('manual-send-btn'),
              manualStatusDiv = document.getElementById('manual-status'),
              coachSelector = document.getElementById('coach-selector'),
              requestInput = document.getElementById('request-input'),
              categorySelector = document.getElementById('category-selector'),
              exerciseSelector = document.getElementById('exercise-selector'),
              generateManualBtn = document.getElementById('generate-manual-btn'),
              templateSelector = document.getElementById('template-selector'),
              saveTemplateBtn = document.getElementById('save-template-btn'),
              deleteTemplateBtn = document.getElementById('delete-template-btn'),
              templateNameInput = document.getElementById('template-name-input');
        
        const manualRequestTemplate = document.getElementById('manual-request-template'),
              scheduleRequestTemplate = document.getElementById('schedule-request-template');

        // Nouveaux √©l√©ments pour la planification
        const scheduleRequestInput = document.getElementById('schedule-request');
        const schedulePrefixInput = document.getElementById('schedule-prefix');
        const scheduleTriggerSelect = document.getElementById('schedule-trigger');
        const scheduleTimeContainer = document.getElementById('schedule-time-container');
        const scheduleTimeInput = document.getElementById('schedule-time');
        const scheduleDurationSelect = document.getElementById('schedule-duration');
        const customDateContainer = document.getElementById('custom-date-container');
        const scheduleEndDateInput = document.getElementById('schedule-end-date');
        const previewScheduleBtn = document.getElementById('preview-schedule-btn');
        const schedulePreviewContainer = document.getElementById('schedule-preview-container');
        const confirmScheduleBtn = document.getElementById('confirm-schedule-btn');
        const scheduleStatusDiv = document.getElementById('schedule-status');
        const taskListDiv = document.getElementById('task-list');

        // √âl√©ments de la modale de modification
        const editTaskModal = document.getElementById('edit-task-modal');
        const editTaskNameP = document.getElementById('edit-task-name');
        const editTaskTimeInput = document.getElementById('edit-task-time');
        const editTaskCoachSelect = document.getElementById('edit-task-coach');
        const editTaskMessageTextarea = document.getElementById('edit-task-message');
        const saveEditBtn = document.getElementById('save-edit-btn');

        /**
         * Fonction centralis√©e pour les appels √† l'API backend.
         * G√®re les headers, la conversion JSON et les erreurs de base.
         * @param {string} endpoint - Le chemin de l'API (ex: '/api/coaches').
         * @param {object} [options={}] - Les options pour fetch (method, body, etc.).
         * @returns {Promise<any>} - La r√©ponse JSON de l'API.
         */
        async function apiFetch(endpoint, options = {}) {
            const defaultOptions = {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
            };
            const config = { ...defaultOptions, ...options };
            if (config.body) {
                config.body = JSON.stringify(config.body);
            }

            const response = await fetch(endpoint, config);
            const result = await response.json();
            if (!response.ok || !result.success) throw new Error(result.error || `Erreur serveur (${response.status})`);
            return result;
        }

        // Pr√©-remplir le message si pass√© en param√®tre d'URL
        const initialize = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const message = urlParams.get('message');
            if (message) {
                manualMessageTextarea.value = decodeURIComponent(message);
            }

            // Pr√©-remplir la date de fin √† 1 mois
            const today = new Date();
            const oneMonthLater = new Date(today.setMonth(today.getMonth() + 1));
            const yyyy = oneMonthLater.getFullYear();
            const mm = String(oneMonthLater.getMonth() + 1).padStart(2, '0');
            const dd = String(oneMonthLater.getDate()).padStart(2, '0');
            scheduleEndDateInput.value = `${yyyy}-${mm}-${dd}`;

            // Charger les mod√®les
            loadTemplates();

            // Charger les t√¢ches planifi√©es
            loadScheduledTasks();

            // Charger les coachs
            try {
                const result = await apiFetch('/api/coaches');
                const coaches = result.data;
                populateCoaches(coaches);
                populateEditCoaches(coaches); // Remplir aussi le s√©lecteur de la modale
            } catch (error) {
                console.error("Erreur de chargement des coachs:", error);
                manualStatusDiv.textContent = "Erreur: Impossible de charger les coachs.";
                manualStatusDiv.style.color = 'red';
                coachSelector.innerHTML = '<option>Erreur de chargement</option>';
            }

            // Charger les exercices
            try {
                const result = await apiFetch('/api/exercices');
                Object.assign(allExercises, result.data);
                populateCategories();
                populateExercises();
            } catch (error) {
                console.error("Erreur de chargement des exercices:", error);
                manualStatusDiv.textContent = "Erreur: Impossible de charger les exercices.";
                manualStatusDiv.style.color = 'red';
            }

            // Charger les mod√®les de requ√™te
            try {
                const result = await apiFetch('/api/request-templates');
                const requestTemplates = result.data;
                populateRequestTemplates(requestTemplates);
            } catch (error) {
                console.error("Erreur de chargement des mod√®les de requ√™te:", error);
                // Pas critique, on ne met pas de message d'erreur global
                manualRequestTemplate.innerHTML = '<option>Erreur de chargement</option>';
            }
        };

        const populateCoaches = (coaches) => {
            coachSelector.innerHTML = '';
            coaches.forEach(coachName => {
                const option = document.createElement('option');
                option.value = coachName;
                option.textContent = coachName;
                coachSelector.appendChild(option);
            });
        };

        const populateEditCoaches = (coaches) => {
            editTaskCoachSelect.innerHTML = '';
            coaches.forEach(coachName => {
                const option = document.createElement('option');
                option.value = coachName;
                option.textContent = coachName;
                editTaskCoachSelect.appendChild(option);
            });
        };


        const populateRequestTemplates = (templates) => {
            const selectors = [manualRequestTemplate, scheduleRequestTemplate];
            selectors.forEach(selector => {
                selector.innerHTML = '<option value="">-- Choisir un mod√®le de requ√™te --</option>';
                for (const category in templates) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = category;
                    for (const name in templates[category]) {
                        const option = document.createElement('option');
                        option.value = templates[category][name];
                        option.textContent = name;
                        optgroup.appendChild(option);
                    }
                    selector.appendChild(optgroup);
                }
            });
        };

        const populateCategories = () => {
            categorySelector.innerHTML = '<option value="">-- Aucune --</option>';
            Object.keys(allExercises).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelector.appendChild(option);
            });
        };

        const populateExercises = () => {
            const selectedCategory = categorySelector.value;
            exerciseSelector.innerHTML = '';
            if (selectedCategory && allExercises[selectedCategory]) {
                allExercises[selectedCategory].forEach(exercise => {
                    const option = document.createElement('option');
                    option.value = exercise;
                    option.textContent = exercise;
                    exerciseSelector.appendChild(option);
                });
            }
        };

        const getTemplates = () => {
            const templates = localStorage.getItem(TEMPLATES_STORAGE_KEY);
            return templates ? JSON.parse(templates) : {};
        };

        const saveTemplates = (templates) => {
            localStorage.setItem(TEMPLATES_STORAGE_KEY, JSON.stringify(templates));
        };

        const loadTemplates = () => {
            const templates = getTemplates();
            templateSelector.innerHTML = '<option value="">-- S√©lectionner --</option>';
            Object.keys(templates).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                templateSelector.appendChild(option);
            });
        };

        saveTemplateBtn.addEventListener('click', () => {
            const name = templateNameInput.value.trim();
            const message = manualMessageTextarea.value.trim();
            if (!name || !message) {
                alert("Veuillez entrer un nom pour le mod√®le et un message.");
                return;
            }
            const templates = getTemplates();
            templates[name] = message;
            saveTemplates(templates);
            loadTemplates();
            templateNameInput.value = '';
            templateSelector.value = name; // S√©lectionne le nouveau mod√®le
        });

        templateSelector.addEventListener('change', () => {
            const name = templateSelector.value;
            const templates = getTemplates();
            manualMessageTextarea.value = templates[name] || '';
        });

        deleteTemplateBtn.addEventListener('click', () => {
            const name = templateSelector.value;
            if (!name) {
                alert("Veuillez s√©lectionner un mod√®le √† supprimer.");
                return;
            }
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer le mod√®le "${name}" ?`)) {
                const templates = getTemplates();
                delete templates[name];
                saveTemplates(templates);
                loadTemplates();
                manualMessageTextarea.value = '';
            }
        });

        manualRequestTemplate.addEventListener('change', (e) => {
            requestInput.value = e.target.value;
        });

        scheduleRequestTemplate.addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const templateName = selectedOption.textContent;
            const templateValue = e.target.value;

            scheduleRequestInput.value = templateValue;

            if (templateValue) { // Si un mod√®le est s√©lectionn√©
                schedulePrefixInput.value = templateName;
            } else {
                schedulePrefixInput.value = "Rappel Quotidien"; // R√©initialiser au d√©faut
            }
        });

        scheduleTriggerSelect.addEventListener('change', () => {
            scheduleTimeContainer.classList.toggle('hidden', scheduleTriggerSelect.value !== 'time');
        });

        scheduleDurationSelect.addEventListener('change', () => {
            customDateContainer.classList.toggle('hidden', scheduleDurationSelect.value !== 'custom');
        });

        const loadScheduledTasks = async (showStatus = false) => {
            try {
                const result = await apiFetch('/api/tasks/list');

                taskListDiv.innerHTML = '';
                if (result.tasks.length === 0) {
                    taskListDiv.innerHTML = '<p class="text-gray-500 italic">Aucune t√¢che planifi√©e dans le dossier "Monde Vivant".</p>';
                    return;
                }

                result.tasks.forEach(task => {
                    const taskElement = document.createElement('div');
                    taskElement.className = 'flex justify-between items-center p-2 bg-gray-800 rounded-md mb-2';
                    taskElement.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-200">${task.name}</p>
                            <p class="text-sm text-gray-400 mt-1">
                                <span>Proch. ex√©cution: ${task.next_run}</span>
                                <span class="ml-3">Coach: <strong>${task.coach || 'N/A'}</strong></span>
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button class="edit-task-btn bg-blue-600 text-white text-xs font-bold py-1 px-2 rounded hover:bg-blue-700" data-task-name="${task.name}" data-task-coach="${task.coach}" data-task-message="${task.message}" data-task-time="${task.next_run.split(' ')[1]}">Modifier</button>
                            <button class="delete-task-btn bg-red-600 text-white text-xs font-bold py-1 px-2 rounded hover:bg-red-700" data-task-name="${task.name}">Supprimer</button>
                        </div>
                    `;
                    taskListDiv.appendChild(taskElement);
                });

                if (showStatus) {
                    scheduleStatusDiv.textContent = "Liste des t√¢ches mise √† jour.";
                    scheduleStatusDiv.style.color = 'green';
                }
            } catch (error) {
                taskListDiv.innerHTML = `<p class="text-red-500 italic">Erreur de chargement des t√¢ches: ${error.message}</p>`;
            }
        };

        document.getElementById('task-list').addEventListener('click', async (e) => {
            if (e.target.closest('.delete-task-btn')) {
                const taskName = e.target.dataset.taskName;
                if (!confirm(`√ätes-vous s√ªr de vouloir supprimer la t√¢che "${taskName}" ?`)) return;

                try {
                    const result = await apiFetch('/api/delete-task', { method: 'POST', body: { taskName } });
                    
                    scheduleStatusDiv.textContent = result.message;
                    scheduleStatusDiv.style.color = 'green';
                    loadScheduledTasks();
                } catch (error) {
                    scheduleStatusDiv.textContent = `Erreur de suppression: ${error.message}`;
                    scheduleStatusDiv.style.color = 'red';
                }
            } else if (e.target.closest('.edit-task-btn')) {
                const btn = e.target.closest('.edit-task-btn');
                editTaskNameP.textContent = btn.dataset.taskName;
                editTaskTimeInput.value = btn.dataset.taskTime;
                editTaskCoachSelect.value = btn.dataset.taskCoach;
                editTaskMessageTextarea.value = btn.dataset.taskMessage;
                
                // Stocker le nom de la t√¢che pour la sauvegarde
                saveEditBtn.dataset.taskName = btn.dataset.taskName;
                editTaskModal.style.display = 'flex';
            }
        });

        categorySelector.addEventListener('change', populateExercises);

        generateManualBtn.addEventListener('click', async () => {
            const coach = coachSelector.value;
            const request = requestInput.value.trim();
            const selectedExercises = Array.from(exerciseSelector.selectedOptions).map(opt => opt.value);

            if (!request) {
                alert("Veuillez entrer une requ√™te pour la g√©n√©ration du message.");
                return;
            }

            generateManualBtn.disabled = true;
            generateManualBtn.textContent = 'G√©n√©ration IA...';
            manualStatusDiv.textContent = 'G√©n√©ration du message par l\'IA...';
            manualStatusDiv.style.color = 'gray';

            try {
                const result = await apiFetch('/api/generate-coach-message', {
                    method: 'POST',
                    body: { coach, request, activities: selectedExercises }
                });

                manualMessageTextarea.value = result.message.trim();
                manualMessageTextarea.focus();
                manualStatusDiv.textContent = 'Message g√©n√©r√© par l\'IA !';
                manualStatusDiv.style.color = 'green';
            } catch (error) {
                manualStatusDiv.textContent = `Erreur de g√©n√©ration : ${error.message}`;
                manualStatusDiv.style.color = 'red';
            } finally {
                generateManualBtn.disabled = false;
                generateManualBtn.textContent = 'G√©n√©rer et Ins√©rer';
            }
        });

        previewScheduleBtn.addEventListener('click', async () => {
            const request = scheduleRequestInput.value.trim();
            if (!request) {
                alert("Veuillez entrer une requ√™te pour le coach avant de pr√©visualiser.");
                return;
            }

            let endDate;
            const duration = scheduleDurationSelect.value;
            if (duration === 'custom') {
                if (!scheduleEndDateInput.value) {
                    alert("Veuillez s√©lectionner une date de fin.");
                    return;
                }
                endDate = scheduleEndDateInput.value;
            } else {
                const today = new Date();
                const futureDate = new Date(today);
                futureDate.setDate(today.getDate() + parseInt(duration));
                endDate = futureDate.toISOString().split('T')[0];
            }

            previewScheduleBtn.disabled = true;
            previewScheduleBtn.textContent = 'G√©n√©ration des messages...';
            scheduleStatusDiv.textContent = 'Appel √† l\'IA pour g√©n√©rer les messages de la s√©quence...';
            scheduleStatusDiv.style.color = 'gray';
            schedulePreviewContainer.innerHTML = '<p class="text-gray-500 italic text-center mt-4">G√©n√©ration en cours...</p>';
            confirmScheduleBtn.disabled = true;

            try {
                const result = await apiFetch('/api/preview-schedule', {
                    method: 'POST',
                    body: { request, endDate }
                });
                
                generatedSchedule = result.schedule; // Sauvegarde pour la confirmation
                schedulePreviewContainer.innerHTML = '';
                
                Object.entries(result.schedule).forEach(([date, item]) => {
                    const dateObj = new Date(date);
                    const formattedDate = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });

                    const messageElement = document.createElement('div');
                    messageElement.className = 'mb-3 p-2 bg-gray-800 rounded';
                    messageElement.innerHTML = `
                        <p class="text-sm font-bold text-indigo-400">${formattedDate}</p>
                        <p class="text-gray-300 text-sm mt-1"><span class="font-semibold">(${item.coach})</span> ${item.message}</p>
                    `;
                    schedulePreviewContainer.appendChild(messageElement);
                });

                scheduleStatusDiv.textContent = 'Pr√©visualisation pr√™te. V√©rifiez les messages et confirmez.';
                scheduleStatusDiv.style.color = 'green';
                confirmScheduleBtn.disabled = false;

            } catch (error) {
                scheduleStatusDiv.textContent = `Erreur de pr√©visualisation : ${error.message}`;
                scheduleStatusDiv.style.color = 'red';
                schedulePreviewContainer.innerHTML = `<p class="text-red-400 italic text-center mt-4">Erreur: ${error.message}</p>`;
            } finally {
                previewScheduleBtn.disabled = false;
                previewScheduleBtn.textContent = '2. Pr√©visualiser les messages';
            }
        });

        confirmScheduleBtn.addEventListener('click', async () => {
            if (!generatedSchedule) {
                alert("Veuillez d'abord pr√©visualiser les messages.");
                return;
            }

            const taskName = schedulePrefixInput.value.trim();
            const trigger = scheduleTriggerSelect.value;
            const time = trigger === 'time' ? scheduleTimeInput.value : null;

            confirmScheduleBtn.disabled = true;
            confirmScheduleBtn.textContent = 'Planification en cours...';
            scheduleStatusDiv.textContent = 'Cr√©ation des t√¢ches planifi√©es sur le serveur...';
            scheduleStatusDiv.style.color = 'gray';

            try {
                const result = await apiFetch('/api/confirm-schedule', {
                    method: 'POST',
                    body: { taskName, trigger, time, schedule: generatedSchedule }
                });

                scheduleStatusDiv.textContent = `Succ√®s : ${result.message}`;
                scheduleStatusDiv.style.color = 'green';
                loadScheduledTasks(true);
                schedulePreviewContainer.innerHTML = '<p class="text-gray-500 italic text-center mt-4">Planification termin√©e avec succ√®s.</p>';
                generatedSchedule = null;
            } catch (error) {
                scheduleStatusDiv.textContent = `Erreur de confirmation : ${error.message}`;
                scheduleStatusDiv.style.color = 'red';
            } finally {
                confirmScheduleBtn.textContent = 'Confirmer et Lancer la Planification';
            }
        });

        manualSendBtn.addEventListener('click', () => {
            const message = manualMessageTextarea.value;

            if (!message) {
                manualStatusDiv.textContent = 'Le message ne peut pas √™tre vide.';
                manualStatusDiv.style.color = 'red';
                return;
            }

            manualSendBtn.disabled = true;
            manualSendBtn.textContent = 'Envoi...';
            manualStatusDiv.textContent = 'Envoi en cours...';
            manualStatusDiv.style.color = 'gray';

            fetch('https://ntfy.sh/monde-vivant-note', {
                method: 'POST',
                body: message,
                headers: {
                    'Authorization': 'Bearer tk_7jtopqibezu9c8yz76gzacx8nvz34'
                }
            })
            .then(response => {
                if (response.ok) {
                    manualStatusDiv.textContent = 'Notification envoy√©e avec succ√®s !';
                    manualStatusDiv.style.color = 'green';
                    manualMessageTextarea.value = '';
                } else {
                    manualStatusDiv.textContent = 'Erreur lors de l\'envoi : ' + response.statusText;
                    manualStatusDiv.style.color = 'red';
                }
            })
            .catch(error => {
                manualStatusDiv.textContent = 'Erreur r√©seau : ' + error.message;
                manualStatusDiv.style.color = 'red';
            })
            .finally(() => {
                manualSendBtn.disabled = false;
                manualSendBtn.textContent = 'Envoyer la notification';
            });
        });

        // Logique de la modale de modification
        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
            editTaskModal.style.display = 'none';
        });

        saveEditBtn.addEventListener('click', async () => {
            const taskName = saveEditBtn.dataset.taskName;
            const body = {
                taskName: taskName,
                time: editTaskTimeInput.value,
                coach: editTaskCoachSelect.value,
                message: editTaskMessageTextarea.value
            };

            try {
                const result = await apiFetch('/api/update-task', { method: 'POST', body });
                scheduleStatusDiv.textContent = result.message;
                scheduleStatusDiv.style.color = 'green';
                editTaskModal.style.display = 'none';
                loadScheduledTasks(); // Recharger la liste pour voir les changements
            } catch (error) {
                scheduleStatusDiv.textContent = `Erreur de mise √† jour: ${error.message}`;
                scheduleStatusDiv.style.color = 'red';
            }
        });


        // Lancer l'initialisation
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
