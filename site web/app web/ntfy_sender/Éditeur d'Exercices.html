<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Éditeur d'Exercices</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto bg-white p-8 rounded-xl shadow-lg">
        <h1 class="text-4xl font-extrabold text-center mb-4 text-gray-800">Éditeur d'Exercices</h1>
        <p id="user-info" class="text-sm text-center text-gray-500 mb-6">Mode local - Données sauvegardées dans votre navigateur</p>

        <div class="grid md:grid-cols-2 gap-8">
            <!-- Colonne de gauche : Vue JSON -->
            <div class="flex flex-col h-full">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Votre JSON d'Exercices</h2>
                <div class="bg-gray-100 p-4 rounded-lg shadow-inner h-full overflow-y-auto relative">
                    <pre id="json-display" class="whitespace-pre-wrap text-sm text-gray-800"></pre>
                    <div id="loading-spinner" class="absolute inset-0 flex items-center justify-center bg-gray-100 bg-opacity-75" style="display: none;">
                        <svg class="animate-spin h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>
                <div class="flex gap-4 mt-4">
                    <button id="import-btn" class="flex-1 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200">
                        Importer un fichier .json
                    </button>
                    <button id="export-btn" class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200">
                        Exporter vers un fichier .json
                    </button>
                </div>
            </div>

            <!-- Colonne de droite : Formulaire d'injection massive et gestion des catégories -->
            <div class="flex flex-col h-full">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Gestion des Catégories & Exercices</h2>

                <!-- Champ d'ajout de nouvelle catégorie -->
                <div class="flex items-end gap-2 mb-4">
                    <div class="flex-1">
                        <label for="new-category-input" class="block text-sm font-medium text-gray-700 mb-1">Nom de la nouvelle catégorie</label>
                        <input type="text" id="new-category-input" placeholder="Ex: Favoris" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button id="add-category-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200">
                        Ajouter
                    </button>
                </div>

                <!-- Liste des catégories avec gestion de l'ordre -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sélectionner une catégorie</label>
                    <div id="category-list" class="flex flex-col gap-2 p-2 bg-gray-100 rounded-md max-h-48 overflow-y-auto">
                        <!-- Les éléments de catégorie seront injectés ici par JavaScript -->
                    </div>
                </div>

                <!-- Champ d'exercice avec autocomplétion -->
                <div class="relative mb-4">
                    <label for="exercice-input" class="block text-sm font-medium text-gray-700 mb-1">Exercice</label>
                    <input type="text" id="exercice-input" placeholder="Ex: Crunches - Avec Poids de cheville" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <ul id="autocomplete-list" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto" style="display: none;"></ul>
                </div>

                <!-- Bouton d'ajout -->
                <button id="add-exercise-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                    Ajouter l'exercice à la catégorie sélectionnée
                </button>

                <!-- Liste des exercices de la catégorie sélectionnée -->
                <div class="mt-8">
                    <h3 id="exercise-list-title" class="text-xl font-bold mb-2 text-gray-700" style="display: none;">Exercices dans la catégorie : <span id="selected-category-name" class="text-indigo-600"></span></h3>
                    <div id="exercise-list" class="flex flex-col gap-2 p-2 bg-gray-100 rounded-md max-h-48 overflow-y-auto">
                        <!-- Les éléments d'exercice seront injectés ici par JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Section pour l'éditeur de correspondance en masse -->
        <div class="mt-8 p-6 bg-gray-50 rounded-xl shadow-inner">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Éditeur de Correspondance en Masse</h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label for="bulk-categories" class="block text-sm font-medium text-gray-700 mb-1">Catégories (une par ligne)</label>
                    <textarea id="bulk-categories" rows="10" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Cardio
Cardio
Musculation"></textarea>
                </div>
                <div>
                    <label for="bulk-exercises" class="block text-sm font-medium text-gray-700 mb-1">Exercices (un par ligne)</label>
                    <textarea id="bulk-exercises" rows="10" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Course à pied
Vélo
Pompes"></textarea>
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button id="add-bulk-correspondence-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                    Ajouter les correspondances au JSON
                </button>
            </div>
        </div>
    </div>

    <!-- Modale de message (remplace alert) -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-80">
            <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
            <p id="modal-message" class="text-gray-700 mb-4"></p>
            <div class="flex justify-end">
                <button id="close-modal-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">OK</button>
            </div>
        </div>
    </div>

    <!-- Modale de confirmation -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-80">
            <h3 class="text-xl font-bold mb-2 text-red-600">Confirmation de Suppression</h3>
            <p id="confirm-message" class="text-gray-700 mb-4"></p>
            <div class="flex justify-end gap-2">
                <button id="cancel-confirm-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Annuler</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Modale de sélection de fichier -->
    <div id="file-select-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-96">
            <h3 id="file-select-title" class="text-xl font-bold mb-4">Sélectionner un fichier</h3>
            <div id="file-select-list" class="flex flex-col gap-2 max-h-64 overflow-y-auto mb-4">
                <!-- File list will be injected here -->
            </div>
            <div class="flex justify-end gap-2">
                <button id="cancel-file-select-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">Annuler</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Définition des données par défaut si le stockage local est vide
        const DEFAULT_EXERCISES = {
            "Sports Extérieurs": [ "Course à pied", "Vélo", "Randonnée", "Marche" ],
            "Fitness & Musculation": [ "Musculation", "Corde à sauter de boxe", "Corde à sauter lestée" ],
            "Autres": [ "Autres", "Sommeil" ]
        };

        // Clé pour le stockage local
        const LOCAL_STORAGE_KEY = 'user_exercises_data';

        let allExercises = {};
        let selectedCategoryName = null;
        let confirmAction = null;

        // Éléments du DOM
        const jsonDisplay = document.getElementById('json-display');
        const newCategoryInput = document.getElementById('new-category-input');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const categoryListDiv = document.getElementById('category-list');
        const exerciceInput = document.getElementById('exercice-input');
        const addExerciseBtn = document.getElementById('add-exercise-btn');
        const autocompleteList = document.getElementById('autocomplete-list');
        const loadingSpinner = document.getElementById('loading-spinner');
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelConfirmBtn = document.getElementById('cancel-confirm-btn');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const exerciseListDiv = document.getElementById('exercise-list');
        const exerciseListTitle = document.getElementById('exercise-list-title');
        const selectedCategoryNameSpan = document.getElementById('selected-category-name');
        const fileSelectModal = document.getElementById('file-select-modal');
        const fileSelectList = document.getElementById('file-select-list');
        const cancelFileSelectBtn = document.getElementById('cancel-file-select-btn');
        const bulkCategories = document.getElementById('bulk-categories');
        const bulkExercises = document.getElementById('bulk-exercises');
        const addBulkCorrespondenceBtn = document.getElementById('add-bulk-correspondence-btn');

        // Initialisation de l'application
        const initializeApp = () => {
            loadingSpinner.style.display = 'flex';
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                try {
                    allExercises = JSON.parse(storedData);
                } catch (e) {
                    console.error("Erreur de parsing des données locales, utilisation des données par défaut.", e);
                    allExercises = DEFAULT_EXERCISES;
                }
            } else {
                allExercises = DEFAULT_EXERCISES;
            }
            renderApp();
            loadingSpinner.style.display = 'none';
        };

        // Sauvegarder les données dans le stockage local
        const saveData = (data) => {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
            allExercises = data;
            renderApp();
        };

        // Afficher la modale de message
        const showMessageModal = (title, message) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.style.display = 'flex';
        };

        closeModalBtn.addEventListener('click', () => {
            messageModal.style.display = 'none';
        });

        // Afficher la modale de confirmation
        const showConfirmModal = (message, onConfirm) => {
            confirmMessage.textContent = message;
            confirmModal.style.display = 'flex';
            confirmAction = onConfirm;
        };

        confirmDeleteBtn.addEventListener('click', () => {
            if (confirmAction) {
                confirmAction();
            }
            confirmModal.style.display = 'none';
            confirmAction = null;
        });

        cancelConfirmBtn.addEventListener('click', () => {
            confirmModal.style.display = 'none';
            confirmAction = null;
        });

        // Rendu de l'application
        const renderApp = () => {
            // Afficher le JSON
            jsonDisplay.textContent = JSON.stringify(allExercises, null, 2);

            // Remplir la liste des catégories
            categoryListDiv.innerHTML = '';
            const categories = Object.keys(allExercises);
            if (!selectedCategoryName && categories.length > 0) {
                selectedCategoryName = categories[0];
            }

            categories.forEach((category) => {
                const isSelected = category === selectedCategoryName;
                const categoryItem = document.createElement('div');
                categoryItem.className = `category-item flex items-center justify-between p-2 rounded-md cursor-pointer transition duration-200 ${isSelected ? 'bg-indigo-100 text-indigo-800' : 'bg-white hover:bg-gray-200'}`;
                if (isSelected) {
                     categoryItem.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-2');
                }
                categoryItem.dataset.category = category;

                categoryItem.innerHTML = `
                    <span class="font-medium">${category}</span>
                    <div class="flex items-center gap-1">
                        <button class="move-up-btn p-1 rounded-full hover:bg-gray-300 transition duration-200" data-category="${category}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                            </svg>
                        </button>
                        <button class="move-down-btn p-1 rounded-full hover:bg-gray-300 transition duration-200" data-category="${category}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <button class="delete-category-btn p-1 rounded-full hover:bg-red-300 transition duration-200" data-category="${category}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                `;
                categoryListDiv.appendChild(categoryItem);
            });
            renderExercises();
        };

        const renderExercises = () => {
            exerciseListDiv.innerHTML = '';
            if (selectedCategoryName) {
                exerciseListTitle.style.display = 'block';
                selectedCategoryNameSpan.textContent = selectedCategoryName;
                const exercises = allExercises[selectedCategoryName] || [];
                if (exercises.length === 0) {
                    const message = document.createElement('p');
                    message.className = 'text-center text-gray-500 italic';
                    message.textContent = 'Aucun exercice dans cette catégorie.';
                    exerciseListDiv.appendChild(message);
                } else {
                    exercises.forEach((exercise, index) => {
                        const exerciseItem = document.createElement('div');
                        exerciseItem.className = 'p-2 rounded-md bg-white flex justify-between items-center transition duration-200 hover:bg-gray-200';
                        exerciseItem.innerHTML = `
                            <span class="flex-1">${exercise}</span>
                            <div class="flex items-center gap-1">
                                <button class="move-up-exercise-btn p-1 rounded-full hover:bg-gray-300 transition duration-200" data-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                    </svg>
                                </button>
                                <button class="move-down-exercise-btn p-1 rounded-full hover:bg-gray-300 transition duration-200" data-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <button class="delete-exercise-btn p-1 rounded-full hover:bg-red-300 transition duration-200" data-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        `;
                        exerciseListDiv.appendChild(exerciseItem);
                    });
                }
            } else {
                exerciseListTitle.style.display = 'none';
            }
        };

        // Gérer les clics sur la liste des catégories
        categoryListDiv.addEventListener('click', (e) => {
            const categoryItem = e.target.closest('.category-item');
            if (categoryItem) {
                const categoryName = categoryItem.dataset.category;
                selectedCategoryName = categoryName;
                document.querySelectorAll('.category-item').forEach(item => {
                    item.classList.remove('ring-2', 'ring-indigo-500', 'ring-offset-2', 'bg-indigo-100', 'text-indigo-800');
                    item.classList.add('bg-white', 'hover:bg-gray-200');
                });
                categoryItem.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-2', 'bg-indigo-100', 'text-indigo-800');
                categoryItem.classList.remove('bg-white', 'hover:bg-gray-200');
                renderExercises();
            }

            const btn = e.target.closest('button');
            if (!btn) return;
            const categoryToMove = btn.dataset.category;
            const categoriesArray = Object.keys(allExercises);
            const oldIndex = categoriesArray.indexOf(categoryToMove);
            if (oldIndex === -1) return;

            if (btn.classList.contains('move-up-btn')) {
                if (oldIndex > 0) {
                    const newOrder = {};
                    categoriesArray.splice(oldIndex, 1);
                    categoriesArray.splice(oldIndex - 1, 0, categoryToMove);
                    newOrder[categoryToMove] = allExercises[categoryToMove];
                    categoriesArray.forEach(key => {
                        newOrder[key] = allExercises[key];
                    });
                    saveData(newOrder);
                }
            } else if (btn.classList.contains('move-down-btn')) {
                if (oldIndex < categoriesArray.length - 1) {
                    const newOrder = {};
                    categoriesArray.splice(oldIndex, 1);
                    categoriesArray.splice(oldIndex + 1, 0, categoryToMove);
                    categoriesArray.forEach(key => {
                        newOrder[key] = allExercises[key];
                    });
                    saveData(newOrder);
                }
            } else if (btn.classList.contains('delete-category-btn')) {
                showConfirmModal(`Êtes-vous sûr de vouloir supprimer la catégorie "${categoryToMove}" et tous ses exercices ?`, () => {
                     const newData = { ...allExercises };
                     delete newData[categoryToMove];
                     selectedCategoryName = Object.keys(newData).length > 0 ? Object.keys(newData)[0] : null;
                     saveData(newData);
                });
            }
        });

        // Gérer les clics sur la liste des exercices
        exerciseListDiv.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn || !selectedCategoryName) return;
            const index = parseInt(btn.dataset.index);
            const exercises = [...allExercises[selectedCategoryName]];

            if (btn.classList.contains('delete-exercise-btn')) {
                showConfirmModal(`Êtes-vous sûr de vouloir supprimer l'exercice "${exercises[index]}" ?`, () => {
                    exercises.splice(index, 1);
                    const currentData = { ...allExercises, [selectedCategoryName]: exercises };
                    saveData(currentData);
                });
            } else if (btn.classList.contains('move-up-exercise-btn')) {
                if (index > 0) {
                    [exercises[index - 1], exercises[index]] = [exercises[index], exercises[index - 1]];
                    const currentData = { ...allExercises, [selectedCategoryName]: exercises };
                    saveData(currentData);
                }
            } else if (btn.classList.contains('move-down-exercise-btn')) {
                if (index < exercises.length - 1) {
                    [exercises[index + 1], exercises[index]] = [exercises[index], exercises[index + 1]];
                    const currentData = { ...allExercises, [selectedCategoryName]: exercises };
                    saveData(currentData);
                }
            }
        });

        // Gérer l'ajout d'une nouvelle catégorie
        addCategoryBtn.addEventListener('click', () => {
            const newCategoryName = newCategoryInput.value.trim();
            if (!newCategoryName) {
                showMessageModal("Erreur", "Veuillez entrer un nom pour la nouvelle catégorie.");
                return;
            }
            if (Object.keys(allExercises).includes(newCategoryName)) {
                showMessageModal("Erreur", "Cette catégorie existe déjà.");
                return;
            }

            const currentData = { [newCategoryName]: [], ...allExercises };
            saveData(currentData);
            newCategoryInput.value = '';
            selectedCategoryName = newCategoryName; // Sélectionner la nouvelle catégorie
        });


        // Gérer l'ajout d'un exercice
        addExerciseBtn.addEventListener('click', () => {
            if (!selectedCategoryName) {
                showMessageModal("Erreur", "Veuillez d'abord sélectionner une catégorie.");
                return;
            }
            const newExercise = exerciceInput.value.trim();
            if (!newExercise) {
                showMessageModal("Erreur", "Veuillez entrer le nom d'un exercice.");
                return;
            }

            const currentData = { ...allExercises };
            let exercisesArray = currentData[selectedCategoryName] || [];

            if (!exercisesArray.includes(newExercise)) {
                exercisesArray.push(newExercise);
                // Tri de l'array pour un meilleur affichage
                exercisesArray.sort();
                currentData[selectedCategoryName] = exercisesArray;
            }

            saveData(currentData);
            exerciceInput.value = '';
        });

        // Gérer l'autocomplétion
        exerciceInput.addEventListener('input', () => {
            const searchTerm = exerciceInput.value.toLowerCase();
            const allExerciceNames = Object.values(allExercises).flat();
            const matches = allExerciceNames.filter(name =>
                name.toLowerCase().includes(searchTerm)
            );

            autocompleteList.innerHTML = '';
            if (searchTerm.length > 0 && matches.length > 0) {
                matches.forEach(match => {
                    const li = document.createElement('li');
                    li.textContent = match;
                    li.classList.add('p-2', 'cursor-pointer', 'hover:bg-gray-200');
                    li.addEventListener('click', () => {
                        exerciceInput.value = match;
                        autocompleteList.style.display = 'none';
                    });
                    autocompleteList.appendChild(li);
                });
                autocompleteList.style.display = 'block';
            } else {
                autocompleteList.style.display = 'none';
            }
        });

        // Fermer l'autocomplétion si on clique en dehors
        document.addEventListener('click', (event) => {
            if (!exerciceInput.contains(event.target) && !autocompleteList.contains(event.target)) {
                autocompleteList.style.display = 'none';
            }
        });

        // Logique d'exportation
        exportBtn.addEventListener('click', async () => {
            const fileName = prompt("Entrez le nom du fichier pour l'exportation (ex: mes_exercices.json):", "exercices.json");
            if (fileName && fileName.trim() !== '') {
                if (!fileName.toLowerCase().endsWith('.json')) {
                    showMessageModal("Erreur", "Le nom du fichier doit se terminer par .json");
                    return;
                }
                try {
                    const response = await fetch(`/api/static/files/${fileName}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(allExercises),
                    });
                    const result = await response.json();
                    if (!response.ok || result.error) {
                        throw new Error(result.error || 'Failed to save file.');
                    }
                    showMessageModal("Succès", `Fichier "${fileName}" exporté avec succès dans le dossier static.`);
                } catch (error) {
                    console.error("Erreur d'exportation :", error);
                    showMessageModal("Erreur", `Impossible d'exporter le fichier : ${error.message}`);
                }
            }
        });

        // Logique d'importation
        importBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/static/files');
                if (!response.ok) {
                    throw new Error('Failed to fetch file list.');
                }
                const files = await response.json();
                
                fileSelectList.innerHTML = ''; // Clear previous list
                if (files.length === 0) {
                    fileSelectList.innerHTML = '<p class="text-gray-500">Aucun fichier JSON trouvé dans le dossier static.</p>';
                } else {
                    files.forEach(file => {
                        const fileItem = document.createElement('button');
                        fileItem.className = 'p-2 text-left rounded-md bg-gray-100 hover:bg-indigo-100 transition duration-200';
                        fileItem.textContent = file;
                        fileItem.addEventListener('click', async () => {
                            try {
                                const fileResponse = await fetch(`/api/static/files/${file}`);
                                if (!fileResponse.ok) {
                                    throw new Error(`Failed to load file: ${file}`);
                                }
                                const data = await fileResponse.json();
                                saveData(data);
                                showMessageModal("Succès", `Fichier "${file}" importé avec succès !`);
                                fileSelectModal.style.display = 'none';
                            } catch (error) {
                                console.error("Erreur de chargement du fichier :", error);
                                showMessageModal("Erreur", `Impossible de charger le fichier : ${error.message}`);
                            }
                        });
                        fileSelectList.appendChild(fileItem);
                    });
                }
                fileSelectModal.style.display = 'flex';
            } catch (error) {
                console.error("Erreur de listing des fichiers :", error);
                showMessageModal("Erreur", `Impossible de lister les fichiers : ${error.message}`);
            }
        });

        cancelFileSelectBtn.addEventListener('click', () => {
            fileSelectModal.style.display = 'none';
        });

        // Gérer l'ajout de correspondances en masse
        addBulkCorrespondenceBtn.addEventListener('click', () => {
            const categoriesText = bulkCategories.value.trim();
            const exercisesText = bulkExercises.value.trim();

            if (!categoriesText || !exercisesText) {
                showMessageModal("Erreur", "Veuillez remplir les deux zones de texte.");
                return;
            }

            const categories = categoriesText.split('\n');
            const exercises = exercisesText.split('\n');

            if (categories.length !== exercises.length) {
                showMessageModal("Erreur", "Le nombre de lignes dans les catégories et les exercices doit être le même.");
                return;
            }

            const currentData = { ...allExercises };
            let addedCount = 0;
            let lastCategory = "";

            for (let i = 0; i < exercises.length; i++) {
                let category = categories[i].trim();
                const exercise = exercises[i].trim();

                if (exercise === "") continue; // Skip empty exercise lines

                if (category === "") {
                    category = lastCategory; // Use the last valid category if the current one is empty
                }

                if (category === "") {
                    console.warn(`Skipping exercise "${exercise}" because no category is specified.`);
                    continue;
                }
                
                lastCategory = category;

                if (!currentData[category]) {
                    currentData[category] = [];
                }

                if (!currentData[category].includes(exercise)) {
                    currentData[category].push(exercise);
                    addedCount++;
                }
            }
            
            // Sort exercises within each category
            for (const category in currentData) {
                currentData[category].sort();
            }

            saveData(currentData);
            bulkCategories.value = '';
            bulkExercises.value = '';
            showMessageModal("Succès", `${addedCount} nouvelle(s) correspondance(s) ajoutée(s) avec succès.`);
        });

        // Lancer l'initialisation au chargement de la page
        initializeApp();
    </script>
</body>
</html>