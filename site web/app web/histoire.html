<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Histoire - Journal des Coachs</title>
  <style>
    :root {
      --bg-dark: #1a1a1a; --bg-light: #2c2c2c; --text-primary: #f0f0f0;
      --text-secondary: #a0a0a0; --accent: #4CAF50; --border-color: #444;
    }
    body {
      margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-dark); color: var(--text-primary); padding: 25px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    header { margin-bottom: 25px; }
    header h1 { font-size: 2.5em; margin: 0; }
    header p { color: var(--text-secondary); font-size: 1.1em; }
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      background-color: var(--bg-light);
      padding: 15px;
      border-radius: 8px;
    }
    .filters input, .filters select {
      flex-grow: 1;
      padding: 10px;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 1em;
    }
    .day-group {
      margin-bottom: 40px;
      border-left: 3px solid var(--border-color);
      padding-left: 25px;
    }
    .day-header {
      font-size: 1.8em;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 20px;
    }
    .log-entry {
      background-color: var(--bg-light);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
    }
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      color: var(--text-secondary);
      font-size: 0.9em;
    }
    .log-source { font-weight: bold; }
    .log-message {
      white-space: pre-wrap; /* Respecte les sauts de ligne */
      line-height: 1.6;
    }
    .log-message strong { color: var(--text-primary); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Journal des Coachs</h1>
      <p>Retrouvez ici l'historique de tous les messages générés par les coachs virtuels.</p>
    </header>

    <div class="filters">
      <input type="text" id="search-input" placeholder="Rechercher par mot-clé...">
      <select id="coach-filter"><option value="">Tous les coachs</option></select>
    </div>

    <div id="log-container">
      <!-- Le contenu du journal sera injecté ici -->
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const logContainer = document.getElementById('log-container');
      const searchInput = document.getElementById('search-input');
      const coachFilter = document.getElementById('coach-filter');
      let allLogs = [];

      try {
        const response = await fetch('/api/histoire');
        if (!response.ok) {
          throw new Error(`Erreur serveur: ${response.statusText}`);
        }
        const logs = await response.json();
        allLogs = logs;

        populateCoachFilter(allLogs);
        displayLogs(allLogs);

        searchInput.addEventListener('input', () => filterAndDisplay());
        coachFilter.addEventListener('change', () => filterAndDisplay());

      } catch (error) {
        console.error("Erreur de chargement du journal:", error);
        logContainer.innerHTML = `<p style="color: red;">Impossible de charger le journal des coachs. ${error.message}</p>`;
      }

      function populateCoachFilter(logs) {
        const coaches = [...new Set(logs.map(log => log.coach))].sort();
        coaches.forEach(coach => {
          const option = document.createElement('option');
          option.value = coach;
          option.textContent = coach;
          coachFilter.appendChild(option);
        });
      }

      function filterAndDisplay() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedCoach = coachFilter.value;

        const filteredLogs = allLogs.filter(log => {
          const matchSearch = searchTerm === '' || log.message.toLowerCase().includes(searchTerm) || log.source.toLowerCase().includes(searchTerm);
          const matchCoach = selectedCoach === '' || log.coach === selectedCoach;
          return matchSearch && matchCoach;
        });

        displayLogs(filteredLogs);
      }

      function displayLogs(logsToDisplay) {
        logContainer.innerHTML = ''; // Vider le conteneur
        if (logsToDisplay.length === 0) {
          logContainer.innerHTML = '<p>Le journal est encore vide. Aucune interaction avec les coachs n\'a été enregistrée.</p>';
          return;
        }
        const logsByDate = logsToDisplay.reduce((acc, log) => {
          const date = log.date;
          if (!acc[date]) {
            acc[date] = [];
          }
          acc[date].push(log);
          return acc;
        }, {});

        Object.keys(logsByDate).sort().reverse().forEach(date => {
          const dayGroup = document.createElement('div');
          dayGroup.className = 'day-group';

          const dayHeader = document.createElement('h2');
          const dateObj = new Date(date);
          // Ajout pour gérer le décalage de fuseau horaire et afficher la bonne date
          dateObj.setMinutes(dateObj.getMinutes() + dateObj.getTimezoneOffset());
          dayHeader.textContent = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
          dayHeader.className = 'day-header';
          dayGroup.appendChild(dayHeader);

          logsByDate[date].forEach(log => {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'log-entry';

            const messageContent = `<strong>(${log.coach})</strong> ${log.message}`;

            entryDiv.innerHTML = `
              <div class="log-header">
                <span class="log-source">${log.source}</span>
                <span class="log-time">${log.time}</span>
              </div>
              <div class="log-message">${messageContent}</div>
            `;
            dayGroup.appendChild(entryDiv);
          });

          logContainer.appendChild(dayGroup);
        });
      }
    });
  </script>
</body>
</html>