<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration des Notifications</title>
    <style>
        :root {
            --bg-dark: #1a1a1a;
            --bg-light: #2c2c2c;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --accent: #4CAF50;
            --border-color: #444;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            padding: 20px;
            max-width: 600px;
            margin: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        h1 {
            margin-bottom: 0;
        }
        .config-section {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex; flex-direction: column; gap: 15px;
        }
        h2 {
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        label {
            font-weight: bold;
            color: var(--text-secondary);
        }
        input[type="number"], input[type="checkbox"] {
            margin-left: 10px;
        }
        input[type="number"] {
            width: 60px;
            padding: 5px;
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 4px;
        }
        button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button[type="submit"]:hover {
            background-color: #5bc060;
        }
        #save-status {
            margin-top: 15px;
            color: var(--accent);
            text-align: center;
        }
        button[type="button"] {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
        }
        button[type="button"]:hover {
            background-color: #383838;
        }
        form {
            display: contents; /* Permet au formulaire de ne pas ajouter de niveau dans le DOM pour flexbox */
        }
    </style>
</head>
<body>

    <h1>Configuration des Notifications</h1>

    <form id="config-form">
        <div class="config-section">
            <h2>Objectifs d'Activit√©</h2>
            <div class="form-group">
                <label for="objectifs-enabled">Activer les notifications</label>
                <input type="checkbox" id="objectifs-enabled" name="objectifs-enabled">
            </div>
            <div class="form-group">
                <label for="objectifs-threshold">Notifier apr√®s (jours)</label>
                <input type="number" id="objectifs-threshold" name="objectifs-threshold" min="1">
            </div>
            <div class="form-group">
                <label for="objectifs-llm">Utiliser les messages IA</label>
                <input type="checkbox" id="objectifs-llm" name="objectifs-llm">
            </div>
        </div>

        <div class="config-section">
            <h2>Suivi de la Glyc√©mie</h2>
            <div class="form-group">
                <label for="glycemie-enabled">Activer les notifications</label>
                <input type="checkbox" id="glycemie-enabled" name="glycemie-enabled">
            </div>
            <div class="form-group">
                <label for="glycemie-threshold">Notifier apr√®s (jours)</label>
                <input type="number" id="glycemie-threshold" name="glycemie-threshold" min="1">
            </div>
            <div class="form-group">
                <label for="glycemie-llm">Utiliser les messages IA</label>
                <input type="checkbox" id="glycemie-llm" name="glycemie-llm">
            </div>
        </div>

         <div class="config-section">
            <h2>Suivi du Poids (lb)</h2>
            <div class="form-group">
                <label for="poids-enabled">Activer les notifications</label>
                <input type="checkbox" id="poids-enabled" name="poids-enabled">
            </div>
            <div class="form-group">
                <label for="poids-threshold">Notifier apr√®s (jours)</label>
                <input type="number" id="poids-threshold" name="poids-threshold" min="1">
            </div>
            <div class="form-group">
                <label for="poids-llm">Utiliser les messages IA</label>
                <input type="checkbox" id="poids-llm" name="poids-llm">
            </div>
        </div>

         <div class="config-section">
            <h2>Suivi du Ventre (cm)</h2>
            <div class="form-group">
                <label for="ventre-enabled">Activer les notifications</label>
                <input type="checkbox" id="ventre-enabled" name="ventre-enabled">
            </div>
            <div class="form-group">
                <label for="ventre-threshold">Notifier apr√®s (jours)</label>
                <input type="number" id="ventre-threshold" name="ventre-threshold" min="1">
            </div>
            <div class="form-group">
                <label for="ventre-llm">Utiliser les messages IA</label>
                <input type="checkbox" id="ventre-llm" name="ventre-llm">
            </div>
        </div>

        <div class="config-section">
            <h2>Objectifs Cibles</h2>
            <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: -10px;">
                D√©finissez ici les valeurs cibles utilis√©es dans les tableaux de bord (accueil, historique, etc.).
            </p>
            <div class="form-group">
                <label for="goals-target-calories">üî• Cible Calories</label>
                <input type="number" id="goals-target-calories" name="goals-target-calories" min="1">
            </div>
            <div class="form-group">
                <label for="goals-target-steps">üëü Cible Pas</label>
                <input type="number" id="goals-target-steps" name="goals-target-steps" min="1">
            </div>
            <div class="form-group">
                <label for="goals-target-distance">üìè Cible Distance (km)</label>
                <input type="number" id="goals-target-distance" name="goals-target-distance" min="0.1" step="0.1">
            </div>
        </div>

        <div class="config-section">
            <h2>Actions</h2>
            <p style="color: var(--text-secondary); font-size: 0.9em;">
                G√©n√©rez manuellement les notifications IA pour la journ√©e. Cela mettra en cache les messages pour √©viter de surcharger l'API.
            </p>
            <button type="button" id="generate-llm-btn">G√©n√©rer les notifications IA</button>
            <p id="generate-status" style="margin-top: 10px;"></p>
        </div>

        <div class="config-section">
            <h2>G√©n√©ration au D√©marrage</h2>
            <p style="color: var(--text-secondary); font-size: 0.9em;">
                Activez cette option pour que les notifications du jour soient automatiquement g√©n√©r√©es en arri√®re-plan √† chaque d√©marrage de votre ordinateur.
            </p>
            <div class="button-group" style="justify-content: space-around;">
                 <button type="button" id="enable-startup-btn" style="background-color: #3a5f8a;">Activer au D√©marrage</button>
                 <button type="button" id="disable-startup-btn" style="background-color: #8a3a3a;">D√©sactiver</button>
            </div>
            <p id="startup-status" style="margin-top: 10px; text-align: center;"></p>
        </div>


        <button type="submit">Sauvegarder les changements</button>
    </form>
    
    <p id="save-status"></p>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('config-form');
            const statusEl = document.getElementById('save-status');
            const generateBtn = document.getElementById('generate-llm-btn');
            const enableStartupBtn = document.getElementById('enable-startup-btn');
            const disableStartupBtn = document.getElementById('disable-startup-btn');

            // --- Load initial config ---
            fetch('/api/notifications/config')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(config => {
                    // Populate Objectifs
                    document.getElementById('objectifs-enabled').checked = config.objectifs.enabled;
                    document.getElementById('objectifs-threshold').value = config.objectifs.days_threshold;
                    document.getElementById('objectifs-llm').checked = config.objectifs.use_llm;
                    // Populate Glycemie
                    document.getElementById('glycemie-enabled').checked = config.glycemie.enabled;
                    document.getElementById('glycemie-threshold').value = config.glycemie.days_threshold;
                    document.getElementById('glycemie-llm').checked = config.glycemie.use_llm;
                    // Populate Poids
                    document.getElementById('poids-enabled').checked = config.poids?.enabled ?? false;
                    document.getElementById('poids-threshold').value = config.poids?.days_threshold ?? 3;
                    document.getElementById('poids-llm').checked = config.poids?.use_llm ?? false;
                    // Populate Ventre
                    document.getElementById('ventre-enabled').checked = config.ventre?.enabled ?? false;
                    document.getElementById('ventre-threshold').value = config.ventre?.days_threshold ?? 3;
                    document.getElementById('ventre-llm').checked = config.ventre?.use_llm ?? false;
                    // Populate Objectifs Cibles
                    document.getElementById('goals-target-calories').value = config.targets?.calories || 500;
                    document.getElementById('goals-target-steps').value = config.targets?.steps || 8000;
                    document.getElementById('goals-target-distance').value = config.targets?.distance || 5.0;
                })
                .catch(error => {
                    statusEl.textContent = "Erreur: Impossible de charger la configuration.";
                    console.error('Error loading config:', error);
                });

            // --- Save config on submit ---
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                statusEl.textContent = 'Sauvegarde...';

                const newConfig = {
                    objectifs: {
                        enabled: document.getElementById('objectifs-enabled').checked,
                        days_threshold: parseInt(document.getElementById('objectifs-threshold').value, 10),
                        use_llm: document.getElementById('objectifs-llm').checked
                    },
                    glycemie: {
                        enabled: document.getElementById('glycemie-enabled').checked,
                        days_threshold: parseInt(document.getElementById('glycemie-threshold').value, 10),
                        use_llm: document.getElementById('glycemie-llm').checked
                    },
                    poids: {
                        enabled: document.getElementById('poids-enabled').checked,
                        days_threshold: parseInt(document.getElementById('poids-threshold').value, 10),
                        use_llm: document.getElementById('poids-llm').checked
                    },
                    ventre: {
                        enabled: document.getElementById('ventre-enabled').checked,
                        days_threshold: parseInt(document.getElementById('ventre-threshold').value, 10),
                        use_llm: document.getElementById('ventre-llm').checked
                    },
                    targets: {
                        calories: parseInt(document.getElementById('goals-target-calories').value, 10),
                        steps: parseInt(document.getElementById('goals-target-steps').value, 10),
                        distance: parseFloat(document.getElementById('goals-target-distance').value)
                    }
                };

                fetch('/api/notifications/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newConfig),
                })
                .then(response => {
                    if (!response.ok) throw new Error('Server responded with an error');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        statusEl.textContent = 'Configuration sauvegard√©e avec succ√®s !';
                    } else {
                        statusEl.textContent = `Erreur: ${data.error}`;
                    }
                })
                .catch(error => {
                    statusEl.textContent = 'Erreur de communication avec le serveur.';
                    console.error('Error saving config:', error);
                });
            });

            // --- Generate LLM notifications on button click ---
            generateBtn.addEventListener('click', () => {
                const generateStatusEl = document.getElementById('generate-status');
                
                // Disable button to prevent spamming
                generateBtn.disabled = true;
                generateBtn.textContent = 'G√©n√©ration en cours...';
                generateStatusEl.textContent = 'G√©n√©ration en cours...';
                generateStatusEl.style.color = 'var(--text-secondary)';
                
                // Start the cooldown timer immediately
                setTimeout(() => {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'G√©n√©rer les notifications IA';
                }, 20000); // 20 seconds cooldown

                fetch('/api/notifications/generate', { method: 'POST' })
                    .then(response => {
                        if (!response.ok) throw new Error('Server responded with an error');
                        return response.json();
                    })
                    .then(data => {
                        generateStatusEl.textContent = data.message || 'Op√©ration termin√©e.';
                        generateStatusEl.style.color = 'var(--accent)';
                    })
                    .catch(error => {
                        generateStatusEl.textContent = 'Erreur lors de la g√©n√©ration.';
                        generateStatusEl.style.color = 'red';
                        console.error('Error generating notifications:', error);
                    })
                    .finally(() => {
                        // We don't re-enable the button immediately here, 
                        // the timeout handles the cooldown.
                    });
            });

            // --- Startup Task Scheduling ---
            const handleStartupTask = (enable) => {
                const startupStatusEl = document.getElementById('startup-status');
                startupStatusEl.textContent = 'Mise √† jour de la t√¢che planifi√©e...';
                startupStatusEl.style.color = 'var(--text-secondary)';

                fetch('/api/schedule-startup-notifications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enable: enable })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        startupStatusEl.textContent = data.message;
                        startupStatusEl.style.color = 'var(--accent)';
                    } else {
                        throw new Error(data.error);
                    }
                })
                .catch(err => {
                    startupStatusEl.textContent = `Erreur: ${err.message}`;
                    startupStatusEl.style.color = 'red';
                });
            };

            enableStartupBtn.addEventListener('click', () => handleStartupTask(true));
            disableStartupBtn.addEventListener('click', () => handleStartupTask(false));
        });
    </script>

</body>
</html>
