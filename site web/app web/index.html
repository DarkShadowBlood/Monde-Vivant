<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monde Vivant - Tableau de Bord</title>
  <style>
    :root {
      --bg-dark: #202123;
      --bg-light: #343541;
      --text-primary: #ffffff;
      --text-secondary: #b4b4b4;
      --accent: #10a37f;
      --border-color: #4d4d4d;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* --- Sidebar --- */
    #sidebar {
      width: 80px; /* Collapsed width */
      background-color: var(--bg-dark);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: width 0.3s ease;
      position: fixed;
      height: 100%;
      z-index: 100;
      overflow-x: hidden;
    }
    #sidebar.expanded {
      width: 260px; /* Expanded width */
    }

    #sidebar-nav {
      padding: 10px;
      flex-grow: 1;
      overflow-y: auto;
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      margin-bottom: 8px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 1em;
      transition: background-color 0.2s;
      white-space: nowrap;
      overflow: hidden;
    }
    .nav-link:hover {
      background-color: var(--bg-light);
      color: var(--text-primary);
    }
    .nav-link.active {
      background-color: var(--accent);
      color: #fff;
    }
    .nav-icon {
      font-size: 1.5em;
      width: 50px; /* Fixed width for icon alignment */
      text-align: center;
      margin-right: 10px;
    }
    .nav-text {
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    #sidebar.expanded .nav-text {
      opacity: 1;
    }
    
    .nav-group-title {
      padding: 15px 20px 5px 20px;
      font-size: 0.75em;
      font-weight: bold;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      white-space: nowrap;
      overflow: hidden;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
     #sidebar.expanded .nav-group-title {
      opacity: 1;
    }

    #sidebar-footer {
      padding: 10px;
      border-top: 1px solid var(--border-color);
    }

    /* --- Main Content --- */
    #main-content {
      flex-grow: 1;
      height: 100vh;
      margin-left: 80px; /* Match collapsed sidebar width */
      transition: margin-left 0.3s ease;
    }
    #sidebar.expanded ~ #main-content {
      margin-left: 260px; /* Match expanded sidebar width */
    }
    #content-frame {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* --- Explorer Mode --- */
    #sidebar.explorer-open {
      width: 320px;
    }
    #sidebar.explorer-open.expanded {
        width: 450px;
    }
    #sidebar.explorer-open ~ #main-content {
      margin-left: 320px;
    }
    #sidebar.explorer-open.expanded ~ #main-content {
      margin-left: 450px;
    }
    #sidebar.explorer-open #sidebar-nav { display: none; }
    #sidebar.explorer-open #explorer-content { display: block; height: calc(100% - 120px); }
    #sidebar:not(.explorer-open) #explorer-content { display: none; }
    #sidebar.explorer-open .nav-text {
       opacity: 1;
    }

    /* --- Floating Button & Notification Panel --- */
    .ntfy-fab {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background-color: var(--accent);
        color: white;
        width: 64px;
        height: 64px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transition: transform 0.2s ease-in-out, background-color 0.2s;
    }
    .ntfy-fab:hover {
        background-color: #10a37f;
        filter: brightness(1.2);
        transform: scale(1.1);
    }
    
    /* --- Notification Center --- */
    #notification-bell .nav-icon {
      position: relative;
    }
    .badge {
      position: absolute;
      top: -2px;
      right: 5px;
      background-color: #d93025;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 0.7em;
      font-weight: bold;
    }
    #notification-panel {
      position: fixed;
      bottom: 130px; /* Adjust based on footer height */
      left: 85px;
      width: 350px;
      background-color: var(--bg-light);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      z-index: 1000;
      color: var(--text-primary);
      transition: left 0.3s ease;
    }
    #sidebar.expanded #notification-panel {
        left: 265px;
    }
    .panel-item {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.9em;
    }
    .panel-item:last-child {
      border-bottom: none;
    }
    .panel-item.warning {
      background-color: #614a19;
    }
    .panel-item.info {
       background-color: #194d61;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <nav id="sidebar-nav">
      <div class="nav-group">
        <div class="nav-group-title">Analyse</div>
        <a href="welcome.html" class="nav-link active" target="contenu_principal" title="Accueil">
          <span class="nav-icon">üè†</span>
          <span class="nav-text">Accueil</span>
        </a>
        <a href="historique_objectifs/index.html" class="nav-link" target="contenu_principal" title="Historique">
          <span class="nav-icon">üìä</span>
          <span class="nav-text">Historique</span>
        </a>
        <a href="histoire.html" class="nav-link" target="contenu_principal" title="Histoire">
          <span class="nav-icon">üìú</span>
          <span class="nav-text">Histoire</span>
        </a>
        <a href="analyse_llm.html" class="nav-link" target="contenu_principal" title="Analyse LLM">
          <span class="nav-icon">ü§ñ</span>
          <span class="nav-text">Coach Virtuel</span>
        </a>
      </div>

      <div class="nav-group">
        <div class="nav-group-title">Sant√©</div>
        <a href="sante_saisie_masse.html" class="nav-link" target="contenu_principal" title="Saisie & Modification Sant√©">
          <span class="nav-icon">‚ù§Ô∏è‚Äçü©π</span>
          <span class="nav-text">Saisie & Modif.</span>
        </a>
        
        <a href="sante_stats/index.html" class="nav-link" target="contenu_principal" title="Statistiques Sant√©">
          <span class="nav-icon">üìà</span>
          <span class="nav-text">Stats Sant√©</span>
        </a>
      </div>

      <div class="nav-group">
        <div class="nav-group-title">Outils</div>
        <a href="plan_entrainement.html" class="nav-link" target="contenu_principal" title="G√©n√©rateur de Plan">
          <span class="nav-icon">üìÖ</span>
          <span class="nav-text">G√©n√©rateur de Plan</span>
        </a>
        <a href="notifications_config.html" class="nav-link" target="contenu_principal" title="Configuration Notifications">
          <span class="nav-icon">‚öôÔ∏è</span>
          <span class="nav-text">R√©glages Notifs</span>
        </a>
      </div>

      <div class="nav-group">
        <div class="nav-group-title">Gamification</div>
        <a href="#" class="nav-link" target="contenu_principal" title="Profil">
          <span class="nav-icon">üë§</span>
          <span class="nav-text">Profil</span>
        </a>
        <a href="#" class="nav-link" target="contenu_principal" title="Inventaire">
          <span class="nav-icon">üéí</span>
          <span class="nav-text">Inventaire</span>
        </a>
      </div>
    </nav>
    <div id="explorer-content">
      <iframe src="liens.html" style="width: 100%; height: 100%; border: none;"></iframe>
    </div>
    <div id="sidebar-footer">
        <a href="#" id="explorer-toggle-btn" class="nav-link" title="Explorateur">
            <span class="nav-icon">üóÇÔ∏è</span>
            <span class="nav-text">Explorateur</span>
        </a>
        <a href="javascript:void(0);" id="notification-bell" class="nav-link" title="Notifications">
            <span class="nav-icon">
              <span id="notification-badge" class="badge" style="display:none;"></span>
              üîî
            </span>
            <span class="nav-text">Notifications</span>
        </a>
        <div id="notification-panel" class="panel" style="display:none;">
            <!-- Notifications will be injected here -->
        </div>
        <a href="#" id="sidebar-toggle-btn" class="nav-link" title="R√©duire la barre">
            <span class="nav-icon">‚ÜîÔ∏è</span>
            <span class="nav-text">R√©duire</span>
        </a>
    </div>
  </div>

  <div id="main-content">
    <iframe id="content-frame" name="contenu_principal" src="welcome.html"></iframe>
  </div>

  <!-- Bouton flottant pour l'exp√©diteur de notifications Ntfy -->
  <a href="ntfy_sender/ntfy_sender.html" target="_blank" title="Envoyer une notification coach√©e" class="ntfy-fab">
    <svg xmlns="http://www.w3.org/2000/svg" style="height: 32px; width: 32px;" viewBox="0 0 20 20" fill="currentColor">
        <path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15h14a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" />
    </svg>
  </a>

  <script>
    const sidebar = document.getElementById('sidebar');
    const explorerToggleBtn = document.getElementById('explorer-toggle-btn');
    const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
    const mainNavLinks = document.querySelectorAll('#sidebar-nav .nav-link');

    // G√®re le clic sur les liens de navigation principaux
    mainNavLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        mainNavLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        sidebar.classList.remove('explorer-open'); // Ferme l'explorateur si on clique sur un lien principal
      });
    });

    // G√®re l'ouverture/fermeture de l'explorateur
    explorerToggleBtn.addEventListener('click', (e) => {
      e.preventDefault();
      sidebar.classList.toggle('explorer-open');
    });

    // G√®re le redimensionnement de la sidebar
    sidebarToggleBtn.addEventListener('click', (e) => {
        e.preventDefault();
        sidebar.classList.toggle('expanded');
    });

    // --- Notification Center Logic ---
    const notificationBell = document.getElementById('notification-bell');
    const notificationBadge = document.getElementById('notification-badge');
    const notificationPanel = document.getElementById('notification-panel');

    function fetchNotifications() {
      fetch('/api/notifications')
        .then(response => response.json())
        .then(notifications => {
          notificationPanel.innerHTML = ''; // Clear previous
          if (notifications.length > 0) {
            notificationBadge.textContent = notifications.length;
            notificationBadge.style.display = 'block';
            
            notifications.forEach(notif => {
              const item = document.createElement('div');

              // G√©rer les deux formats de notification possibles
              if (notif.notification) {
                // Format riche (g√©n√©r√© par l'IA)
                item.classList.add('panel-item', notif.notification.type);
                const source = notif.source ? `(${notif.source}) ` : '';
                const days = notif.days_since ? `(J-${notif.days_since}) ` : '';
                const coach = notif.notification.coach ? `[${notif.notification.coach}] ` : '';
                item.textContent = `${coach}${source}${days}${notif.notification.message}`;
              } else {
                // Format simple (rappel de base)
                item.classList.add('panel-item', notif.type);
                item.textContent = notif.message;
              }

              notificationPanel.appendChild(item);
            });
          } else {
            notificationBadge.style.display = 'none';
            const item = document.createElement('div');
            item.classList.add('panel-item');
            item.textContent = "Aucune nouvelle notification.";
            notificationPanel.appendChild(item);
          }
        })
        .catch(error => {
          console.error('Erreur lors de la r√©cup√©ration des notifications:', error);
          notificationPanel.innerHTML = '<div class="panel-item">Erreur de chargement.</div>';
        });
    }

    notificationBell.addEventListener('click', (e) => {
      e.preventDefault();
      const isPanelVisible = notificationPanel.style.display === 'block';
      notificationPanel.style.display = isPanelVisible ? 'none' : 'block';
    });

    // Fetch notifications when the script runs
    fetchNotifications();
  </script>
</body>
</html>