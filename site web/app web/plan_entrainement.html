<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>G√©n√©rateur de Plan - Monde Vivant</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css">
  <style>
    :root {
      --bg-dark: #1a1a1a; --bg-light: #2c2c2c; --text-primary: #f0f0f0;
      --text-secondary: #a0a0a0; --accent: #4CAF50; --border-color: #444;
      --code-bg: #111;
    }
    body {
      margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-dark); color: var(--text-primary); padding: 25px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    header { margin-bottom: 25px; }
    header h1 { font-size: 2.5em; margin: 0; }
    header p { color: var(--text-secondary); font-size: 1.1em; }
    .panel {
      background-color: var(--bg-light); padding: 20px; border-radius: 12px;
      border: 1px solid var(--border-color); margin-bottom: 30px;
      display: flex; flex-direction: column; gap: 20px;
    }
    .panel label { font-weight: bold; color: var(--text-secondary); display: block; margin-bottom: 8px; }
    .panel input, .panel textarea, .panel select {
      width: 100%; padding: 10px; background-color: var(--bg-dark);
      color: var(--text-primary); border: 1px solid var(--border-color);
      border-radius: 8px; font-size: 1em; box-sizing: border-box;
    }
    .panel textarea { min-height: 100px; resize: vertical; }
    .date-picker-group { display: flex; gap: 15px; align-items: center; }
    .button-group { display: flex; gap: 10px; justify-content: flex-end; }
    button {
      background-color: var(--accent); color: #fff; border: none; padding: 10px 20px;
      border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold;
      transition: background-color 0.2s;
    }
    button:hover { background-color: #45a049; }
    button:disabled { background-color: #555; cursor: not-allowed; }
    pre {
      background-color: var(--code-bg); color: var(--text-secondary); padding: 15px;
      border-radius: 8px; min-height: 120px; white-space: pre-wrap;
      word-wrap: break-word; font-size: 0.9em; font-family: 'Courier New', Courier, monospace;
    }
    .spinner {
      display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Styles pour la librairie de calendrier */
    .datepicker { border-radius: 8px; background-color: var(--bg-light); border: 1px solid var(--border-color); }
    .datepicker-picker { color: var(--text-primary); }
    .datepicker-header .datepicker-title { color: var(--accent); }
    .datepicker-cell.selected, .datepicker-cell.selected:hover { background-color: var(--accent); }
    .datepicker-cell:not(.disabled):hover { background-color: #444; }

    /* Styles pour le rendu Markdown */
    .markdown-body {
      background-color: #1d2c1d;
      padding: 15px 25px;
      border-radius: 8px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 1em;
      line-height: 1.6;
      color: var(--text-secondary);
    }
    .markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4 {
      color: var(--accent);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
      margin-top: 24px;
      margin-bottom: 16px;
    }
    .markdown-body p { margin-bottom: 16px; }
    .markdown-body ul, .markdown-body ol { padding-left: 25px; }
    .markdown-body li { margin-bottom: 8px; }
    .markdown-body code {
      background-color: var(--code-bg);
      padding: 2px 5px;
      border-radius: 4px;
      font-family: 'Courier New', Courier, monospace;
    }
    .markdown-body strong { color: var(--text-primary); font-weight: 600; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>G√©n√©rateur de Plan d'Entra√Ænement</h1>
      <p>D√©finissez une p√©riode d'analyse et un objectif pour que le coach virtuel cr√©e votre prochain plan.</p>
    </header>

    <div class="panel">
      <div>
        <label>1. P√©riode d'analyse de l'historique</label>
        <div class="date-picker-group">
          <input type="text" id="start-date" placeholder="Date de d√©but">
          <span>√†</span>
          <input type="text" id="end-date" placeholder="Date de fin">
        </div>
      </div>
      <div>
        <label for="objective">2. Votre objectif pour le prochain plan</label>
        <textarea id="objective" placeholder="Ex: Je veux un plan sur 4 jours pour la semaine prochaine, ax√© sur l'am√©lioration de mon endurance et la perte de poids."></textarea>
      </div>
      <div class="button-group">
        <button id="generate-plan-btn">G√©n√©rer le Plan</button>
        <button id="save-prompt-btn" style="display: none; background-color: #3a5f8a;">üíæ Sauvegarder le Prompt</button>
      </div>
    </div>

    <div class="panel" id="result-panel" style="display: none;">
      <div>
        <label>Statut de la g√©n√©ration</label>
        <pre id="status-console"></pre>
      </div>
      <div>
        <label>Plan d'entra√Ænement g√©n√©r√©</label>
        <div id="plan-output" class="markdown-body"></div>
      </div>
      <div class="button-group" style="justify-content: flex-end;">
        <!-- Le bouton pour ouvrir le plan appara√Ætra ici apr√®s la sauvegarde -->
        <button id="open-plan-btn" style="display: none;">üöÄ Ouvrir le Plan</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/locales/fr.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- √âl√©ments du DOM ---
      const startDateInput = document.getElementById('start-date');
      const endDateInput = document.getElementById('end-date');
      const objectiveInput = document.getElementById('objective');
      const generateBtn = document.getElementById('generate-plan-btn');
      const resultPanel = document.getElementById('result-panel');
      const statusConsole = document.getElementById('status-console');
      const planOutput = document.getElementById('plan-output');
      const savePromptBtn = document.getElementById('save-prompt-btn');
      const openPlanBtn = document.getElementById('open-plan-btn');

      // --- Initialisation des Date Pickers ---
      const datepickerOptions = {
        format: 'yyyy-mm-dd', language: 'fr', autohide: true, todayHighlight: true,
      };
      const startDatepicker = new Datepicker(startDateInput, datepickerOptions);
      const endDatepicker = new Datepicker(endDateInput, datepickerOptions);

      // Pr√©-remplir avec les 7 derniers jours
      const today = new Date();
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(today.getDate() - 7);
      startDatepicker.setDate(sevenDaysAgo);
      endDatepicker.setDate(today);

      let currentPrompt = ''; // Pour stocker le prompt g√©n√©r√©

      // --- Fonctions ---
      function logToConsole(message, isError = false) {
        resultPanel.style.display = 'flex';
        const timestamp = new Date().toLocaleTimeString();
        const prefix = isError ? '‚ùå ERREUR:' : '‚úÖ';
        statusConsole.textContent += `[${timestamp}] ${prefix} ${message}\n`;
        statusConsole.scrollTop = statusConsole.scrollHeight;
      }

      function setButtonLoading(isLoading) {
        if (isLoading) {
          generateBtn.disabled = true;
          generateBtn.innerHTML = 'G√©n√©ration... <span class="spinner"></span>';
        } else {
          generateBtn.disabled = false;
          generateBtn.innerHTML = 'G√©n√©rer le Plan';
        }
      }

      async function generatePlan() {
        const startDate = startDatepicker.getDate('yyyy-mm-dd');
        const endDate = endDatepicker.getDate('yyyy-mm-dd');
        const objective = objectiveInput.value.trim();

        if (!startDate || !endDate) {
          alert("Veuillez s√©lectionner une plage de dates.");
          return;
        }
        if (!objective) {
          alert("Veuillez d√©crire votre objectif.");
          return;
        }

        setButtonLoading(true);
        statusConsole.textContent = '';
        planOutput.innerHTML = '';
        savePromptBtn.style.display = 'none';
        openPlanBtn.style.display = 'none';

        try {
          // 1. Agr√©ger les donn√©es du serveur
          logToConsole(`R√©cup√©ration des donn√©es du ${startDate} au ${endDate}...`);
          const response = await fetch(`/api/aggregateData?start=${startDate}&end=${endDate}`);
          if (!response.ok) {
            throw new Error(`Erreur serveur lors de l'agr√©gation: ${response.statusText}`);
          }
          const aggregatedData = await response.json();
          logToConsole(`Donn√©es re√ßues: ${aggregatedData.activities.length} activit√©s, ${aggregatedData.goals.length} jours d'objectifs, ${aggregatedData.health.length} jours de sant√©.`);

          // 2. Construire le prompt
          logToConsole("Construction du prompt pour l'IA...");
          currentPrompt = `
Vous √™tes un coach sportif de classe mondiale, expert en physiologie et en planification. Votre nom est Aegis.

--- CONTEXTE DE L'ATHL√àTE ---
Voici l'historique de ses activit√©s, objectifs quotidiens et donn√©es de sant√© pour la p√©riode analys√©e :
${JSON.stringify(aggregatedData, null, 2)}

--- OBJECTIF DE L'ATHL√àTE ---
"${objective}"

--- VOS INSTRUCTIONS ---
1. Analysez en silence les donn√©es fournies pour comprendre ses points forts, ses points faibles, ses habitudes et sa condition physique g√©n√©rale.
2. Cr√©ez un plan d'entra√Ænement d√©taill√© en format Markdown pour la semaine prochaine.
3. Le plan doit √™tre r√©aliste, motivant et directement inspir√© par son historique et son objectif.
4. Justifiez bri√®vement chaque s√©ance propos√©e (ex: "S√©ance de fractionn√© pour am√©liorer votre VO2max, vu que votre endurance est un point √† travailler").
5. Int√©grez au moins un jour de repos actif ou complet.
6. Concluez par une phrase de motivation percutante.
`;
          savePromptBtn.style.display = 'inline-block';

          // 3. Appeler l'API Mistral
          logToConsole("Envoi de la requ√™te √† l'API Mistral...");
          const apiKey = 'czBBdZtL4WA8DF5FmkD3SUVDZrPBNM0u'; // REMOVE IN PRODUCTION
          const mistralResponse = await fetch('https://api.mistral.ai/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'mistral-large-latest',
              messages: [{ role: 'user', content: currentPrompt }]
            })
          });

          const mistralData = await mistralResponse.json();
          if (!mistralResponse.ok) {
            throw new Error(mistralData.message || 'Erreur inconnue de l\'API Mistral');
          }

          const generatedPlan = mistralData.choices[0].message.content;
          logToConsole("Plan d'entra√Ænement g√©n√©r√© avec succ√®s !");
          planOutput.innerHTML = marked.parse(generatedPlan);

          // 4. Sauvegarder le plan g√©n√©r√©
          logToConsole("Sauvegarde du plan sur le serveur...");
          const timestamp = new Date().toISOString().split('T')[0]; // Format YYYY-MM-DD
          const filename = `plan_entrainement_${timestamp}.md`;
          const relativePath = `plans_entrainement/${filename}`;

          const saveResponse = await fetch('/api/saveFile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: relativePath, content: generatedPlan })
          });

          const saveData = await saveResponse.json();
          if (saveData.success) {
            logToConsole(`Plan sauvegard√© avec succ√®s !\nChemin : ${saveData.path}`);
            openPlanBtn.style.display = 'inline-block';
            openPlanBtn.onclick = () => window.open(saveData.url, '_blank');
          } else {
            logToConsole('Erreur lors de la sauvegarde du plan : ' + (saveData.error || 'Erreur inconnue'), true);
          }
        } catch (error) {
          logToConsole(error.message, true);
          console.error("Erreur lors de la g√©n√©ration du plan:", error);
        } finally {
          setButtonLoading(false);
        }
      }

      async function savePrompt() {
        if (!currentPrompt) {
          logToConsole("Aucun prompt √† sauvegarder. Veuillez d'abord g√©n√©rer un plan.", true);
          return;
        }

        logToConsole("Sauvegarde du prompt sur le serveur...");
        const timestamp = new Date().toISOString().split('T')[0]; // Format YYYY-MM-DD
        const filename = `pr√©paration_plan_entrainement_${timestamp}.md`;
        const relativePath = `plans_entrainement/${filename}`;

        try {
          const saveResponse = await fetch('/api/saveFile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: relativePath, content: currentPrompt })
          });
          const saveData = await saveResponse.json();
          if (saveData.success) {
            logToConsole(`Prompt sauvegard√© avec succ√®s !\nChemin : ${saveData.path}`);
          } else {
            logToConsole('Erreur lors de la sauvegarde du prompt : ' + (saveData.error || 'Erreur inconnue'), true);
          }
        } catch (error) {
          logToConsole('Erreur de communication lors de la sauvegarde du prompt.', true);
        }
      }

      generateBtn.addEventListener('click', generatePlan);
      savePromptBtn.addEventListener('click', savePrompt);
    });
  </script>
</body>
</html>