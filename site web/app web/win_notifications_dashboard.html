<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centre de Notifications Windows</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/dark.css">
    <style>
        body {
            background-color: #1a1a1a;
            max-width: 900px;
            margin: auto;
            padding: 1rem;
        }
        .status-box {
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            font-weight: bold;
        }
        .status-enabled { background-color: #28a745; color: white; }
        .status-disabled { background-color: #dc3545; color: white; }
        .status-unknown { background-color: #6c757d; color: white; }

        .log-section {
            background-color: #1a1a1a;
            border: 1px solid #444;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 2rem;
        }

        #log-container, #upcoming-tasks-container {
            height: 250px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #111;
            padding: 1rem;
        }
        .log-line.error {
            color: #ff6b6b;
            font-weight: bold;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.show { opacity: 1; }
    </style>
</head>

<body>
    <h1>Centre de Notifications Windows</h1>
    <p>G√©rez la t√¢che qui affiche la notification du jour au d√©marrage de Windows.</p>

    <div id="status-container">
        <h2>√âtat de la T√¢che</h2>
        <div id="status-box" class="status-box status-unknown">Chargement...</div>
        <div style="display: flex; gap: 10px;">
            <button id="toggle-button">Activer / D√©sactiver</button>
            <button id="test-notification-btn" style="background-color: #555;">Tester la Notification</button>
        </div>
    </div>

    <div class="log-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2>üóìÔ∏è Notifications √† Venir</h2>
        </div>
        <div id="upcoming-tasks-container">Chargement des t√¢ches √† venir...</div>
    </div>

    <div class="log-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2>üìú Historique des Notifications Affich√©es</h2>
            <button id="clear-history-btn" style="background-color: #8a3a3a;">Nettoyer l'historique</button>
        </div>
        <pre id="log-container">Chargement de l'historique...</pre>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const statusBox = document.getElementById('status-box');
        const toggleButton = document.getElementById('toggle-button');
        const logContainer = document.getElementById('log-container');
        const testNotificationBtn = document.getElementById('test-notification-btn');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const toast = document.getElementById('toast');

        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.className = toast.className.replace('show', '');
            }, 5000);
        }

        async function fetchStatus() {
            try {
                const response = await fetch('/api/win-notifications/status');
                const result = await response.json();
                if (result.success) {
                    statusBox.textContent = result.data.status;
                    statusBox.className = `status-box ${result.data.enabled ? 'status-enabled' : 'status-disabled'}`;
                } else {
                    statusBox.textContent = `Erreur: ${result.error}`;
                    statusBox.className = 'status-box status-disabled';
                }
            } catch (error) {
                statusBox.textContent = 'Erreur de connexion au serveur.';
                statusBox.className = 'status-box status-disabled';
            }
        }

        async function fetchLogs() {
            try {
                const response = await fetch('/api/win-notifications/history');
                const result = await response.json();
                if (result.success) {
                    // Vider le conteneur et ajouter les lignes une par une avec coloration
                    logContainer.innerHTML = '';
                    const lines = result.data.split('\n');
                    lines.forEach(line => {
                        const lineEl = document.createElement('div');
                        lineEl.textContent = line;
                        if (line.includes('ERROR') || line.includes('ERREUR')) {
                            lineEl.classList.add('log-line', 'error');
                        }
                        logContainer.appendChild(lineEl);
                    });
                } else {
                    logContainer.textContent = `Erreur: ${result.error}`;
                }
            } catch (error) {
                logContainer.textContent = 'Erreur de connexion au serveur pour r√©cup√©rer les logs.';
            }
        }

        async function fetchUpcomingTasks() {
            const container = document.getElementById('upcoming-tasks-container');
            try {
                const response = await fetch('/api/tasks/list');
                const result = await response.json();
                if (result.success && result.tasks.length > 0) {
                    container.innerHTML = result.tasks.map(task => `<div>[${task.next_run}] ${task.name}</div>`).join('');
                } else {
                    container.textContent = "Aucune t√¢che planifi√©e trouv√©e.";
                }
            } catch (error) {
                container.textContent = 'Erreur de chargement des t√¢ches √† venir.';
            }
        }

        toggleButton.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/win-notifications/toggle', { method: 'POST' });
                const result = await response.json();
                showToast(result.message, result.success ? 'success' : 'error');
                fetchStatus(); // Refresh status after action
            } catch (error) {
                showToast('Erreur de communication avec le serveur.', 'error');
            }
        });

        testNotificationBtn.addEventListener('click', async () => {
            showToast('Envoi de la notification de test...', 'success');
            try {
                const response = await fetch('/api/win-notifications/test', { method: 'POST' });
                const result = await response.json();
                // Le toast est d√©j√† affich√©, on ne fait rien de plus, sauf en cas d'erreur
                if (!result.success) showToast(result.error, 'error');
            } catch (error) {
                showToast('Erreur de communication avec le serveur.', 'error');
            }
        });

        clearHistoryBtn.addEventListener('click', async () => {
            if (!confirm("√ätes-vous s√ªr de vouloir supprimer d√©finitivement l'historique des notifications ?")) {
                return;
            }
            try {
                const response = await fetch('/api/win-notifications/clear-history', { method: 'POST' });
                const result = await response.json();
                showToast(result.message, result.success ? 'success' : 'error');
                fetchLogs(); // Refresh logs after action
            } catch (error) {
                showToast('Erreur de communication avec le serveur.', 'error');
            }
        });

        // Initial load and periodic refresh
        fetchStatus();
        fetchLogs();
        fetchUpcomingTasks();
    </script>
</body>

</html>