<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tableau de Bord - Monde Vivant</title>
  <style>
    :root {
      --bg-dark: #1a1a1a;
      --bg-light: #2c2c2c;
      --text-primary: #f0f0f0;
      --text-secondary: #a0a0a0;
      --accent: #4CAF50;
      --border-color: #444;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      padding: 25px;
    }

    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 25px;
    }

    header h1 {
      font-size: 2.5em;
      margin: 0;
    }

    header p {
      color: var(--text-secondary);
      font-size: 1.1em;
    }

    .filters {
      margin-bottom: 25px;
      display: flex;
      gap: 10px;
    }

    .filters button {
      background-color: var(--bg-light);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.2s, border-color 0.2s;
    }

    .filters button:hover {
      background-color: #383838;
    }

    .filters button.active {
      background-color: var(--accent);
      border-color: var(--accent);
      color: #fff;
      font-weight: bold;
    }

    /* Nouveaut√©s : Section Motivation */
    .motivation-section {
        background-color: var(--bg-light);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        margin-bottom: 30px;
        text-align: center;
    }
    .motivation-section h2 { text-align: center; border: none; padding: 0; margin: 0 0 10px 0; }
    .motivation-section #actions-status { margin-top: 15px; min-height: 1em; color: var(--text-secondary); }
    .motivation-section p {
      font-size: 1.2em;
      color: var(--text-secondary);
      font-style: italic;
      min-height: 50px;
      margin: 10px 0 20px 0;
    }
    .motivation-controls {
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    .comparison {
      font-size: 0.8em;
      font-weight: normal;
      margin-left: 8px;
    }
    .comparison.positive { color: #66bb6a; }
    .comparison.negative { color: #ef5350; }
    .comparison.neutral { color: var(--text-secondary); }


    /* Nouveaux filtres de date */
    .date-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
      margin-bottom: 25px;
    }
    .date-range-picker {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .date-range-picker input {
      background-color: var(--bg-light);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 10px;
      border-radius: 8px;
      width: 120px;
      text-align: center;
    }
    .preset-filters {
      display: flex;
      gap: 10px;
    }

    /* Styles pour la librairie de calendrier (Datepicker) */
    .datepicker { border-radius: 8px; background-color: var(--bg-light); border: 1px solid var(--border-color); }
    .datepicker-picker { color: var(--text-primary); }
    .datepicker-header .datepicker-title { color: var(--accent); }
    .datepicker-cell.selected, .datepicker-cell.selected:hover { background-color: var(--accent); }
    .datepicker-cell:not(.disabled):hover { background-color: #444; }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background-color: var(--bg-light);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .card h3 {
      margin: 0 0 10px;
      font-size: 1.1em;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .card .value {
      font-size: 2.2em;
      font-weight: bold;
      color: var(--accent);
    }

    /* Styles pour le bouton de d√©tails et la modale */
    .details-btn {
      background: none;
      text-decoration: none;
      border: 1px solid var(--text-secondary);
      color: var(--text-secondary);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.8em;
      cursor: pointer;
      margin-left: 15px;
      transition: all 0.2s;
    }
    .details-btn:hover {
      background-color: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    /* Styles pour la section des objectifs */
    .goals-section {
      background-color: var(--bg-light);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      margin-bottom: 30px;
      grid-column: 1 / -1; /* Prend toute la largeur */
    }

    .goal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .goal-item {
      text-align: center;
    }

    .goal-item .progress-circle {
      position: relative;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      margin: 0 auto 10px;
      font-size: 1.5em;
      font-weight: bold;
    }

    .goal-item .progress-circle::before {
      content: "";
      position: absolute;
      height: 80%;
      width: 80%;
      background-color: var(--bg-dark);
      border-radius: 50%;
    }

    .goal-item .progress-value {
      position: relative;
    }

    .goal-item .goal-label {
      font-size: 1em;
      color: var(--text-secondary);
    }
    .goal-item input {
      width: 80px; text-align: center; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 5px; padding: 4px; margin-top: 5px;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .section-title {
      font-size: 1.5em;
      margin-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 10px;
    }

    .type-breakdown ul {
      list-style: none;
      padding: 0;
    }

    .type-breakdown li {
      margin-bottom: 15px;
    }

    .type-breakdown .type-name {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .progress-bar {
      height: 10px;
      background-color: #444;
      border-radius: 5px;
      overflow: hidden;
    }

    .progress-bar div {
      height: 100%;
      background-color: var(--accent);
      border-radius: 5px;
    }

    .recent-activities ul {
      list-style: none;
      padding: 0;
    }

    .recent-activities li {
      background-color: var(--bg-light);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .recent-activities li:hover {
      background-color: #383838;
    }

    .recent-activities .activity-title {
      font-weight: bold;
    }

    .recent-activities .activity-details {
      font-size: 0.9em;
      color: var(--text-secondary);
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <header>
      <h1>Tableau de Bord</h1>
      <p>Votre r√©sum√© d'activit√© Monde Vivant.</p>
    </header>

    <div class="motivation-section">
      <h2 class="section-title">Actions du Jour</h2>
      <p id="motivation-text">Bonjour ! Pr√™t √† affronter cette journ√©e ? Chaque pas est une victoire.</p>
      <div class="motivation-controls">
        <select id="motivation-coach-selector" class="filters" style="padding: 10px 15px; height: auto;">
          <option value="Al√©atoire">Coach Al√©atoire</option>
          <!-- Les coachs seront ajout√©s ici par JS -->
        </select>
        <button id="generate-motivation-btn" class="filters">‚ú® Inspiration du Coach</button>
        <button id="generate-notifications-btn" class="filters">üîî G√©n√©rer Notifications</button>
      </div>
      <p id="actions-status"></p>
    </div>

    <div id="weekly-summary-section" class="goals-section">
      <!-- Le contenu du r√©sum√© de la semaine sera inject√© ici -->
    </div>

    <div class="date-filters">
      <div class="date-range-picker">
        <input type="text" id="start-date-input" placeholder="Date de d√©but">
        <span>√†</span>
        <input type="text" id="end-date-input" placeholder="Date de fin">
      </div>
      <div class="preset-filters filters">
        <button id="filter-last-30" class="active">30 derniers jours</button>
        <button id="filter-this-month">Ce mois-ci</button>
        <button id="filter-last-month">Mois dernier</button>
      </div>
    </div>

    <div class="summary-cards">
      <div class="card">
        <h3>Activit√©s</h3>
        <div id="total-activities" class="value">0</div>
      </div>
      <div class="card">
        <h3>Distance</h3>
        <div id="total-distance" class="value">0 km</div>
      </div>
      <div class="card">
        <h3>Dur√©e Totale</h3>
        <div id="total-duration" class="value">0h 0m</div>
      </div>
      <div class="card">
        <h3>Calories</h3>
        <div id="total-calories" class="value">0</div>
      </div>
    </div>

    <div class="main-content">
      <div class="type-breakdown">
        <h2 class="section-title">R√©partition par Activit√©</h2>
        <ul id="type-list">
          <!-- Rempli par JavaScript -->
        </ul>
      </div>
      <div class="recent-activities">
        <h2 class="section-title">Activit√©s R√©centes</h2>
        <ul id="activity-list">
          <!-- Rempli par JavaScript -->
        </ul>
      </div>
    </div>
  </div>

  <!-- Librairie pour le calendrier -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css">
  <script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/locales/fr.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const startDateInput = document.getElementById('start-date-input');
      const endDateInput = document.getElementById('end-date-input');
      const presetButtons = document.querySelectorAll('.preset-filters button');

      // Nouveaux √©l√©ments
      const motivationText = document.getElementById('motivation-text');
      const generateMotivationBtn = document.getElementById('generate-motivation-btn');
      const motivationCoachSelector = document.getElementById('motivation-coach-selector');
      const generateNotificationsBtn = document.getElementById('generate-notifications-btn');

      let allActivities = [];
      let currentFilter = 7;

      let weeklySummarySection = document.getElementById('weekly-summary-section'); // Correction du nom de variable
      let dailyGoalsData = [];

      // --- Fonctions Utilitaires ---
      const parseDuration = (durationStr) => {
        if (!durationStr || !durationStr.includes(':')) return 0;
        const parts = durationStr.split(':').map(Number);
        if (parts.length === 2) return parts[0] * 60 + parts[1]; // MM:SS
        if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2]; // HH:MM:SS
        return 0;
      };

      const formatDuration = (totalSeconds) => {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        return `${hours}h ${minutes}m`;
      };

      // --- Logique d'affichage ---
      const updateDashboard = (startDate, endDate) => {
        const start = new Date(startDate);
        const end = new Date(endDate);

        const filteredActivities = allActivities.filter(act => new Date(act.date) >= start && new Date(act.date) <= end);

        // 1. Mettre √† jour les cartes de r√©sum√©
        const totalActivities = filteredActivities.length;
        const totalDurationSeconds = filteredActivities.reduce((sum, act) => sum + parseDuration(act.duration), 0);
        const totalCalories = filteredActivities.reduce((sum, act) => sum + (parseInt(act.calories, 10) || 0), 0);
        const totalDistance = filteredActivities.reduce((sum, act) => sum + (parseFloat(act.distance) || 0), 0);

        document.getElementById('total-activities').textContent = totalActivities;
        document.getElementById('total-duration').textContent = formatDuration(totalDurationSeconds);
        document.getElementById('total-distance').textContent = `${totalDistance.toFixed(1)} km`;
        document.getElementById('total-calories').textContent = totalCalories.toLocaleString('fr-FR');

        // 2. Mettre √† jour la r√©partition par type
        const byType = filteredActivities.reduce((acc, act) => {
          acc[act.type] = (acc[act.type] || 0) + 1;
          return acc;
        }, {});
        
        const typeList = document.getElementById('type-list');
        typeList.innerHTML = '';
        Object.entries(byType).sort(([, a], [, b]) => b - a).forEach(([type, count]) => {
          const percentage = totalActivities > 0 ? (count / totalActivities) * 100 : 0;
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="type-name">
              <span>${type}</span>
              <span>${count} (${percentage.toFixed(0)}%)</span>
            </div>
            <div class="progress-bar"><div style="width: ${percentage}%;"></div></div>
          `;
          typeList.appendChild(li);
        });

        // 3. Mettre √† jour la liste des activit√©s r√©centes
        const activityList = document.getElementById('activity-list');
        activityList.innerHTML = '';
        filteredActivities.slice(0, 10).forEach(act => { // Affiche les 10 plus r√©centes
          const li = document.createElement('li');
          li.dataset.href = act.html_file;
          li.innerHTML = `
            <div class="activity-title">${act.type}</div>
            <div class="activity-details">${new Date(act.date).toLocaleDateString('fr-FR')} - ${act.distance || '0'} km - ${act.duration} - ${act.calories} kcal</div>
          `;
          li.addEventListener('click', () => {
            // Communique avec la page parente pour changer l'iframe
            if (window.parent && window.parent.document.getElementById('content-frame')) {
              window.parent.document.getElementById('content-frame').src = act.html_file;
            }
          });
          activityList.appendChild(li);
        });
      };

      // --- Logique pour la motivation ---
      const MOTIVATION_CACHE_KEY = 'motivation_cache';

      const populateMotivationCoaches = (coaches) => {
        coaches.forEach(coachName => {
          const option = document.createElement('option');
          option.value = coachName;
          option.textContent = coachName;
          motivationCoachSelector.appendChild(option);
        });
      };

      const getSelectedCoach = () => {
        return motivationCoachSelector.value;
      };

      const loadMotivationFromCache = () => {
        const cached = localStorage.getItem(MOTIVATION_CACHE_KEY);
        if (cached) {
          const { date, message, coach } = JSON.parse(cached);
          const today = new Date().toISOString().split('T')[0];
          if (date === today) {
            motivationText.textContent = `(${coach}) ${message}`;
          }
        }
      };

      // --- Logique pour le r√©sum√© de la semaine ---
      const updateWeeklySummary = (configTargets) => {
        if (dailyGoalsData.length === 0) return;

        const targetValues = {
          calories: configTargets.calories || 500,
          steps: configTargets.steps || 8000,
          distance: configTargets.distance || 5.0,
        };

        // Calcul pour la semaine en cours
        const today = new Date();
        const dayOfWeek = today.getDay(); // Dimanche = 0, Lundi = 1, ...
        const startOfWeek = new Date(today); // Cr√©er une nouvelle instance pour ne pas modifier 'today'
        const diff = dayOfWeek; // Pour une semaine qui commence le Dimanche
        startOfWeek.setDate(today.getDate() - diff);
        startOfWeek.setHours(0, 0, 0, 0);

        const goalsOfCurrentWeek = dailyGoalsData.filter(goal => {
            const goalDate = new Date(goal.date);
            return goalDate >= startOfWeek && goalDate <= today;
        });

        // Calcul pour la semaine pr√©c√©dente
        const endOfPreviousWeek = new Date(startOfWeek);
        endOfPreviousWeek.setDate(startOfWeek.getDate() - 1);
        endOfPreviousWeek.setHours(23, 59, 59, 999);
        const startOfPreviousWeek = new Date(endOfPreviousWeek);
        startOfPreviousWeek.setDate(endOfPreviousWeek.getDate() - 6);
        startOfPreviousWeek.setHours(0, 0, 0, 0);

        const goalsOfPreviousWeek = dailyGoalsData.filter(goal => {
            const goalDate = new Date(goal.date);
            return goalDate >= startOfPreviousWeek && goalDate <= endOfPreviousWeek;
        });

        const calculateAveragePercentages = (goals) => {
            if (goals.length === 0) return { calories: 0, steps: 0, distance: 0 };
            const totals = goals.reduce((acc, goal) => {
                acc.calories += parseFloat(goal.calories.replace(',', '.')) || 0;
                acc.steps += parseInt(goal.steps, 10) || 0;
                acc.distance += parseFloat(goal.distance.replace(',', '.')) || 0;
                return acc;
            }, { calories: 0, steps: 0, distance: 0 });

            const averages = {
                calories: totals.calories / goals.length,
                steps: totals.steps / goals.length,
                distance: totals.distance / goals.length,
            };

            return {
                calories: Math.round((averages.calories / targetValues.calories) * 100),
                steps: Math.round((averages.steps / targetValues.steps) * 100),
                distance: Math.round((averages.distance / targetValues.distance) * 100),
            };
        };

        const currentWeekAvg = calculateAveragePercentages(goalsOfCurrentWeek);
        const previousWeekAvg = calculateAveragePercentages(goalsOfPreviousWeek);

        

        const getComparisonHTML = (current, previous) => {
            if (previous === 0) return ''; // Pas de donn√©es pour comparer
            const diff = current - previous;
            const sign = diff > 0 ? '+' : '';
            const className = diff > 0 ? 'positive' : diff < 0 ? 'negative' : 'neutral';
            return `<span class="comparison ${className}">(${sign}${diff}%)</span>`;
        };

        weeklySummarySection.innerHTML = `
            <h2 class="section-title" style="text-align: left; border: none; padding: 0; margin-bottom: 20px;">
              R√©sum√© de la Semaine en Cours (Moyenne)
              <a href="historique_objectifs/index.html" class="details-btn">Voir l'historique</a>
            </h2>
            <div class="goal-grid">
                <div class="goal-item">
                    <div class="progress-circle" style="background: conic-gradient(var(--accent) ${Math.min(currentWeekAvg.calories, 100) * 3.6}deg, var(--border-color) 0deg)"><span class="progress-value">${currentWeekAvg.calories}% ${getComparisonHTML(currentWeekAvg.calories, previousWeekAvg.calories)}</span></div>
                    <div class="goal-label">üî• Calories</div>
                </div>
                <div class="goal-item">
                    <div class="progress-circle" style="background: conic-gradient(var(--accent) ${Math.min(currentWeekAvg.steps, 100) * 3.6}deg, var(--border-color) 0deg)"><span class="progress-value">${currentWeekAvg.steps}% ${getComparisonHTML(currentWeekAvg.steps, previousWeekAvg.steps)}</span></div>
                    <div class="goal-label">üëü Pas</div>
                </div>
                <div class="goal-item">
                    <div class="progress-circle" style="background: conic-gradient(var(--accent) ${Math.min(currentWeekAvg.distance, 100) * 3.6}deg, var(--border-color) 0deg)"><span class="progress-value">${currentWeekAvg.distance}% ${getComparisonHTML(currentWeekAvg.distance, previousWeekAvg.distance)}</span></div>
                    <div class="goal-label">üìè Distance (km)</div>
                </div>
            </div>`;
        weeklySummarySection.style.display = 'block';
      };

      // --- Initialisation ---
      loadMotivationFromCache(); // Charger le message de motivation en cache au d√©marrage

      fetch('activities.json')
        .then(response => response.json())
        .then(data => {
          allActivities = data;
          updateDashboard(currentFilter); // Affichage initial
        })
        .catch(error => console.error("Erreur de chargement de activities.json:", error));

      // Charger les coachs pour le s√©lecteur de motivation
      fetch('/api/coaches')
        .then(response => response.json())
        .then(result => {
          const coaches = result.data; // Extraire le tableau de la propri√©t√© 'data'
          populateMotivationCoaches(coaches);
        })
        .catch(error => {
          console.error("Erreur de chargement des coachs pour la motivation:", error);
          motivationCoachSelector.innerHTML += '<option disabled>Erreur</option>';
        });

      // Initialisation des objectifs et des cibles
      Promise.all([
        fetch('objectifs.json').then(res => res.json()),
        fetch('/api/notifications/config').then(res => res.json())
      ]).then(([goalsData, configData]) => {
        dailyGoalsData = goalsData;
        const configTargets = configData.targets || {};
        updateWeeklySummary(configTargets);
      }).catch(error => {
        console.error("Erreur de chargement des donn√©es (objectifs ou config):", error);
        weeklySummarySection.innerHTML = `<p style="color: red; text-align: center;">Erreur de chargement des donn√©es.</p>`;
        weeklySummarySection.style.display = 'block';
      });

      // --- Initialisation des filtres de date ---
      const datepickerOptions = {
        format: 'yyyy-mm-dd',
        language: 'fr',
        autohide: true,
        todayHighlight: true,
      };

      const startDatepicker = new Datepicker(startDateInput, datepickerOptions);
      const endDatepicker = new Datepicker(endDateInput, datepickerOptions);

      const triggerUpdate = () => {
        const start = startDatepicker.getDate('yyyy-mm-dd');
        const end = endDatepicker.getDate('yyyy-mm-dd');
        if (start && end) {
          updateDashboard(start, end);
        }
      };

      startDateInput.addEventListener('changeDate', triggerUpdate);
      endDateInput.addEventListener('changeDate', triggerUpdate);

      const setActiveButton = (activeBtn) => {
        presetButtons.forEach(btn => btn.classList.remove('active'));
        if (activeBtn) activeBtn.classList.add('active');
      };

      presetButtons.forEach(button => {
        button.addEventListener('click', () => {
          setActiveButton(button);
          const today = new Date();
          let start, end = new Date();

          switch(button.id) {
            case 'filter-this-month':
              start = new Date(today.getFullYear(), today.getMonth(), 1);
              end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
              break;
            case 'filter-last-month':
              start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
              end = new Date(today.getFullYear(), today.getMonth(), 0);
              break;
            case 'filter-last-30':
            default:
              end = new Date();
              start = new Date();
              start.setDate(end.getDate() - 29);
              break;
          }
          startDatepicker.setDate(start);
          endDatepicker.setDate(end);
          triggerUpdate();
        });
      });

      // Initialisation par d√©faut (30 derniers jours)
      document.getElementById('filter-last-30').click();

      // --- Logique pour la motivation ---
      generateMotivationBtn.addEventListener('click', async () => {
          const originalText = generateMotivationBtn.innerHTML;
          
          generateMotivationBtn.disabled = true;
          generateMotivationBtn.innerHTML = 'G√©n√©ration...';
          motivationText.textContent = 'Le coach r√©fl√©chit...';

          try {
              const response = await fetch('/api/generate-motivation', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ coach: getSelectedCoach() })
              });
              const data = await response.json();
              if (!response.ok || !data.success) {
                  throw new Error(data.error || 'Erreur du serveur');
              }
              
              const messageToDisplay = `(${data.coach}) ${data.message}`;
              motivationText.textContent = messageToDisplay;

              // Sauvegarder dans le cache
              const today = new Date().toISOString().split('T')[0];
              const cacheData = {
                date: today,
                message: data.message,
                coach: data.coach
              };
              localStorage.setItem(MOTIVATION_CACHE_KEY, JSON.stringify(cacheData));

          } catch (error) {
              console.error("Erreur de g√©n√©ration de motivation:", error);
              motivationText.textContent = "Le coach est en panne d'inspiration. R√©essayez plus tard.";
          } finally {
              setTimeout(() => {
                  generateMotivationBtn.disabled = false;
                  generateMotivationBtn.innerHTML = originalText;
              }, 5000); // Cooldown de 5 secondes
          }
      });

      // --- Logique pour la g√©n√©ration des notifications ---
      generateNotificationsBtn.addEventListener('click', async () => {
          const originalText = generateNotificationsBtn.innerHTML;
          const actionsStatus = document.getElementById('actions-status');

          generateNotificationsBtn.disabled = true;
          generateNotificationsBtn.innerHTML = 'G√©n√©ration...';
          actionsStatus.textContent = 'G√©n√©ration des notifications en cours...';
          actionsStatus.style.color = 'var(--text-secondary)';

          try {
              const response = await fetch('/api/notifications/generate', { method: 'POST' });
              if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(errorData.error || 'Erreur du serveur');
              }
              const data = await response.json();
              
              actionsStatus.textContent = data.message || 'Op√©ration termin√©e.';
              actionsStatus.style.color = 'var(--accent)';

              // Demander √† la page parente de rafra√Æchir les notifications
              if (window.parent && typeof window.parent.fetchNotifications === 'function') {
                  window.parent.fetchNotifications();
              }

          } catch (error) {
              console.error("Erreur de g√©n√©ration des notifications:", error);
              actionsStatus.textContent = `Erreur: ${error.message}`;
              actionsStatus.style.color = 'red';
          } finally {
              setTimeout(() => {
                  generateNotificationsBtn.disabled = false;
                  generateNotificationsBtn.innerHTML = originalText;
              }, 5000); // Cooldown de 5 secondes
          }
      });
    });
  </script>
</body>
</html>