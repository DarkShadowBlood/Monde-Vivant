<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Saisie en Masse - Sant√©</title>
  <style>
    :root {
      --bg-dark: #1a1a1a;
      --bg-light: #2c2c2c;
      --text-primary: #f0f0f0;
      --text-secondary: #a0a0a0;
      --accent: #4CAF50;
      --border-color: #444;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      padding: 25px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1, h2 {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }
    .section {
      background-color: var(--bg-light);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-weight: bold;
    }
    input[type="number"], input[type="date"], input[type="file"] {
      width: 100%;
      padding: 10px;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1em;
      box-sizing: border-box;
    }
    select {
      width: 100%;
      padding: 10px;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1em;
      box-sizing: border-box;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 1em;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid var(--accent);
      background-color: var(--accent);
      color: #fff;
      transition: background-color 0.2s;
    }
    button:hover { background-color: #45a049; }
    button.secondary {
      background-color: var(--bg-light);
      border-color: var(--border-color);
      color: var(--text-primary);
    }
    button.secondary:hover { background-color: #383838; }
    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-buttons button {
      flex-grow: 1;
    }
    .tab-buttons button.active {
      background-color: var(--accent);
    }

    /* Table Styles */
    #glycemie-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    #glycemie-table th, #glycemie-table td {
      padding: 10px;
      border: 1px solid var(--border-color);
      text-align: center;
    }
    #glycemie-table th {
      background-color: var(--bg-dark);
    }
    #glycemie-table input {
      text-align: center;
      width: 80%;
    }
    #mass-table-body input.has-data {
      background-color: #2e442f;
      border-color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Saisie de Donn√©es de Sant√©</h1>

    <div class="section">
      <h2>üìù Saisie et Modification d'une Journ√©e</h2>
      <p>Chargez un fichier .json existant pour le modifier, ou remplissez les champs pour cr√©er une nouvelle entr√©e.</p>
      <div class="form-group">
        <label for="file-selector">Charger une journ√©e existante</label>
        <select id="file-selector"><option value="">-- Choisir un fichier --</option></select>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label for="date">Date</label>
          <input type="date" id="date">
        </div>
        <div class="form-group">
          <label for="weight">Poids (Matin) (lb)</label>
          <input type="number" id="weight" step="0.1" min="0" placeholder="ex: 80.5">
        </div>
        <div class="form-group">
          <label for="waist">Ventre (cm)</label>
          <input type="number" id="waist" step="0.1" min="0" placeholder="ex: 95.2">
        </div>
        <div class="form-group">
          <label for="glycemie">Glyc√©mie (mmol/L)</label>
          <input type="number" id="glycemie" step="0.1" min="0" placeholder="ex: 5.6">
        </div>
        <div class="form-group">
          <label for="water">Eau (x 500ml)</label>
          <input type="number" id="water" min="0" placeholder="ex: 4">
        </div>
      </div>
      <div class="button-group">
        <button id="save-single-btn">Sauvegarder la journ√©e (.json)</button>
      </div>
    </div>

    <div class="section">
      <h2>üìä Saisie en Masse</h2>
      <p>Entrez rapidement vos donn√©es pour plusieurs jours. Chaque ligne modifi√©e sera sauvegard√©e dans son propre fichier .json.</p>
      <div class="tab-buttons">
        <button id="tab-weight" class="secondary">Poids (Matin) (lb)</button>
        <button id="tab-waist" class="secondary">Ventre (cm)</button>
        <button id="tab-glycemie" class="secondary active">Glyc√©mie (mmol/L)</button>
      </div>
      <div class="form-group">
        <label for="start-date">Date de d√©but pour le tableau</label>
        <input type="date" id="start-date">
      </div>
      <table id="mass-entry-table">
        <thead>
          <tr><th>Date</th><th id="mass-header">Glyc√©mie (mmol/L)</th></tr>
        </thead>
        <tbody id="mass-table-body">
          <!-- Rows will be generated by JS -->
        </tbody>
      </table>
      <div class="button-group" style="justify-content: center;">
        <button id="add-month-btn" class="secondary">‚ñº Afficher le mois suivant</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- Single Entry Elements ---
      const fileSelector = document.getElementById('file-selector');
      const dateInput = document.getElementById('date');
      const weightInput = document.getElementById('weight');
      const waistInput = document.getElementById('waist');
      const glycemieInput = document.getElementById('glycemie');
      const waterInput = document.getElementById('water');
      const saveSingleBtn = document.getElementById('save-single-btn');

      // --- Mass Entry Elements ---
      const startDateInput = document.getElementById('start-date');
      const massTableBody = document.getElementById('mass-table-body');
      const massHeader = document.getElementById('mass-header');
      const addMonthBtn = document.getElementById('add-month-btn');

      let allSanteData = new Map();

      const tabButtons = {
        poids: document.getElementById('tab-weight'),
        ventre: document.getElementById('tab-waist'),
        glycemie: document.getElementById('tab-glycemie')
      };

      // --- Utility Functions ---
      const saveJsonToServer = async (data) => {
        try {
          const response = await fetch('/api/sante/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (!response.ok) {
            throw new Error(`Erreur serveur: ${response.statusText}`);
          }
          console.log('Sauvegarde r√©ussie:', await response.json());
          return true;
        } catch (error) {
          console.error('Erreur de sauvegarde:', error);
          alert('Erreur de sauvegarde: ' + error.message);
          return false;
        }
      };

      // --- Single Entry Logic ---
      const getLocalDateString = (date = new Date()) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };
      dateInput.value = getLocalDateString();

      const loadFileContent = async (filename) => {
        if (!filename) return;
        try {
          const response = await fetch(`/api/sante/file?name=${filename}`);
          if (!response.ok) throw new Error('Fichier non trouv√©');
          const data = await response.json();
          dateInput.value = data.date || '';
          weightInput.value = data.weight?.value || '';
          waistInput.value = data.waist?.value || '';
          glycemieInput.value = data.glycemie_mmol_l || '';
          waterInput.value = data.water_500ml_units || '';
          return data;
        } catch (error) {
          console.error("Erreur de chargement du fichier:", error);
          return null;
        }
      };

      saveSingleBtn.addEventListener('click', async () => {
        // Charger les donn√©es existantes pour ne pas les √©craser
        const filename = `sante_log_${dateInput.value}.json`;
        let existingData = {};
        try {
            const response = await fetch(`/api/sante/file?name=${filename}`);
            if (response.ok) existingData = await response.json();
        } catch (e) { /* Fichier non existant, c'est ok */ }

        const dataToSave = {
          ...existingData, // Conserve les donn√©es non modifiables ici (ex: dragon_purged)
          date: dateInput.value,
          weight: { value: parseFloat(weightInput.value) || null, unit: 'lb' },
          waist: { value: parseFloat(waistInput.value) || null, unit: 'cm' },
          glycemie_mmol_l: parseFloat(glycemieInput.value) || null,
          water_500ml_units: parseInt(waterInput.value, 10) || existingData.water_500ml_units || 0
        };

        if (await saveJsonToServer(dataToSave)) {
          alert(`Journ√©e du ${dataToSave.date} sauvegard√©e !`);
          populateFileSelector(); // Recharger la liste
        }
      });

      // --- Mass Entry Logic ---

      let currentMassMode = 'glycemie'; // 'poids', 'ventre', 'glycemie'

      const setMassMode = (mode) => {
        currentMassMode = mode;
        // Mettre √† jour l'UI (boutons et header)
        Object.values(tabButtons).forEach(btn => btn.classList.remove('active'));
        tabButtons[mode].classList.add('active');
        
        const headers = {
          poids: 'Poids (lb)',
          ventre: 'Ventre (cm)',
          glycemie: 'Glyc√©mie (mmol/L)'
        };
        massHeader.textContent = headers[mode];
      };

      const appendMonthToTable = (startDate) => {
        let currentDate = new Date(startDate);
        // Assurer que la date est interpr√©t√©e comme locale et non UTC
        currentDate.setMinutes(currentDate.getMinutes() + currentDate.getTimezoneOffset());

        const todayStr = getLocalDateString(new Date());

        for (let i = 0; i < 30; i++) { // Append 30 days at a time
          const dateStr = getLocalDateString(currentDate);

          if (dateStr > todayStr) {
            break; // Stop adding rows for future dates
          }

          const row = document.createElement('tr');
          const dayData = allSanteData.get(dateStr);
          
          let value = '';
          let hasData = false;
          if (dayData) {
            switch(currentMassMode) {
              case 'poids':
                value = dayData.weight?.value || '';
                break;
              case 'ventre':
                value = dayData.waist?.value || '';
                break;
              case 'glycemie':
                value = dayData.glycemie_mmol_l || '';
                break;
            }
            if (value !== '') hasData = true;
          }

          row.innerHTML = `
            <td>${dateStr}</td>
            <td><input 
                  type="number" 
                  class="mass-input ${hasData ? 'has-data' : ''}" 
                  data-date="${dateStr}" 
                  step="0.1" 
                  min="0" 
                  placeholder="..."
                  value="${value}"></td>
          `;
          massTableBody.appendChild(row);
          currentDate.setDate(currentDate.getDate() + 1);
        }
        
        // Store the next date to continue from and manage button visibility
        const nextDateStr = getLocalDateString(currentDate);
        if (nextDateStr > todayStr) {
            massTableBody.dataset.nextDate = '';
            addMonthBtn.style.display = 'none';
        } else {
            massTableBody.dataset.nextDate = nextDateStr;
            addMonthBtn.style.display = 'inline-block';
        }
      };

      Object.keys(tabButtons).forEach(mode => {
        tabButtons[mode].addEventListener('click', () => {
          setMassMode(mode);
          startDateInput.dispatchEvent(new Event('change')); // Re-render table with new mode
        });
      });

      startDateInput.addEventListener('change', () => {
        massTableBody.innerHTML = ''; // Clear table before generating new dates
        appendMonthToTable(startDateInput.value);
      });
      addMonthBtn.addEventListener('click', () => {
        if (massTableBody.dataset.nextDate) {
          // On garde en m√©moire le nombre d'entr√©es avant l'ajout
          const inputsBeforeCount = massTableBody.querySelectorAll('.mass-input').length;

          appendMonthToTable(massTableBody.dataset.nextDate);

          // On cherche la premi√®re nouvelle entr√©e (son index correspond au nombre d'entr√©es avant l'ajout)
          const allInputs = massTableBody.querySelectorAll('.mass-input');
          const firstNewInput = allInputs[inputsBeforeCount];

          // On place le focus dessus
          if (firstNewInput) firstNewInput.focus();
        }
      });

      // --- Mass Entry Event Listeners for better UX ---
      massTableBody.addEventListener('keydown', (e) => {
        // Allow using "Enter" key to navigate to the next input like "Tab"
        if (e.key === 'Enter' && e.target.classList.contains('mass-input')) {
          e.preventDefault(); // Prevent default form submission on Enter
          const inputs = Array.from(massTableBody.querySelectorAll('.mass-input'));
          const currentIndex = inputs.indexOf(e.target);
          const nextInput = inputs[currentIndex + 1];
          if (nextInput) {
            nextInput.focus();
          } else {
            addMonthBtn.focus(); // Move to "add month" button at the end
          }
        }
      });

      // Store original value on focus to detect changes later
      massTableBody.addEventListener('focusin', (e) => {
        if (e.target.classList.contains('mass-input')) {
          e.target.dataset.originalValue = e.target.value;
        }
      });

      const saveMassEntryRow = async (input) => {
        const valueStr = input.value.trim();
        const value = valueStr === '' ? null : parseFloat(valueStr);
        const date = input.dataset.date;
        const filename = `sante_log_${date}.json`;
        let existingData = {};

        try {
          const response = await fetch(`/api/sante/file?name=${filename}`);
          if (response.ok) existingData = await response.json();
        } catch (e) { /* Fichier non existant, c'est ok */ }

        const dataToSave = { ...existingData, date: date };
        if (!dataToSave.weight) dataToSave.weight = { value: null, unit: 'lb' };
        if (!dataToSave.waist) dataToSave.waist = { value: null, unit: 'cm' };

        // Mettre √† jour la bonne valeur en fonction du mode
        if (currentMassMode === 'poids') dataToSave.weight.value = value;
        if (currentMassMode === 'ventre') dataToSave.waist.value = value;
        if (currentMassMode === 'glycemie') dataToSave.glycemie_mmol_l = value;

        const success = await saveJsonToServer(dataToSave);
        if (success) {
            input.style.borderColor = 'var(--accent)'; // Visual feedback
            input.dataset.originalValue = input.value; // Update original value on successful save
            setTimeout(() => { input.style.borderColor = '' }, 1500);
        }
        return success;
      };

      massTableBody.addEventListener('blur', (e) => {
        // Auto-format and AUTO-SAVE on leaving the input
        if (e.target.classList.contains('mass-input')) {
          const input = e.target;
          const originalValue = input.dataset.originalValue || '';
          const value = parseFloat(input.value);

          if (!isNaN(value) && input.value.trim() !== '') {
            input.value = value.toFixed(1);
          }

          // Auto-save if the value has changed
          if (input.value !== originalValue) {
            saveMassEntryRow(input);
          }
        }
      }, true); // Use capture phase to ensure formatting happens reliably

      const loadAllSanteData = async () => {
        try {
          const response = await fetch('sante.json');
          if (!response.ok) throw new Error('sante.json non trouv√©');
          const data = await response.json();
          allSanteData.clear();
          data.forEach(entry => {
            if (entry.date) {
              allSanteData.set(entry.date, entry);
            }
          });
          console.log(`${allSanteData.size} entr√©es de sant√© charg√©es.`);
        } catch (error) {
          console.error("Erreur de chargement de sante.json:", error);
          // Pas d'alerte, la page peut fonctionner sans
        }
      };

      // --- Initialisation ---
      const populateFileSelector = async () => {
        const response = await fetch('/api/sante/files');
        const files = await response.json();
        fileSelector.innerHTML = '<option value="">-- Choisir une journ√©e --</option>';
        files.forEach(file => {
          const option = new Option(file.replace('sante_log_', '').replace('.json', ''), file);
          fileSelector.add(option);
        });
      };

      const initializePage = async () => {
        await loadAllSanteData();
        await populateFileSelector();
        
        fileSelector.addEventListener('change', (e) => loadFileContent(e.target.value));
        
        startDateInput.max = getLocalDateString(); // Prevent selecting future dates
        startDateInput.value = getLocalDateString();
        appendMonthToTable(startDateInput.value);
      };

      initializePage();
    });
  </script>
</body>
</html>