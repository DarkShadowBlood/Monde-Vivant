<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Analyse par LLM - Monde Vivant</title>
  <style>
    :root {
      --bg-dark: #1a1a1a;
      --bg-light: #2c2c2c;
      --text-primary: #f0f0f0;
      --text-secondary: #a0a0a0;
      --accent: #4CAF50;
      --border-color: #444;
      --code-bg: #111;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      padding: 25px;
    }

    .analysis-container {
      max-width: 900px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 25px;
    }

    header h1 {
      font-size: 2.5em;
      margin: 0;
    }

    header p {
      color: var(--text-secondary);
      font-size: 1.1em;
    }

    .control-panel {
      background-color: var(--bg-light);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      margin-bottom: 30px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .control-panel label {
      font-weight: bold;
      color: var(--text-secondary);
    }

    .control-panel select, .control-panel textarea {
      width: 100%;
      padding: 10px;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1em;
    }

    .control-panel select {
      cursor: pointer;
    }

    .control-panel textarea {
      min-height: 300px;
      font-family: 'Courier New', Courier, monospace;
      white-space: pre;
      resize: vertical;
    }

    .button-group {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .button-group button {
      background-color: var(--accent);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      transition: background-color 0.2s;
    }

    .button-group button:hover {
      background-color: #45a049;
    }

    .button-group button.secondary {
      background-color: var(--bg-light);
      border: 1px solid var(--border-color);
    }
    .button-group button.secondary:hover {
      background-color: #383838;
    }

    /* Styles pour la console de statut */
    #status-console-container {
      margin-top: 15px;
    }
    #status-console {
      background-color: var(--code-bg);
      color: var(--text-secondary);
      padding: 15px;
      border-radius: 8px;
      min-height: 120px;
      white-space: pre-wrap; /* Pour respecter les sauts de ligne */
      word-wrap: break-word;
      font-size: 0.9em;
      font-family: 'Courier New', Courier, monospace;
    }
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="analysis-container">
    <header>
      <h1>Analyse de Coach Virtuel</h1>
      <p>G√©n√©rez une instruction (prompt) pour votre LLM afin d'obtenir une analyse de votre s√©ance.</p>
    </header>

    <div class="control-panel">
      <div>
        <label for="activity-selector">1. Activit√© √† analyser :</label>
        <select id="activity-selector">
          <option value="">-- S√©lectionnez une activit√© --</option>
        </select>
      </div>

      <div>
        <label for="personality-selector">2. Personnalit√© du coach :</label>
        <select id="personality-selector"></select>
      </div>
      
      <div>
        <label for="prompt-output">3. Instruction g√©n√©r√©e pour le LLM :</label>
        <textarea id="prompt-output" readonly placeholder="L'instruction pour l'IA appara√Ætra ici..."></textarea>
      </div>

      <div class="button-group">
        <button id="copy-prompt-btn" class="secondary">üìã Copier</button>
        <button id="send-to-mistral-btn">üíâ G√©n√©rer & Injecter</button>
        <button id="inject-all-btn" style="background-color: #8a6d3b;">üíâ G√©n√©rer & Injecter TOUT</button>
      </div>

      <!-- Console de statut -->
      <div id="status-console-container" style="display: none;">
        <label for="status-console">Statut de l'op√©ration :</label>
        <pre id="status-console"></pre>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const activitySelector = document.getElementById('activity-selector');
      const personalitySelector = document.getElementById('personality-selector');
      const promptOutput = document.getElementById('prompt-output');
      const copyBtn = document.getElementById('copy-prompt-btn');
      const sendToMistralBtn = document.getElementById('send-to-mistral-btn');
      const injectAllBtn = document.getElementById('inject-all-btn');
      const statusConsoleContainer = document.getElementById('status-console-container');
      const statusConsole = document.getElementById('status-console');

      let analysisData = []; // Pour les activit√©s
      let coachPersonalities = {}; // Pour les personnalit√©s charg√©es dynamiquement

      // Charger les donn√©es
      Promise.all([
        fetch('analysis_data.json').then(res => res.json()),
        fetch('historique_objectifs/coach_engine.json').then(res => res.json())
      ]).then(([data, coachEngineData]) => {
          coachPersonalities = coachEngineData.personalities;
          analysisData = data;
          populateSelector();
          populatePersonalitySelector();
          generatePrompt(); // G√©n√©rer un prompt initial si une activit√© est d√©j√† s√©lectionn√©e
        })
        .catch(error => {
            console.error("Erreur de chargement des donn√©es initiales:", error);
            promptOutput.value = `Erreur: Impossible de charger les fichiers de configuration (analysis_data.json ou coach_engine.json). D√©tails: ${error.message}`;
        });

      // Remplir le s√©lecteur d'activit√©s
      function populateSelector() {
        analysisData.forEach((activity, index) => {
          const option = document.createElement('option');
          option.value = index;
          const date = new Date(activity.date).toLocaleDateString('fr-FR');
          option.textContent = `${date} - ${activity.type} (${activity.duration})`;
          activitySelector.appendChild(option);
        });
      }

      // Remplir le s√©lecteur de personnalit√©s
      function populatePersonalitySelector() {
        for (const key in coachPersonalities) {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = coachPersonalities[key].name;
          personalitySelector.appendChild(option);
        }
      }

      // G√©n√©rer le prompt
      async function generatePrompt() {
        const selectedIndex = activitySelector.value;
        if (selectedIndex === "") {
          promptOutput.value = "";
          return;
        }

        const activity = analysisData[selectedIndex];
        const selectedPersonalityKey = personalitySelector.value || 'analysis_default';
        const selectedPersonality = coachPersonalities[selectedPersonalityKey];

        if (!selectedPersonality) {
            promptOutput.value = `Erreur: Personnalit√© '${selectedPersonalityKey}' non trouv√©e dans coach_engine.json.`;
            return;
        }
        const personalityDescription = selectedPersonality.description || `Vous √™tes ${selectedPersonality.name}.`;

        // --- AM√âLIORATION : Chercher un fichier .md associ√© ---
        let qualitative_context = "Aucun contexte qualitatif fourni.";
        const md_path = activity.html_file.replace('_workout_log.html', '_analyse_format.md');
        
        try {
          const response = await fetch(md_path);
          if (response.ok) {
            qualitative_context = await response.text();
            console.log("Fichier .md de contexte trouv√© et charg√© !");
          } else {
            console.log("Aucun fichier .md de contexte trouv√©, utilisation des donn√©es JSON uniquement.");
          }
        } catch (error) {
          console.warn("Erreur lors de la tentative de chargement du fichier .md :", error);
        }
        // --- FIN DE L'AM√âLIORATION ---
        
        const prompt = `
${personalityDescription}
Analysez la s√©ance d'entra√Ænement suivante et fournissez une analyse structur√©e en adoptant la personnalit√© d√©finie ci-dessus.

--- DONN√âES DE LA S√âANCE ---
${JSON.stringify(activity, null, 2)}

--- CONTEXTE QUALITATIF FOURNI PAR L'ATHL√àTE (Notes, sensations, etc.) ---
${qualitative_context}

--- CONSIGNES POUR L'ANALYSE ---
Fournissez votre analyse en suivant IMP√âRATIVEMENT la structure ci-dessous :

**NOTE IMPORTANTE :** La distance indiqu√©e dans \`daily_goal\` (objectif quotidien) provient principalement de la marche et ne doit PAS √™tre directement compar√©e √† la distance de l'activit√© si celle-ci est du v√©lo ou un autre sport non bas√© sur les pas. Utilisez-la plut√¥t comme un indicateur de l'activit√© g√©n√©rale de la journ√©e.

### üèÜ R√©sum√© de la S√©ance
*Un paragraphe court et motivant qui r√©sume la performance.*

### ‚ú® Points Forts
*Une liste √† puces des 2 ou 3 aspects les plus positifs de la s√©ance. Soyez sp√©cifique (ex: "Excellente fr√©quence cardiaque moyenne de ${activity.avg_hr || 'N/A'} bpm, ce qui montre une bonne endurance fondamentale.").*

### üéØ Pistes d'Am√©lioration
*Une liste √† puces de 1 ou 2 points o√π l'athl√®te peut progresser. Abordez cela comme un d√©fi positif (ex: "Pour la prochaine fois, un petit d√©fi serait de viser une distance l√©g√®rement sup√©rieure pour continuer √† b√¢tir sur cette base solide.").*

### üöÄ Recommandations du Coach
*Un paragraphe avec des conseils concrets et actionnables pour la prochaine s√©ance du m√™me type. Si des donn√©es d'objectifs quotidiens sont pr√©sentes, mettez-les en perspective avec la performance.*

Terminez votre analyse par une phrase d'encouragement.
`;
        promptOutput.value = prompt.trim();
      }

      // Copier le prompt dans le presse-papiers
      function copyPrompt() {
        if (promptOutput.value === "") return;
        navigator.clipboard.writeText(promptOutput.value).then(() => {
          const originalText = copyBtn.textContent;
          copyBtn.textContent = '‚úÖ Copi√© !';
          setTimeout(() => {
            copyBtn.textContent = originalText;
          }, 2000);
        }).catch(err => {
          console.error('Erreur de copie:', err);
          alert('Impossible de copier le texte.');
        });
      }

      // Fonction pour logger dans la console de la page
      function logToConsole(message, isError = false) {
        statusConsoleContainer.style.display = 'block';
        const timestamp = new Date().toLocaleTimeString();
        const prefix = isError ? '‚ùå ERREUR:' : '‚úÖ';
        statusConsole.textContent += `[${timestamp}] ${prefix} ${message}\n`;
        // Scroll vers le bas
        statusConsole.scrollTop = statusConsole.scrollHeight;
      }

      // G√©rer l'√©tat du bouton (chargement)
      function setButtonLoading(button, isLoading, originalText) {
        if (isLoading) {
          button.disabled = true;
          button.innerHTML = 'En cours... <span class="spinner"></span>';
        } else {
          button.disabled = false;
          button.innerHTML = originalText;
        }
      }

      // Envoyer le prompt √† Mistral
      async function sendToMistral() {
        const selectedIndex = activitySelector.value;        
        if (selectedIndex === "") {
          logToConsole('Veuillez choisir une activit√© √† analyser.', true);
          return;
        }
        const promptContent = promptOutput.value;
        if (promptContent === "") {
          logToConsole("Veuillez g√©n√©rer un prompt avant de l'envoyer √† Mistral.", true);
          return;
        }

        const apiKey = 'czBBdZtL4WA8DF5FmkD3SUVDZrPBNM0u'; // REMOVE IN PRODUCTION

        try {
          statusConsole.textContent = ''; // Vider la console
          setButtonLoading(true);
          logToConsole("Envoi de la requ√™te √† l'API Mistral...");

          const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'mistral-large-latest',
              messages: [{ role: 'user', content: promptContent }]
            })
          });

          const data = await response.json();
          if (response.ok) {
            logToConsole("R√©ponse re√ßue de Mistral.");
            const mistralResponse = data.choices[0].message.content;
            const activity = analysisData[selectedIndex];

            // --- Correction pour le chemin et le nom de fichier ---
            // 1. Extraire le chemin du dossier et le nom de base du fichier source
            const sourcePath = activity.html_file.replace('../information/', ''); // Enl√®ve le pr√©fixe pour obtenir le chemin relatif
            const sourceJsonFile = sourcePath.replace('_workout_log.html', '_workout_log.json');
            const sourceFilenameBase = sourceJsonFile.split('/').pop().replace('_workout_log.json', '');

            const personalityKey = personalitySelector.value;

            // 2. Construire le nouveau chemin et nom de fichier pour l'analyse
            const newFilename = `${sourceFilenameBase}_${personalityKey}.md`;
            const relativePath = sourceJsonFile.replace(sourceJsonFile.split('/').pop(), newFilename);

            // 3. Pr√©parer le contenu JSON √† sauvegarder
            const jsonContent = mistralResponse;

            logToConsole("Sauvegarde de la r√©ponse sur le serveur...");
            const saveResponse = await fetch('/api/saveFile', { // Using a more specific endpoint
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ path: relativePath, content: jsonContent })
            });

            const saveData = await saveResponse.json();
            if (saveData.success) {
              logToConsole(`Fichier JSON sauvegard√© avec succ√®s !\nChemin : ${saveData.path}`);
            } else {
              logToConsole('Erreur lors de la sauvegarde : ' + saveData.error, true);
            }

            // 4. Injecter dans le HTML
            logToConsole(`Injection de l'analyse de ${personalities[personalityKey].name}...`);
            const injectResponse = await fetch('/api/injectAnalysis', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                html_path: activity.html_file.replace('../information/', ''),
                analysis_content: mistralResponse,
                analysis_key: personalityKey
              })
            });
            const injectData = await injectResponse.json();
            if (!injectResponse.ok || !injectData.success) {
              throw new Error(injectData.error || 'Erreur d\'injection');
            }
            
            logToConsole(`Injection r√©ussie !`);
            window.open(injectData.url, '_blank'); // Ouvre le fichier final dans un nouvel onglet

          } else {
            const errorMessage = data.message || response.statusText;
            logToConsole("Erreur de l'API Mistral: " + errorMessage, true);
            console.error("Erreur de l'API Mistral:", data);
          }
        } catch (error) {
          console.error("Erreur lors de la communication avec l'API Mistral:", error);
          logToConsole("Erreur de communication avec l'API Mistral. V√©rifiez la console du navigateur (F12) pour plus de d√©tails.", true);
        } finally {
          setButtonLoading(false);
        }
      }

      // --- NOUVELLE FONCTION : G√©n√©rer et injecter toutes les analyses ---
      async function generateAndInjectAll() {
        const selectedIndex = activitySelector.value;
        if (selectedIndex === "") {
          logToConsole('Veuillez choisir une activit√© √† analyser.', true);
          return;
        }

        const activity = analysisData[selectedIndex];
        const apiKey = 'czBBdZtL4WA8DF5FmkD3SUVDZrPBNM0u'; // REMOVE IN PRODUCTION
        
        statusConsole.textContent = ''; // Vider la console
        setButtonLoading(injectAllBtn, true);
        let finalUrl = '';
        let allAnalyses = []; // Stocker toutes les analyses g√©n√©r√©es

        // Boucle sur chaque personnalit√©
        for (const key in personalities) {
          const personality = personalities[key];
          logToConsole(`--- Pr√©paration pour ${personality.name} ---`);

          // 1. Construire le prompt sp√©cifique
          const prompt = `
${personality.description}
Analysez la s√©ance d'entra√Ænement suivante et fournissez une analyse structur√©e en adoptant la personnalit√© d√©finie ci-dessus.
--- DONN√âES DE LA S√âANCE ---
${JSON.stringify(activity, null, 2)}
--- CONSIGNES POUR L'ANALYSE ---
Fournissez votre analyse en suivant IMP√âRATIVEMENT la structure ci-dessous :
**NOTE IMPORTANTE :** La distance indiqu√©e dans \`daily_goal\` (objectif quotidien) provient principalement de la marche et ne doit PAS √™tre directement compar√©e √† la distance de l'activit√© si celle-ci est du v√©lo ou un autre sport non bas√© sur les pas. Utilisez-la plut√¥t comme un indicateur de l'activit√© g√©n√©rale de la journ√©e.
### üèÜ R√©sum√© de la S√©ance
*Un paragraphe court et motivant qui r√©sume la performance.*
### ‚ú® Points Forts
*Une liste √† puces des 2 ou 3 aspects les plus positifs de la s√©ance.*
### üéØ Pistes d'Am√©lioration
*Une liste √† puces de 1 ou 2 points o√π l'athl√®te peut progresser.*
### üöÄ Recommandations du Coach
*Un paragraphe avec des conseils concrets et actionnables.*
Terminez votre analyse par une phrase d'encouragement.`;

          try {
            // 2. Appeler Mistral
            logToConsole(`Envoi de la requ√™te √† Mistral pour ${personality.name}...`);
            const mistralResponse = await fetch('https://api.mistral.ai/v1/chat/completions', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
              body: JSON.stringify({ model: 'mistral-large-latest', messages: [{ role: 'user', content: prompt }] })
            });
            const mistralData = await mistralResponse.json();
            if (!mistralResponse.ok) throw new Error(mistralData.message || 'Erreur API Mistral');
            const analysisContent = mistralData.choices[0].message.content;
            logToConsole(`R√©ponse re√ßue pour ${personality.name}.`);

            // Sauvegarder l'analyse en .json dans un sous-dossier 'analysis'
            const sourcePath = activity.html_file.replace('../information/', '');
            const sourceJsonFile = sourcePath.replace('_workout_log.html', '_workout_log.json');
            const sourceFilenameBase = sourceJsonFile.split('/').pop().replace('_workout_log.json', '');
            const newFilename = `${sourceFilenameBase}_${key}.json`;
            // Ins√©rer 'analysis' dans le chemin
            const pathParts = sourceJsonFile.split('/');
            pathParts.splice(pathParts.length - 1, 0, 'analysis');
            const relativePath = pathParts.join('/').replace(pathParts[pathParts.length - 1], newFilename);

            const saveResponse = await fetch('/api/saveFile', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ path: relativePath, content: { analysis_markdown: analysisContent } })
            });
            const saveData = await saveResponse.json();
            if(saveData.success) {
              logToConsole(`Fichier .md sauvegard√© pour ${personality.name}.`);
            }

            // Ajouter l'analyse au tableau pour l'injection group√©e
            allAnalyses.push({ key: key, content: analysisContent });

          } catch (error) {
            logToConsole(`Erreur pour ${personality.name}: ${error.message}`, true);
            setButtonLoading(injectAllBtn, false, 'üíâ G√©n√©rer & Injecter TOUT');
            return; // Arr√™ter le processus en cas d'erreur
          }

          // Pause de 21 secondes entre chaque appel pour respecter les limites de l'API (max 3/min)
          if (key !== Object.keys(personalities).pop()) {
            logToConsole("Pause de 21 secondes avant le prochain appel...");
            await new Promise(resolve => setTimeout(resolve, 21000));
          }
        }

        // --- Post-traitement des analyses (JSON -> MD/HTML) ---
        try {
            logToConsole("Lancement du post-traitement des fichiers d'analyse...");
            const activityDir = activity.html_file.replace('../information/', '').split('/').slice(0, -1).join('/');
            const processResponse = await fetch('/api/processAnalyses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ activity_dir: activityDir })
            });
            const processData = await processResponse.json();
            if (!processResponse.ok || !processData.success) {
                throw new Error(processData.error || 'Erreur de post-traitement');
            }
            logToConsole(`Post-traitement r√©ussi: ${processData.message}`);
        } catch (error) {
            logToConsole(`Erreur lors du post-traitement: ${error.message}`, true);
        }

        // --- Injection group√©e apr√®s la boucle ---
        if (allAnalyses.length > 0) {
          try {
            logToConsole("Injection de toutes les analyses dans le fichier HTML...");
            const injectResponse = await fetch('/api/injectAnalysis', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                html_path: activity.html_file.replace('../information/', ''),
                analyses: allAnalyses
              })
            });
            const injectData = await injectResponse.json();
            if (!injectResponse.ok || !injectData.success) throw new Error(injectData.error || 'Erreur d\'injection group√©e');
            logToConsole("Injection group√©e r√©ussie !");
            finalUrl = injectData.url;
          } catch (error) {
            logToConsole(`Erreur lors de l'injection group√©e: ${error.message}`, true);
          }
        }

        logToConsole("Toutes les analyses ont √©t√© g√©n√©r√©es et inject√©es !");
        setButtonLoading(injectAllBtn, false, 'üíâ G√©n√©rer & Injecter TOUT');
        if (finalUrl) {
          window.open(finalUrl, '_blank'); // Ouvre le fichier final dans un nouvel onglet
        }
      }

      // √âcouteurs d'√©v√©nements
      activitySelector.addEventListener('change', generatePrompt);
      personalitySelector.addEventListener('change', generatePrompt);
      copyBtn.addEventListener('click', copyPrompt);
      sendToMistralBtn.addEventListener('click', sendToMistral);
      injectAllBtn.addEventListener('click', generateAndInjectAll);
    });
  </script>
</body>
</html>